---
title: "Minikubeã§æ§‹ç¯‰ã™ã‚‹ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã§Kubernetesã‚’å­¦ã¶"
emoji: "âš“ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Kubernetes", "Minikube", "Go", "ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹", "grpc"]
published: true
---

[Kubernetes å®Œå…¨ã‚¬ã‚¤ãƒ‰](https://www.amazon.co.jp/Kubernetes%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-%E7%AC%AC2%E7%89%88-Top-Gear-%E9%9D%92%E5%B1%B1/dp/4295009792)ã¨[ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³[å®Ÿè·µçš„ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰è§£èª¬]](https://www.amazon.co.jp/%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-%E5%AE%9F%E8%B7%B5%E7%9A%84%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%89%E8%A7%A3%E8%AA%AC-impress-top-gear/dp/4295008583)ã‚’èª­ã¿çµ‚ãˆã€ã ã„ã¶ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ãã¾ã—ãŸï¼

ãŸã ã€ã¾ã å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã§ã®é‹ç”¨ãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã—ãã‚Œãªã‹ã£ãŸã®ã§æœ€å°æ§‹æˆã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«æ§‹ç¯‰ã—ã¦ã¿ãŸã®ã§ãã®å‚™å¿˜éŒ²ã§ã™ã€‚

ä»Šå›ã®æˆæœç‰©ã¯ã“ã¡ã‚‰

https://github.com/JY8752/microservice-demo

:::message
ä»Šå›ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã‚ãã¾ã§å­¦ç¿’ç”¨é€”ã®ãŸã‚å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«æ¡ç”¨ã™ã‚‹ã«ã¯ã„ã‚ã„ã‚è¶³ã‚Šã¦ãªã„ã§ã™ã€‚ãã®ãŸã‚ã€ãã®ã¾ã¾ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã®ã§ã‚ãã¾ã§å‚è€ƒç¨‹åº¦ã«ã”å‚ç…§ãã ã•ã„ã€‚
:::

## æƒ³å®šèª­è€…

- Kubernetesåˆå­¦è€…ã§æ¬¡ã«å®Ÿè·µçš„ãªä½¿ã„æ–¹ã‚’å­¦ã³ãŸã„æ–¹
- Goã‚’ä½¿ã£ãŸãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹ç¯‰ã«èˆˆå‘³ãŒã‚ã‚‹æ–¹

## ä½¿ç”¨ç’°å¢ƒ

- Minikube v1.30.1
- kubectl(client) v1.25.9
- kubectl(server) v1.26.3
- Helm v3.12.0
- Go 1.20.4
- protoc 3.11.4
- helm-secrets 4.4.2
- sops 3.7.3
- age v1.1.1

## ä»Šå›æ§‹ç¯‰ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ä»Šå›ä½œæˆã™ã‚‹ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ä»¥ä¸‹ã®æ§‹æˆã§ã™ã€‚ã„ã‚ã„ã‚çœã„ã¦ã¾ã™ãŒã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚²ãƒ¼ãƒ ã®ã‚¬ãƒãƒ£ã‚’å¼•ãæ“ä½œã‚’æƒ³å®šã—ã¦ã¾ã™ã€‚

- gacha-service ã‚¬ãƒãƒ£ã‚’å¼•ãã¾ã™ã€‚ã‚¢ã‚¤ãƒ†ãƒ ã®æŠ½é¸ã¨ã‚¬ãƒãƒ£ã‚’å¼•ã„ãŸå±¥æ­´ã‚’DBã«ä¿å­˜ã—ã¾ã™ã€‚
- item-service ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç®¡ç†ã—ã¾ã™ã€‚ä»Šå›ã¯æŠ½é¸ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
- api-gateway å¤–éƒ¨ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã“ã“ã§å—ã‘ä»˜ã‘ã¾ã™ã€‚

ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã¯gRPCã§è¡Œã„ã€å¤–éƒ¨ã¨ã®é€šä¿¡ã¯HTTPé€šä¿¡ã§è¡Œã„ã¾ã™ã€‚

Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¯ä»Šå›ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã«æ§‹ç¯‰ã™ã‚‹ãŸã‚Minikubeã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®ãƒªã‚½ãƒ¼ã‚¹ã¯Helmã‚’ä½¿ç”¨ã—ã¦ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/2b67c5c74b2d-20230629.png)

é€šå¸¸ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’é‹ç”¨ã™ã‚‹ãªã‚‰ã°ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ãªã‚‹ã¨æ€ã„ã¾ã™ãŒä»Šå›ã¯ï¼‘ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¾ã¨ã‚ã¦é…ç½®ã—ã¦ã„ã¾ã™ã€‚

```
.
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ api-gateway
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ gacha.go
â”‚Â Â  â”œâ”€â”€ go.mod
â”‚Â Â  â”œâ”€â”€ go.sum
â”‚Â Â  â”œâ”€â”€ item.go
â”‚Â Â  â”œâ”€â”€ main.go
â”‚Â Â  â””â”€â”€ pkg
â”œâ”€â”€ gacha-service
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ go.mod
â”‚Â Â  â”œâ”€â”€ go.sum
â”‚Â Â  â”œâ”€â”€ item.go
â”‚Â Â  â”œâ”€â”€ main.go
â”‚Â Â  â”œâ”€â”€ pkg
â”‚Â Â  â””â”€â”€ service.go
â”œâ”€â”€ go.work
â”œâ”€â”€ go.work.sum
â”œâ”€â”€ item-service
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ go.mod
â”‚Â Â  â”œâ”€â”€ go.sum
â”‚Â Â  â”œâ”€â”€ main.go
â”‚Â Â  â”œâ”€â”€ pkg
â”‚Â Â  â””â”€â”€ service.go
â”œâ”€â”€ k8s
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ api-gateway
â”‚Â Â  â”œâ”€â”€ debug.yaml
â”‚Â Â  â”œâ”€â”€ gacha
â”‚Â Â  â””â”€â”€ item
â””â”€â”€ proto
    â”œâ”€â”€ gacha.proto
    â”œâ”€â”€ item.proto
    â””â”€â”€ rarity.proto
```

## ã‚¬ãƒãƒ£ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…

Goã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```
go mod init gacha-service
```

ã¾ãŸã€ä»Šå›ã¯ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã«gRPCã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ä»¥ä¸‹ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
go get -u google.golang.org/grpc
go get -u google.golang.org/grpc/cmd/protoc-gen-go-grpc
```

### protoãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ã‚¬ãƒãƒ£ã‚’å¼•ãå‡¦ç†ã¨ã‚¬ãƒãƒ£å±¥æ­´ã‚’å–å¾—ã™ã‚‹rpcã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```protobuf:gacha.proto
syntax = "proto3";

option go_package = "pkg/grpc";

package gacha;

import "proto/rarity.proto";
import "google/protobuf/timestamp.proto";

service GachaService {
  rpc Draw(DrawRequest) returns (DrawResponse) {}
  rpc GetHistories(GetHistoriesRequest) returns (GetHistoriesResponse) {}
}

message DrawRequest {
  int64 user_id = 1;
}

message DrawResponse {
  int64  item_id   = 1;
  string item_name = 2;
  rarity.Rarity rarity    = 3;
}

message GetHistoriesRequest {
  int64 user_id = 1;
}

message History {
  int64  item_id   = 1;
  string item_name = 2;
  rarity.Rarity rarity    = 3;
  google.protobuf.Timestamp created_at = 4;
}

message GetHistoriesResponse {
  repeated History histories = 1;
}
```

```protobuf:rarity.proto
syntax = "proto3";

option go_package = "pkg/grpc";

package rarity;

enum Rarity {
  RARITY_UNKNOWN = 0;
  RARITY_N       = 1;
  RARITY_R       = 2;
  RARITY_SR      = 3;
  RARITY_SSR     = 4;
}
```

ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã§ããŸã‚‰protoc-gen-goã‚’ä½¿ç”¨ã—ã¦ã€Goã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

```make:Makefile
.PHONY: proto
proto:
	protoc --proto_path=../ \
		--go_out=./pkg/grpc --go_opt=paths=source_relative \
		--go-grpc_out=./pkg/grpc --go-grpc_opt=paths=source_relative \
		../proto/*.proto
```

```
mkdir -p pkg/grpc
make proto
```

### mainå‡¦ç†

ã¨ã‚Šã‚ãˆãšå‡¦ç†ã®æµã‚Œã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚

```go:main.go
func main() {
	log.Println("Start Gacha Service")

	dsn, err := getDatasourceName()
	if err != nil {
		log.Fatal(err)
	}

	db, err := connectDb(dsn)
	if err != nil {
		log.Fatal(err)
	}
	defer db.Close()

	createTable(db)

	// grpc server ã®èµ·å‹•
	listener, err := net.Listen("tcp", ":8080")
	if err != nil {
		log.Fatalf("failed to listen: %v", err)
	}

	server := grpc.NewServer()

	reflection.Register(server)

	// ã‚¬ãƒãƒ£ã®ç™»éŒ²
	items := []Item{
		{Id: 1, Name: "item1", Rarity: gachapb.Rarity_RARITY_N, Weight: 40},
		{Id: 2, Name: "item2", Rarity: gachapb.Rarity_RARITY_R, Weight: 30},
		{Id: 3, Name: "item3", Rarity: gachapb.Rarity_RARITY_SR, Weight: 20},
		{Id: 4, Name: "item4", Rarity: gachapb.Rarity_RARITY_SSR, Weight: 10},
	}
	gachapb.RegisterGachaServiceServer(server, NewGachaServiceServer(db, items))

	go func() {
		if err := server.Serve(listener); err != nil {
			log.Fatalf("failed to serve: %v", err)
		}
	}()

	defer Close()

	// Graceful Shutdown
	quit := make(chan os.Signal, 1)
	signal.Notify(quit, syscall.SIGTERM, os.Interrupt)
	<-quit
	log.Println("Shutdown Server ...")
	server.GracefulStop()
}
```

DBã«ã¯ä»Šå›MySQLã‚’ä½¿ç”¨ã—ã€æ¥ç¶šã€ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãªã©ã®ã‚¯ã‚¨ãƒªæ“ä½œã«ã¯```database/sql```ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€gRPCã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦èµ·å‹•ã™ã‚‹ã®ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®ç™»éŒ²ã¨èµ·å‹•å‡¦ç†ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚å¾Œè¿°ã—ã¾ã™ãŒä»®æƒ³ã‚¬ãƒãƒ£ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯ãƒ™ã‚¿æ›¸ãã§serviceå‡¦ç†ã«æ¸¡ã—ã¦ã„ã¾ã™ã€‚

### serviceå‡¦ç†

protoãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’ã‚‚ã¨ã«è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```go
type GachaServiceServer interface {
	Draw(context.Context, *DrawRequest) (*DrawResponse, error)
	GetHistories(context.Context, *GetHistoriesRequest) (*GetHistoriesResponse, error)
	mustEmbedUnimplementedGachaServiceServer()
}
```

mainé–¢æ•°ã§ã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¦ã„ã‚‹ã®ã§ã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’æº€ãŸã™å®Ÿè£…ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

```go:service.go
type gachaServiceServer struct {
	gachapb.UnimplementedGachaServiceServer
	db    *sql.DB
	items []Item
}

func NewGachaServiceServer(db *sql.DB, items []Item) gachapb.GachaServiceServer {
	return &gachaServiceServer{
		db:    db,
		items: items,
	}
}

func (g *gachaServiceServer) Draw(ctx context.Context, req *gachapb.DrawRequest) (*gachapb.DrawResponse, error) {
	// itemsã‹ã‚‰itemã‚’é‡ã¿ä»˜æŠ½é¸ã™ã‚‹
	weights := make([]int, len(g.items))
	for i, item := range g.items {
		weights[i] = item.Weight
	}

	seed := time.Now().UnixNano()
	i := linearSearchLottery(weights, seed)
	item := g.items[i]

	// DBã«ä¿å­˜ã™ã‚‹
	if err := save(ctx, g.db, req.UserId, item); err != nil {
		return nil, err
	}

	// itemæ‰€æŒæƒ…å ±ã‚‚æ›´æ–°ã™ã‚‹
	res, err := GetItem(ctx, req.UserId, item.Id, item.Name, item.Rarity)
	if err != nil {
		return nil, err
	}

	fmt.Printf("get_item_response: %+v\n", res)

	return &gachapb.DrawResponse{
		ItemId:   item.Id,
		ItemName: item.Name,
		Rarity:   item.Rarity,
	}, nil
}
```

å‡¦ç†ã®æµã‚Œã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§ã™ã€‚

- é‡ã¿ä»˜æŠ½é¸ã«ã‚ˆã‚Šã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸€ã¤æŠ½é¸ã™ã‚‹ã€‚
- ã‚¬ãƒãƒ£ã®å±¥æ­´ã‚’DBã«ä¿å­˜ã™ã‚‹ã€‚
- æŠ½é¸ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å¾Œè¿°ã™ã‚‹item-serviceã®```GetItem()```ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§è¨˜éŒ²ã™ã‚‹ã€‚

æŠ½é¸ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨DBæ“ä½œã«é–¢ã—ã¦ã®å®Ÿè£…ã¯çœç•¥ã„ãŸã—ã¾ã™ãŒã€ã‚‚ã—å…¨ã¦ã®å®Ÿè£…ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://github.com/JY8752/microservice-demo/tree/main/gacha-service

## ã‚¢ã‚¤ãƒ†ãƒ ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…

ã‚¢ã‚¤ãƒ†ãƒ ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹æˆã¯ã»ã¨ã‚“ã©ã‚¬ãƒãƒ£ã‚µãƒ¼ãƒ“ã‚¹ã®æ–¹ã¨åŒæ§˜ã§ã™ã€‚

```
go mod init item-service
```

### protoãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚

```protobuf:item.proto
package item;

import "proto/rarity.proto";

service ItemService {
    rpc GetItem(GetItemRequest) returns (GetItemResponse) {}
    rpc GetInventory(GetInventoryRequest) returns (GetInventoryResponse) {}
}

message GetItemRequest {
    int64 user_id  = 1;
    int64 item_id  = 2;
    string item_name = 3;
    rarity.Rarity rarity = 4;
}

message GetItemResponse {
    int64 item_id  = 1;
    string item_name = 2;
    rarity.Rarity rarity = 3;
    int32 count = 4;
}

message GetInventoryRequest {
    int64 user_id  = 1;
}

message InventoryItem {
    int64 item_id  = 1;
    string item_name = 2;
    rarity.Rarity rarity = 3;
    int32 count = 4;
}

message GetInventoryResponse {
    repeated InventoryItem items = 1;
}
```

ä½œæˆã§ããŸã‚‰ã‚¬ãƒãƒ£ã®æ™‚ã¨åŒæ§˜Goã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

```
mkdir -p pkg/grpc
make proto
```

### serviceå‡¦ç†

mainé–¢æ•°ã¯ã‚¬ãƒãƒ£ã¨ã»ã¨ã‚“ã©å¤‰ã‚ã‚‰ãªã„ãŸã‚çœç•¥ã—ã¾ã™ã€‚ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’æº€ãŸã™ã‚ˆã†å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```go
type ItemServiceServer interface {
	GetItem(context.Context, *GetItemRequest) (*GetItemResponse, error)
	GetInventory(context.Context, *GetInventoryRequest) (*GetInventoryResponse, error)
	mustEmbedUnimplementedItemServiceServer()
}
```

```go:service.go
type itemServiceServer struct {
	itempb.UnimplementedItemServiceServer
	db *sql.DB
}

type Inventory struct {
	Id        int64
	UserId    int64
	ItemId    int64
	ItemName  string
	Rarity    string
	Count     int
	CreatedAt time.Time
}

func NewItemServiceServer(db *sql.DB) itempb.ItemServiceServer {
	return &itemServiceServer{
		db: db,
	}
}

func (s *itemServiceServer) GetItem(ctx context.Context, req *itempb.GetItemRequest) (*itempb.GetItemResponse, error) {
	// ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ‰€æŒã—ã¦ã„ã‚‹ã‹ç¢ºèª
	inventry, err := get(req.UserId, req.ItemId, s.db)
	if err = handleError(err); err != nil {
		return nil, err
	}

	// DBæ›´æ–°
	if inventry.Id == 0 {
		// æœªæ‰€æŒ
		if _, err = insert(req.UserId, req.ItemId, req.ItemName, req.Rarity.String(), s.db); err != nil {
			return nil, err
		}
	} else {
		// æ‰€æŒæ¸ˆã¿
		if err = update(req.UserId, req.ItemId, s.db); err != nil {
			return nil, err
		}
	}

	return &itempb.GetItemResponse{
		ItemId:   req.ItemId,
		ItemName: req.ItemName,
		Rarity:   req.Rarity,
		Count:    int32(inventry.Count) + 1,
	}, nil
}

func (i *itemServiceServer) GetInventory(ctx context.Context, req *itempb.GetInventoryRequest) (*itempb.GetInventoryResponse, error) {
	rows, err := getInventries(req.UserId, i.db)
	if err != nil {
		log.Printf("failed to get inventries: %v\n", err)
		return nil, err
	}

	inventories := make([]*itempb.InventoryItem, len(rows))
	for i, inventry := range rows {
		inventories[i] = &itempb.InventoryItem{
			ItemId:   inventry.ItemId,
			ItemName: inventry.ItemName,
			Rarity:   itempb.Rarity(itempb.Rarity_value[inventry.Rarity]),
			Count:    int32(inventry.Count),
		}
	}

	return &itempb.GetInventoryResponse{
		Items: inventories,
	}, nil
}
```

å‡¦ç†ã®æµã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™

```GetItem()```
- æŒ‡å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ æ‰€æŒæƒ…å ±ã‚’å–å¾—ã™ã‚‹ã€‚
- ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°æ–°è¦ã§å–å¾—ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ãªã®ã§ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã™ã‚‹ã€‚
- æ—¢ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¦ã„ã‚Œã°æ‰€æŒæ¸ˆã®ã‚¢ã‚¤ãƒ†ãƒ ãªã®ã§æ‰€æŒæ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹ã€‚

```GetInventory()```
- æŒ‡å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ æ‰€æŒæƒ…å ±ã‚’å–å¾—ã—ã¦è¿”ã™ã€‚

ã“ã“ã§å®Ÿè£…ã—ãŸ```GetItem```é–¢æ•°ã‚’gacha-serviceã®æ–¹ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

## API-Gatewayã®å®Ÿè£…

API-Gatewayã®å®Ÿè£…ã§ã¯gRPCé€šä¿¡ã®ä»–ã«å¤–éƒ¨ã¨ã®HTTPé€šä¿¡ãŒå¿…è¦ãªãŸã‚ä»Šå›ã¯```echo```ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
go mode init api-gateway
```

gRPCã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã®å®Ÿè£…ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ä»Šã¾ã§åŒæ§˜Goã®ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãŠãã¾ã™ã€‚

```
mkdir -p pkg/grpc
make proto
```

ã¾ãŸã€ä»Šå›ã¯```echo```ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚‚ã—ã¦ãŠãã¾ã™ã€‚

```
go get github.com/labstack/echo/v4
```

### mainå‡¦ç†

echoã®ãƒ«ãƒ¼ãƒ†ã‚¤ãƒ³ã‚°è¨­å®šã‚’ã—ã¦ã€HTTPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```go:main.go
package main

import (
	"fmt"

	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

func main() {
	fmt.Println("API Gateway Start!!")
	// Echo instance
	e := echo.New()

	// Middleware
	e.Use(middleware.Logger())
	e.Use(middleware.Recover())

	// Routes
	e.POST("/draw", Draw)
	e.GET("/histories/:user_id", GetHistories)
	e.GET("/inventories/:user_id", GetInventories)
	e.GET("/test", func(c echo.Context) error {
		return c.String(200, "test")
	})

	defer func() {
		if itemConn != nil {
			itemConn.Close()
		}
		if gachaConn != nil {
			gachaConn.Close()
		}
	}()

	// Start server
	e.Logger.Fatal(e.Start(":8080"))
}
```

### gRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…

HTTPé€šä¿¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ãŸã‚‰ã€gRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚gRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ãŠã‚Šä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã¨ã—ã¾ã—ãŸã€‚

```go:gacha.go
package main

import (
	gachapb "api-gateway/pkg/grpc/proto"
	"context"
	"fmt"
	"log"
	"net/http"
	"os"
	"strconv"

	"github.com/labstack/echo/v4"
	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials/insecure"
)

var (
	gachaClient gachapb.GachaServiceClient
	gachaConn   *grpc.ClientConn
)

func init() {
	if gachaClient != nil {
		return
	}

	host := os.Getenv("GACHA_SERVICE_HOST")
	if host == "" {
		log.Fatal("GACHA_SERVICE_HOST is not set")
	}

	var err error
	gachaConn, err = grpc.Dial(
		fmt.Sprintf("%s:%s", host, "8080"),
		grpc.WithTransportCredentials(insecure.NewCredentials()),
		grpc.WithBlock(),
	)
	if err != nil {
		panic(err)
	}

	gachaClient = gachapb.NewGachaServiceClient(gachaConn)
}

type DrawRequest struct {
	UserId int64 `json:"user_id"`
}

// /draw
func Draw(c echo.Context) error {
	dr := new(DrawRequest)
	if err := c.Bind(dr); err != nil {
		return err
	}

	req := &gachapb.DrawRequest{
		UserId: dr.UserId,
	}
	res, err := gachaClient.Draw(context.Background(), req)
	if err != nil {
		return err
	}
	return c.JSON(http.StatusOK, res)
}

func GetHistories(c echo.Context) error {
	p := c.Param("user_id")
	userId, err := strconv.ParseInt(p, 10, 64)
	if err != nil {
		return err
	}

	req := &gachapb.GetHistoriesRequest{
		UserId: userId,
	}
	res, err := gachaClient.GetHistories(context.Background(), req)
	if err != nil {
		return err
	}
	return c.JSON(http.StatusOK, res)
}

func CloseGachaConnection() error {
	if gachaConn != nil {
		return gachaConn.Close()
	}
	return nil
}
```

ä»Šå›ä½¿ç”¨ã—ã¦ã„ã‚‹gRPCã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ã™ã‚‹ãŸã‚ã®ãƒ›ã‚¹ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚„DBæƒ…å ±ãªã©ã¯ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ãŒã€ã“ã‚Œã¯å¾Œè¿°ã®Kubernetesã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã§ã‚³ãƒ³ãƒ†ãƒŠã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

item-serviceã®å®Ÿè£…ã¾ã§ç¢ºèªã—ãŸã„æ–¹ã¯ä»¥ä¸‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://github.com/JY8752/microservice-demo/tree/main/api-gateway

ã“ã‚Œã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å®Ÿè£…ã¯å®Œäº†ã§ã™ã€‚

## Minikubeã§Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æ§‹ç¯‰

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§Kuberneteså´ã®æ§‹ç¯‰ã‚’ã—ã¦ã„ãã¾ã™ã€‚ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«æ§‹ç¯‰ã™ã‚‹ã®ã§Minikubeã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ã¾ã ã€Minikubeã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã„æ–¹ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚Macã®æ–¹ã¯brewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

Minikubeã¯è¤‡æ•°ã®driverã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒä»Šå›ã¯dockerã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

```
brew install minikube

# Minikubeã‚’èµ·å‹•ã™ã‚‹
minikube start
```

## Helmã§ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹

ä»Šå›ã¯Kubernetesãƒªã‚½ãƒ¼ã‚¹ã‚’Helmã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹å˜ä½ã§ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆã—ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ãã¾ã™ã€‚

```
# install
brew install helm

# create
helm create {gacha|item|api-gateway}
```

```
tree .

.
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ api-gateway
â”‚Â Â  â”œâ”€â”€ Chart.yaml
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ charts
â”‚Â Â  â”œâ”€â”€ templates
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ NOTES.txt
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ _helpers.tpl
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ deployment.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hpa.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ingress.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ service.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ serviceaccount.yaml
â”‚Â Â  â”‚Â Â  â””â”€â”€ tests
â”‚Â Â  â”‚Â Â      â””â”€â”€ test-connection.yaml
â”‚Â Â  â””â”€â”€ values.yaml
â”œâ”€â”€ debug.yaml
â”œâ”€â”€ gacha
â”‚Â Â  â”œâ”€â”€ Chart.lock
â”‚Â Â  â”œâ”€â”€ Chart.yaml
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ charts
â”‚Â Â  â”‚Â Â  â””â”€â”€ mysql-9.10.4.tgz
â”‚Â Â  â”œâ”€â”€ keys.txt
â”‚Â Â  â”œâ”€â”€ secrets
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ secrets.enc.yaml
â”‚Â Â  â”‚Â Â  â””â”€â”€ secrets.yaml
â”‚Â Â  â”œâ”€â”€ templates
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ NOTES.txt
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ _helpers.tpl
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ deployment.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ hpa.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ingress.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ service.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ serviceaccount.yaml
â”‚Â Â  â”‚Â Â  â””â”€â”€ tests
â”‚Â Â  â”‚Â Â      â””â”€â”€ test-connection.yaml
â”‚Â Â  â””â”€â”€ values.yaml
â””â”€â”€ item
    â”œâ”€â”€ Chart.lock
    â”œâ”€â”€ Chart.yaml
    â”œâ”€â”€ Makefile
    â”œâ”€â”€ charts
    â”‚Â Â  â””â”€â”€ mysql-9.10.4.tgz
    â”œâ”€â”€ keys.txt
    â”œâ”€â”€ secrets
    â”‚Â Â  â”œâ”€â”€ secrets.enc.yaml
    â”‚Â Â  â””â”€â”€ secrets.yaml
    â”œâ”€â”€ templates
    â”‚Â Â  â”œâ”€â”€ NOTES.txt
    â”‚Â Â  â”œâ”€â”€ _helpers.tpl
    â”‚Â Â  â”œâ”€â”€ deployment.yaml
    â”‚Â Â  â”œâ”€â”€ hpa.yaml
    â”‚Â Â  â”œâ”€â”€ ingress.yaml
    â”‚Â Â  â”œâ”€â”€ service.yaml
    â”‚Â Â  â”œâ”€â”€ serviceaccount.yaml
    â”‚Â Â  â””â”€â”€ tests
    â”‚Â Â      â””â”€â”€ test-connection.yaml
    â””â”€â”€ values.yaml
```

```templates/deployment.yaml```ã¨```values.yaml```ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```yaml:deployment.yaml
piVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "api-gateway.fullname" . }}
  labels:
    {{- include "api-gateway.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "api-gateway.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "api-gateway.selectorLabels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "api-gateway.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¯ä»Šå›çœç•¥
          # livenessProbe:
          #   httpGet:
          #     path: /
          #     port: http
          # readinessProbe:
          #   httpGet:
          #     path: /
          #     port: http
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
```

```yaml:values.yaml
# Default values for test.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1

image:
  repository: nginx
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

service:
  type: ClusterIP
  port: 80

ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: chart-example.local
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

resources: {}
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity: {}
```

## MySQLãƒãƒ£ãƒ¼ãƒˆã‚’ä¾å­˜é–¢ä¿‚ã«è¿½åŠ ã™ã‚‹

gacha-serviceã¨item-serviceã€ãã‚Œãã‚ŒMySQLã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ä»Šå›ã¯[bitnamiã®ãƒãƒ£ãƒ¼ãƒˆ](https://artifacthub.io/packages/helm/bitnami/mysql)ã‚’ä½¿ç”¨ã—ã¦ã¿ã¾ã—ãŸã€‚```Chart.yaml```ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã—ã¾ã™ã€‚

```diff yaml:Chart.yaml
apiVersion: v2
name: gacha
description: A Helm chart for Kubernetes
type: application
version: 0.1.0
appVersion: "1.16.0"
+dependencies:
+  - name: "mysql"
+    version: "9.10.4"
+    repository: "https://charts.bitnami.com/bitnami"
```

è¿½åŠ ã—ãŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
# ä¾å­˜é–¢ä¿‚è§£æ±º
helm dependencies build
```

å®Œäº†ã™ã‚‹ã¨chartsé…ä¸‹ã«MySQLã®ãƒãƒ£ãƒ¼ãƒˆãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹

ä½œæˆã—ãŸHelmã®ãƒãƒ£ãƒ¼ãƒˆã«ã¯nginxã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã®ã§å„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã„ãã¾ã™ã€‚ãªãŠã€ä»Šå›ã¯DockerHubã®ã‚ˆã†ãªã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«pushã›ãšMinikubeãŒèµ·å‹•ã—ã¦ã„ã‚‹dockerç’°å¢ƒä¸Šã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ã§ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«pushã›ãšã«ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã•ã›ã¾ã™ã€‚

### Minikube VMä¸Šã®dockerã‚’ä½¿ã†ã‚ˆã†ã«è¨­å®šã™ã‚‹

å‰è¿°ã—ãŸã‚ˆã†ã«dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’pushã—ãªã„ã¨ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ¢ã—ã«è¡Œã£ã¦ã—ã¾ã†ã®ã§Minikube VMä¸Šã§ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§Minikube VMä¸Šã®dockerã‚’å‘ãã‚ˆã†ã«è¨­å®šã§ãã¾ã™ã€‚

```
eval $(minikube docker-env)
```

### Dockerfileã‚’ä½œæˆã™ã‚‹

ã“ã‚Œã¾ã§ã«ä½œæˆã—ãŸå„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«Dockerfileã‚’ä½œæˆã—ã¦ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

```docker:Dockerfile
# syntax=docker/dockerfile:1

##
## Build
##
FROM golang:1.20-buster AS build

WORKDIR /app

COPY go.mod ./
COPY go.sum ./
RUN go mod download

COPY . .

RUN go build -o gacha-service

##
## Deploy
##
FROM debian:12-slim

WORKDIR /

COPY --from=build app/gacha-service .

EXPOSE 8080

ENTRYPOINT ["/gacha-service"] 
```

DockerfileãŒä½œæˆã§ããŸã‚‰ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚æ³¨æ„ç‚¹ã¨ã—ã¦ã¯å‰è¿°ã—ãŸMinikube VMä¸Šã®dockerã«å‘ã„ã¦ã„ã‚‹çŠ¶æ…‹ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```
docker build -t jy8752/gacha-service:1.0.0
```

### values.yamlã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å·®ã—æ›¿ãˆã‚‹

ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ãŸã‚‰values.yamlã§æŒ‡å®šã—ã¦ã„ã‚‹nginxã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã«å·®ã—æ›¿ãˆã¾ã™ã€‚

```diff yaml:values.yaml
...
image:
+  name: gacha
-  repository: nginx
+  repository: jy8752/gacha-service
  pullPolicy: IfNotPresent
-  tag: ""
+  tag: "1.0.0"
...
```

repositoryã®å€¤ã‚’ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã«å·®ã—æ›¿ãˆã¾ã™ã€‚ã¾ãŸã€ã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ¢ã—ã«ã„ã‹ãªã„ã‚ˆã†ã«```pullPolicy```ã¯```IfNotPresent```ã«ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

## helm-secretsã‚’ä½¿ç”¨ã—ã¦MySQLã«ç§˜åŒ¿æƒ…å ±ã‚’æ¸¡ã™

bitnami/mysqlãƒãƒ£ãƒ¼ãƒˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¯values.yamlã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```diff yaml:values.yaml
...
+mysql:
+  auth:
+    database: Gacha
+    username: gacha
```

```mysql.auth.database```ã¯DBèµ·å‹•æ™‚ã«ä½œæˆã™ã‚‹databaseåã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚```mysql.auth.username```ã¯rootä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã“ã§ã€```mysql.auth.password```ã§ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒ**ç§˜åŒ¿æƒ…å ±ã®ãŸã‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã™ã‚‹values.yamlã«ã¯ãã®ã¾ã¾æ›¸ããŸãã‚ã‚Šã¾ã›ã‚“**ã€‚

ã“ã®ã‚ˆã†ãªSecretã‚’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã™ã‚‹æ–¹æ³•ã¯æ§˜ã€…ã‚ã‚‹ã‚ˆã†ã§ã™ãŒä»Šå›ã¯[helm-secrets](https://github.com/jkroepke/helm-secrets)ã‚’ä½¿ç”¨ã—ã¦ã€values.yamlã‚’æš—å·åŒ–ã—ã¦ã€ãƒãƒ£ãƒ¼ãƒˆä½œæˆæ™‚ã«è¤‡åˆåŒ–ã—ã¦ä½¿ã†ã‚ˆã†ã«ã—ã¾ã™ã€‚

helm-secretsã¯AWSã‚„GCPã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ä»Šå›ã¯Goè£½ã®ãƒ•ã‚¡ã‚¤ãƒ«æš—å·åŒ–ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹[age](https://github.com/FiloSottile/age)ã‚’ä½¿ç”¨ã—ã¦æš—å·åŒ–ã—ã¾ã™ã€‚

ãªãœageã‚’ä½¿ã†ã‹ã«é–¢ã—ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’ä½œæˆã—ã¾ã—ãŸã®ã§èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯ã“ã¡ã‚‰ã‚‚ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/jy8752/articles/eaef90b33f9ab3

### sopsã¨ageã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

helm-secretsã¯æš—å·åŒ–ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«[sops](https://github.com/mozilla/sops)ã¨[vals](https://github.com/helmfile/vals)ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒä»Šå›ã¯sopsã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
brew install sops
```

ãã—ã¦ã€å®Ÿéš›ã«æš—å·åŒ–ã«ã¯ageã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
brew install age
```

### æš—å·åŒ–ã«ä½¿ç”¨ã™ã‚‹éµã‚’ç”Ÿæˆã™ã‚‹

```
age-keygen -o key.txt
```

**ç”Ÿæˆã•ã‚ŒãŸkey.txtã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã•ã‚Œãªã„ã‚ˆã†ã«.gitignoreã«è¿½è¨˜ã—ã¦ãã ã•ã„**ã€‚

### valuesãƒ•ã‚¡ã‚¤ãƒ«ã‚’æš—å·åŒ–ã™ã‚‹

ç§˜åŒ¿æƒ…å ±ã¯```secrets.yaml```ã«è¨˜è¼‰ã—ã¾ã™ã€‚

```yaml:secrets.yaml
mysql:
    auth:
        password: gacha # ã“ã“ã«DBã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ‡å®šã™ã‚‹
```

**ã“ã®secrets.yamlã‚‚å¹³æ–‡ã§ç§˜åŒ¿æƒ…å ±ãŒè¨˜è¼‰ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ã®ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«ã¯å«ã¾ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„**ã€‚

ä½œæˆã—ãŸsecrets.yamlã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦æš—å·åŒ–ã—ã¾ã™ã€‚ã‚³ãƒãƒ³ãƒ‰ã«ã¯å…ˆã»ã©ä½œæˆã—ãŸkey.txtã«è¨˜è¼‰ã®å…¬é–‹éµã‚’æŒ‡å®šã—ã¾ã™ã€‚

```
sops --encrypt --age age158hhkp5kn6aeauhqkaqf2rqcqvjxan0mkuz30qkcr4g3sf9skpzqkm07ad secrets/secrets.yaml > secrets/secrets.enc.yaml
```

```yaml:secrets.enc.yaml
mysql:
    auth:
        password: ENC[AES256_GCM,data:1QxD+x8=,iv:8SNmFSkdBOP2a+4zqJrQzWMdUsEkA0cHsKpOeqB7xNs=,tag:6o1Vz5MCOshuMtlHNUmMog==,type:str]
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age158hhkp5kn6aeauhqkaqf2rqcqvjxan0mkuz30qkcr4g3sf9skpzqkm07ad
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBaSFlKMEkwM0RVYjlMVldk
            dTlDek1XMXRVVGs0MEhTaEFlQzFSQzRtYTBjCk5STDE5blBSSlZqY2RaMm94bm4w
            SGRQSU81REZaMy9Fc3lCV0JtYzFaQzQKLS0tIEQwUXhQT3dOK0lYeXQveWVyWFdN
            QjRvSThFS3lEc0dTL3dnRlJPK0JWbUkKmDWgpwEEtT4baIqBQqCX9gBNDOZeoQAb
            Y9Ew3ahiQGx5rKPcZn5TB4pGU2bXUpnSlFb2z8Kt/TnjJw+zygUmkw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-06-19T19:28:27Z"
    mac: ENC[AES256_GCM,data:32EPhpXdIQ2poaB9B5AUH3ocXduTbgyfE/3Jc1sxAsHf5LOUJxH52va2WWmSTDDv3JomBOmCEYYBU2r0ZA70/JepIl1mlufI7sauS1VxHPZ7CFNZ45/UujkT85hZa2QSH9mxVN88xFaeoyAtQnd5MBvlgpNRtsujiDoYOl+a5LI=,iv:bHGMVZsqYXCt9pdWQUZL1+WYl4r/0sgRCardFnypnEU=,tag:k+0YtSNoEqZp4WeoxyhWfQ==,type:str]
    pgp: []
    unencrypted_suffix: _unencrypted
    version: 3.7.3
```

ã‚ã¨ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«```helm secrets ...```ã¨ã—ã¦æš—å·åŒ–ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦installã™ã‚‹ã“ã¨ã§å†…éƒ¨çš„ã«key.txtã‚’èª­ã¿å–ã‚Šè¤‡åˆåŒ–ã—ãŸä¸Šã§ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
helm secrets upgrade gacha . --install \
	-f values.yaml \
	-f secrets/secrets.enc.yaml
```

:::message
sopsã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Macã§ã‚ã‚Œã°```$HOME/Library/Application Support/sops/age/keys.txt```ã«éµãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã«è¡Œãã¾ã™ã€‚ã“ã‚Œã‚’å¤‰æ›´ã™ã‚‹ã«ã¯```SOPS_AGE_KEY_FILE```ã«ç”Ÿæˆã—ãŸéµãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
:::

ãƒãƒ£ãƒ¼ãƒˆã®ä½œæˆã«æˆåŠŸã™ã‚‹ã¨ä¸Šæ›¸ãã—ãŸDBã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯Secretãƒªã‚½ãƒ¼ã‚¹ã¨ã—ã¦ä½œæˆã•ã‚Œã¦ã¦ã„ã‚‹ã®ã§Deploymentãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦Secretã®å€¤ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## èµ·å‹•ã¨å‹•ä½œç¢ºèª

ã“ã“ã¾ã§ã§Kubernetesãƒªã‚½ãƒ¼ã‚¹ã¯ä¸€é€šã‚Šæ§‹ç¯‰ã§ããŸã®ã§æœ€å¾Œã«å¤–éƒ¨ã‹ã‚‰ã®æ¥ç¶šã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã«api-gatewayãƒãƒ£ãƒ¼ãƒˆã®serviceã‚¿ã‚¤ãƒ—ã‚’NodePortã«å¤‰æ›´ã—ã¾ã™ã€‚

```diff yaml:api-gateway/values.yaml
...
service:
-  type: ClusterIP
+  type: NodePort
-  port: 80
+  port: 8080
...
```

å„ãƒãƒ£ãƒ¼ãƒˆãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¦ã„ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«3ã¤ã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¨MySQL2ã¤ã§è¨ˆ5ã¤ã®PodãŒèµ·å‹•ã—ã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

```
$ kubectl get pods
NAME                                       READY   STATUS    RESTARTS        AGE
api-gateway-59dd9d5657-rpl7l               1/1     Running   1 (45h ago)     45h
gacha-66cf9f6754-kjw2l                     1/1     Running   0               45h
gacha-mysql-0                              1/1     Running   0               45h
item-75859b6957-b4z9d                      1/1     Running   4 (45h ago)     45h
item-mysql-0                               1/1     Running   0               45h
```

serviceã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã¯ãš

```
$ kubectl get service
NAME                      TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
api-gateway               NodePort    10.106.149.254   <none>        8080:32256/TCP   45h
gacha                     ClusterIP   10.103.104.5     <none>        8080/TCP         45h
gacha-mysql               ClusterIP   10.107.114.35    <none>        3306/TCP         45h
gacha-mysql-headless      ClusterIP   None             <none>        3306/TCP         45h
item                      ClusterIP   10.105.34.196    <none>        8080/TCP         45h
item-mysql                ClusterIP   10.106.181.122   <none>        3306/TCP         45h
item-mysql-headless       ClusterIP   None             <none>        3306/TCP         45h
kubernetes                ClusterIP   10.96.0.1        <none>        443/TCP          12d
```

Minikubeã®driverã‚’dockerã«ã—ã¦ã„ã¦NodePortã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€```minikube service <Serviceå>```ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªURLã‚’ç™ºè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```
minikube service api-gateway
...

ğŸƒ  api-gateway ã‚µãƒ¼ãƒ“ã‚¹ç”¨ã®ãƒˆãƒ³ãƒãƒ«ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™ã€‚
|-----------|-------------|-------------|------------------------|
| NAMESPACE |    NAME     | TARGET PORT |          URL           |
|-----------|-------------|-------------|------------------------|
| default   | api-gateway |             | http://127.0.0.1:56487 |
|-----------|-------------|-------------|------------------------|
```

ä¸Šè¨˜ã®ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹URLãŒç™ºè¡Œã•ã‚ŒãŸã‚‰åˆ¥ã®terminalã‹ã‚‰æ¥ç¶šã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

### ã‚¬ãƒãƒ£ã‚’å¼•ã

```
curl -XPOST -H 'Content-Type: application/json' -d '{"user_id": 1}' localhost:56487/draw | jq

{
  "item_id": 3,
  "item_name": "item3",
  "rarity": 3
}
```

### ã‚¬ãƒãƒ£ã®å±¥æ­´ã‚’ç¢ºèªã™ã‚‹

```
curl localhost:56487/histories/1 | jq

{
  "histories": [
    {
      "item_id": 3,
      "item_name": "item3",
      "rarity": 3,
      "created_at": {
        "seconds": 1687778806
      }
    },
    {
      "item_id": 2,
      "item_name": "item2",
      "rarity": 2,
      "created_at": {
        "seconds": 1687778249
      }
    },
    ...
}
```

### ã‚¢ã‚¤ãƒ†ãƒ æ‰€æŒæƒ…å ±ã‚’ç¢ºèªã™ã‚‹

```
curl localhost:56487/inventories/1 | jq

{
  "items": [
    {
      "item_id": 1,
      "item_name": "item1",
      "rarity": 1,
      "count": 6
    },
    {
      "item_id": 2,
      "item_name": "item2",
      "rarity": 2,
      "count": 2
    },
    {
      "item_id": 3,
      "item_name": "item3",
      "rarity": 3,
      "count": 2
    },
    {
      "item_id": 4,
      "item_name": "item4",
      "rarity": 4,
      "count": 2
    }
  ]
}
```

## (ãŠã¾ã‘)debugç”¨ã®Podã‚’ä½œæˆã™ã‚‹

MySQLã‚„ä»–ã®gRPCã‚µãƒ¼ãƒãƒ¼ã¸ã®ç–é€šç¢ºèªã™ã‚‹ãŸã‚ã«debugç”¨ã«Podã‚’åˆ¥é€”ä½œæˆã—ã¾ã—ãŸã€‚

```yaml:debug.yaml
apiVersion: v1
kind: Pod
metadata:
  name: debug-pod
spec:
  initContainers:
  - name: install
    image: debian
    command:
    - /bin/bash
    - -c
    - |
      apt update && apt install -y default-mysql-client-core
      apt install -y curl unzip
      VERSION=$(curl -s https://api.github.com/repos/fullstorydev/grpcurl/releases/latest | grep 'tag_name' | cut -d\" -f4)
      DOWNLOAD_URL="https://github.com/fullstorydev/grpcurl/releases/download/$VERSION/grpcurl_${VERSION:1}_linux_x86_64.tar.gz"
      curl -L $DOWNLOAD_URL -o grpcurl.tar.gz
      tar xvf grpcurl.tar.gz grpcurl
      mv grpcurl /usr/local/bin/
      rm -rf grpcurl.tar.gz
    volumeMounts:
    - name: local-bin
      mountPath: /usr/local/bin
  containers:
  - name: app
    image: debian
    command: ["/bin/bash", "-c", "--"]
    args: ["while true; do sleep 30; done;"]
    volumeMounts:
    - name: local-bin
      mountPath: /usr/local/bin
  volumes:
  - name: local-bin
    emptyDir: {}
```

ã‚„ã‚ŠãŸã„ã“ã¨ã¨ã—ã¦ã¯MySQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨[grpcurl](https://github.com/fullstorydev/grpcurl)ãŒå…¥ã£ãŸçŠ¶æ…‹ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ãŸã„ã ã‘ãªã®ã§æœ¬æ¥ã¯ãã‚Œã‚‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸçŠ¶æ…‹ã®dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹ã®ãŒæ­£è§£ãªæ°—ãŒã—ã¾ã™ãŒä»Šå›ã¯Podã®åˆæœŸåŒ–å‡¦ç†ã§å®Ÿæ–½ã—ã¾ã—ãŸã€‚

Podã®åˆæœŸåŒ–å‡¦ç†ã«ã¯```initContainers```ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§åˆ¥é€”åˆæœŸåŒ–ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚MySQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨grpcurlã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã®ã¯åˆ¥é€”èµ·å‹•ã—ãŸåˆæœŸåŒ–ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã®ãŸã‚volumesã‚’ä½œæˆã—ã€ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

:::message
å®Ÿéš›ã¯MySQLã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ```usr/bin```ã®æ–¹ã«ã‚ã£ã¦ã€å…±æœ‰ã§ãã¦ã„ãªã‹ã£ãŸãŸã‚ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã£ãŸå¾Œã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ç›´ã—ã¾ã—ãŸã€‚ã€‚
:::

ã‚ã¨ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦Podã‚’èµ·å‹•ã—ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚‹ã“ã¨ã§ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚„MySQLã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
kubectl apply debug.yaml
kubectl exec -it debug-pod -- bash
```

## ã¾ã¨ã‚

æ€ã£ã¦ãŸã‚ˆã‚Šé•·ããªã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒä»Šå›ã¯ä»¥ä¸‹ã®ã“ã¨ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚

- Goã§ä½œæˆã—ãŸãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®gRPCé€šä¿¡ã«ã¤ã„ã¦
- Helmã‚’ä½¿ç”¨ã—ãŸKubernetesãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦
- Minikubeã‚’åˆ©ç”¨ã—ãŸãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã«ã¤ã„ã¦
- helm-secretsã‚’ä½¿ç”¨ã—ãŸKuberneteã«ãŠã‘ã‚‹ç§˜åŒ¿æƒ…å ±ã®æ‰±ã„ã«ã¤ã„ã¦

ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§æ§‹ç¯‰ã—ã¾ã—ãŸãŒAWSã‚„GCPã¨ã„ã£ãŸã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã«Kubernetesç’°å¢ƒã‚’æ§‹ç¯‰ã—ãŸã‚Šã€Kubernetesã®CI/CDã ã£ãŸã‚Šã€[skaffold](https://skaffold.dev/)ã‚’åˆ©ç”¨ã—ãŸé–‹ç™ºç’°å¢ƒã ã£ãŸã‚Šã¾ã ã¾ã ã‚„ã‚ã†ã¨æ€ãˆã°ã‚„ã‚‹ã“ã¨ã¯ãŸãã•ã‚“ã‚ã£ã¦æœ¬å½“ã«Kubernetesã¯å¥¥ãŒæ·±ã„ã€‚ã€‚(æœ¬å½“ã¯sagaã‚„ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã¾ã§ã‚„ã‚ã†ã¨ã—ã¦ãŸã®ã§ã™ãŒæ–­å¿µã—ã¾ã—ãŸã€‚)

æœ¬è¨˜äº‹ãŒä½•ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

ä»¥ä¸ŠğŸ¼

## å‚è€ƒ

Goã®gRPCå®Ÿè£…ã§å¤§å¤‰ãŠä¸–è©±ã«ãªã£ã¦ã„ã¾ã™
https://zenn.dev/hsaki/books/golang-grpc-starting

dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’pushã—ãªã„ã§ä½¿ã„ãŸã„
https://qiita.com/ocadaruma/items/efe720e46ae7ecb9ec25

Minikubeã®driverã§dockerã‚’é¸æŠã—ã¦ã„ã‚‹ã¨ãã«NodePortãŒæ¥ç¶šã§ããªã„
https://info.drobe.co.jp/blog/engineering/minikube-driver#6a2bb7fcc3b9496d9410641b7fddd40a