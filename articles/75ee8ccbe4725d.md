---
title: "Minikubeã§æ§‹ç¯‰ã™ã‚‹ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã§Kubernetesã‚’å­¦ã¶"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Kubernetes", "Minikube", "Go", "ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹", "grpc"]
published: false
---

[Kubernetes å®Œå…¨ã‚¬ã‚¤ãƒ‰](https://www.amazon.co.jp/Kubernetes%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-%E7%AC%AC2%E7%89%88-Top-Gear-%E9%9D%92%E5%B1%B1/dp/4295009792)ã¨[ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³[å®Ÿè·µçš„ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰è§£èª¬]](https://www.amazon.co.jp/%E3%83%9E%E3%82%A4%E3%82%AF%E3%83%AD%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-%E5%AE%9F%E8%B7%B5%E7%9A%84%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%82%B3%E3%83%BC%E3%83%89%E8%A7%A3%E8%AA%AC-impress-top-gear/dp/4295008583)ã‚’èª­ã¿çµ‚ãˆã€ã ã„ã¶ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæ¹§ãã¾ã—ãŸï¼

ãŸã ã€ã¾ã å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¬ãƒ™ãƒ«ã§ã®é‹ç”¨ãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã—ãã‚Œãªã‹ã£ãŸã®ã§æœ€å°æ§‹æˆã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«æ§‹ç¯‰ã—ã¦ã¿ãŸã®ã§ãã®å‚™å¿˜éŒ²ã§ã™ã€‚

ä»Šå›ã®æˆæœç‰©ã¯ã“ã¡ã‚‰

https://github.com/JY8752/microservice-demo

## æƒ³å®šèª­è€…

- Kubernetesåˆå­¦è€…ã§æ¬¡ã«å®Ÿè·µçš„ãªä½¿ã„æ–¹ã‚’å­¦ã³ãŸã„æ–¹
- Goã‚’ä½¿ã£ãŸãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹ç¯‰ã«èˆˆå‘³ãŒã‚ã‚‹æ–¹

## ä½¿ç”¨ç’°å¢ƒ

- Minikube v1.30.1
- kubectl(client) v1.25.9
- kubectl(server) v1.26.3
- Helm v3.12.0
- Go 1.20.4
- protoc 3.11.4

## ä»Šå›æ§‹ç¯‰ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ä»Šå›ä½œæˆã™ã‚‹ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ä»¥ä¸‹ã®æ§‹æˆã§ã™ã€‚ã„ã‚ã„ã‚çœã„ã¦ã¾ã™ãŒã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚²ãƒ¼ãƒ ã®ã‚¬ãƒãƒ£ã‚’å¼•ãæ“ä½œã‚’æƒ³å®šã—ã¦ã¾ã™ã€‚

- gacha-service ã‚¬ãƒãƒ£ã‚’å¼•ãã¾ã™ã€‚ã‚¢ã‚¤ãƒ†ãƒ ã®æŠ½é¸ã¨ã‚¬ãƒãƒ£ã‚’å¼•ã„ãŸå±¥æ­´ã‚’DBã«ä¿å­˜ã—ã¾ã™ã€‚
- item-service ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç®¡ç†ã—ã¾ã™ã€‚ä»Šå›ã¯æŠ½é¸ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚
- api-gateway å¤–éƒ¨ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã“ã“ã§å—ã‘ä»˜ã‘ã¾ã™ã€‚

ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã¯gRPCã§è¡Œã„ã€å¤–éƒ¨ã¨ã®é€šä¿¡ã¯HTTPé€šä¿¡ã§è¡Œã„ã¾ã™ã€‚

Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã¯ä»Šå›ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã«æ§‹ç¯‰ã™ã‚‹ãŸã‚Minikubeã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®ãƒªã‚½ãƒ¼ã‚¹ã¯Helmã‚’ä½¿ç”¨ã—ã¦ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/2b67c5c74b2d-20230629.png)

é€šå¸¸ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚’é‹ç”¨ã™ã‚‹ãªã‚‰ã°ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã«ãªã‚‹ã¨æ€ã„ã¾ã™ãŒä»Šå›ã¯ï¼‘ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¾ã¨ã‚ã¦é…ç½®ã—ã¦ã„ã¾ã™ã€‚

```
.
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ api-gateway
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ gacha.go
â”‚Â Â  â”œâ”€â”€ go.mod
â”‚Â Â  â”œâ”€â”€ go.sum
â”‚Â Â  â”œâ”€â”€ item.go
â”‚Â Â  â”œâ”€â”€ main.go
â”‚Â Â  â””â”€â”€ pkg
â”œâ”€â”€ gacha-service
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ go.mod
â”‚Â Â  â”œâ”€â”€ go.sum
â”‚Â Â  â”œâ”€â”€ item.go
â”‚Â Â  â”œâ”€â”€ main.go
â”‚Â Â  â”œâ”€â”€ pkg
â”‚Â Â  â””â”€â”€ service.go
â”œâ”€â”€ go.work
â”œâ”€â”€ go.work.sum
â”œâ”€â”€ item-service
â”‚Â Â  â”œâ”€â”€ Dockerfile
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ go.mod
â”‚Â Â  â”œâ”€â”€ go.sum
â”‚Â Â  â”œâ”€â”€ main.go
â”‚Â Â  â”œâ”€â”€ pkg
â”‚Â Â  â””â”€â”€ service.go
â”œâ”€â”€ k8s
â”‚Â Â  â”œâ”€â”€ Makefile
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ api-gateway
â”‚Â Â  â”œâ”€â”€ debug.yaml
â”‚Â Â  â”œâ”€â”€ gacha
â”‚Â Â  â””â”€â”€ item
â””â”€â”€ proto
    â”œâ”€â”€ gacha.proto
    â”œâ”€â”€ item.proto
    â””â”€â”€ rarity.proto
```

## ã‚¬ãƒãƒ£ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…

Goã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```
go mod init gacha-service
```

ã¾ãŸã€ä»Šå›ã¯ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã«gRPCã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ä»¥ä¸‹ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
go get -u google.golang.org/grpc
go get -u google.golang.org/grpc/cmd/protoc-gen-go-grpc
```

### protoãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ã‚¬ãƒãƒ£ã‚’å¼•ãå‡¦ç†ã¨ã‚¬ãƒãƒ£å±¥æ­´ã‚’å–å¾—ã™ã‚‹rpcã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```protobuf:gacha.proto
syntax = "proto3";

option go_package = "pkg/grpc";

package gacha;

import "proto/rarity.proto";
import "google/protobuf/timestamp.proto";

service GachaService {
  rpc Draw(DrawRequest) returns (DrawResponse) {}
  rpc GetHistories(GetHistoriesRequest) returns (GetHistoriesResponse) {}
}

message DrawRequest {
  int64 user_id = 1;
}

message DrawResponse {
  int64  item_id   = 1;
  string item_name = 2;
  rarity.Rarity rarity    = 3;
}

message GetHistoriesRequest {
  int64 user_id = 1;
}

message History {
  int64  item_id   = 1;
  string item_name = 2;
  rarity.Rarity rarity    = 3;
  google.protobuf.Timestamp created_at = 4;
}

message GetHistoriesResponse {
  repeated History histories = 1;
}
```

```protobuf:rarity.proto
syntax = "proto3";

option go_package = "pkg/grpc";

package rarity;

enum Rarity {
  RARITY_UNKNOWN = 0;
  RARITY_N       = 1;
  RARITY_R       = 2;
  RARITY_SR      = 3;
  RARITY_SSR     = 4;
}
```

ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã§ããŸã‚‰protoc-gen-goã‚’ä½¿ç”¨ã—ã¦ã€Goã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

```make:Makefile
.PHONY: proto
proto:
	protoc --proto_path=../ \
		--go_out=./pkg/grpc --go_opt=paths=source_relative \
		--go-grpc_out=./pkg/grpc --go-grpc_opt=paths=source_relative \
		../proto/*.proto
```

```
mkdir -p pkg/grpc
make proto
```

### mainå‡¦ç†

ã¨ã‚Šã‚ãˆãšå‡¦ç†ã®æµã‚Œã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚

```go:main.go
func main() {
	log.Println("Start Gacha Service")

	dsn, err := getDatasourceName()
	if err != nil {
		log.Fatal(err)
	}

	db, err := connectDb(dsn)
	if err != nil {
		log.Fatal(err)
	}
	defer db.Close()

	createTable(db)

	// grpc server ã®èµ·å‹•
	listener, err := net.Listen("tcp", ":8080")
	if err != nil {
		log.Fatalf("failed to listen: %v", err)
	}

	server := grpc.NewServer()

	reflection.Register(server)

	// ã‚¬ãƒãƒ£ã®ç™»éŒ²
	items := []Item{
		{Id: 1, Name: "item1", Rarity: gachapb.Rarity_RARITY_N, Weight: 40},
		{Id: 2, Name: "item2", Rarity: gachapb.Rarity_RARITY_R, Weight: 30},
		{Id: 3, Name: "item3", Rarity: gachapb.Rarity_RARITY_SR, Weight: 20},
		{Id: 4, Name: "item4", Rarity: gachapb.Rarity_RARITY_SSR, Weight: 10},
	}
	gachapb.RegisterGachaServiceServer(server, NewGachaServiceServer(db, items))

	go func() {
		if err := server.Serve(listener); err != nil {
			log.Fatalf("failed to serve: %v", err)
		}
	}()

	defer Close()

	// Graceful Shutdown
	quit := make(chan os.Signal, 1)
	signal.Notify(quit, syscall.SIGTERM, os.Interrupt)
	<-quit
	log.Println("Shutdown Server ...")
	server.GracefulStop()
}
```

DBã«ã¯ä»Šå›MySQLã‚’ä½¿ç”¨ã—ã€æ¥ç¶šã€ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãªã©ã®ã‚¯ã‚¨ãƒªæ“ä½œã«ã¯```database/sql```ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€gRPCã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦èµ·å‹•ã™ã‚‹ã®ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®ç™»éŒ²ã¨èµ·å‹•å‡¦ç†ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚å¾Œè¿°ã—ã¾ã™ãŒä»®æƒ³ã‚¬ãƒãƒ£ã®ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯ãƒ™ã‚¿æ›¸ãã§serviceå‡¦ç†ã«æ¸¡ã—ã¦ã„ã¾ã™ã€‚

### serviceå‡¦ç†

protoãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’ã‚‚ã¨ã«è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

```go
type GachaServiceServer interface {
	Draw(context.Context, *DrawRequest) (*DrawResponse, error)
	GetHistories(context.Context, *GetHistoriesRequest) (*GetHistoriesResponse, error)
	mustEmbedUnimplementedGachaServiceServer()
}
```

mainé–¢æ•°ã§ã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¦ã„ã‚‹ã®ã§ã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’æº€ãŸã™å®Ÿè£…ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

```go:service.go
type gachaServiceServer struct {
	gachapb.UnimplementedGachaServiceServer
	db    *sql.DB
	items []Item
}

func NewGachaServiceServer(db *sql.DB, items []Item) gachapb.GachaServiceServer {
	return &gachaServiceServer{
		db:    db,
		items: items,
	}
}

func (g *gachaServiceServer) Draw(ctx context.Context, req *gachapb.DrawRequest) (*gachapb.DrawResponse, error) {
	// itemsã‹ã‚‰itemã‚’é‡ã¿ä»˜æŠ½é¸ã™ã‚‹
	weights := make([]int, len(g.items))
	for i, item := range g.items {
		weights[i] = item.Weight
	}

	seed := time.Now().UnixNano()
	i := linearSearchLottery(weights, seed)
	item := g.items[i]

	// DBã«ä¿å­˜ã™ã‚‹
	if err := save(ctx, g.db, req.UserId, item); err != nil {
		return nil, err
	}

	// itemæ‰€æŒæƒ…å ±ã‚‚æ›´æ–°ã™ã‚‹
	res, err := GetItem(ctx, req.UserId, item.Id, item.Name, item.Rarity)
	if err != nil {
		return nil, err
	}

	fmt.Printf("get_item_response: %+v\n", res)

	return &gachapb.DrawResponse{
		ItemId:   item.Id,
		ItemName: item.Name,
		Rarity:   item.Rarity,
	}, nil
}
```

å‡¦ç†ã®æµã‚Œã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæµã‚Œã§ã™ã€‚

- é‡ã¿ä»˜æŠ½é¸ã«ã‚ˆã‚Šã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¸€ã¤æŠ½é¸ã™ã‚‹ã€‚
- ã‚¬ãƒãƒ£ã®å±¥æ­´ã‚’DBã«ä¿å­˜ã™ã‚‹ã€‚
- æŠ½é¸ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å¾Œè¿°ã™ã‚‹item-serviceã®```GetItem()```ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§è¨˜éŒ²ã™ã‚‹ã€‚

æŠ½é¸ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨DBæ“ä½œã«é–¢ã—ã¦ã®å®Ÿè£…ã¯çœç•¥ã„ãŸã—ã¾ã™ãŒã€ã‚‚ã—å…¨ã¦ã®å®Ÿè£…ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://github.com/JY8752/microservice-demo/tree/main/gacha-service

## ã‚¢ã‚¤ãƒ†ãƒ ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…

ã‚¢ã‚¤ãƒ†ãƒ ã‚µãƒ¼ãƒ“ã‚¹ã®æ§‹æˆã¯ã»ã¨ã‚“ã©ã‚¬ãƒãƒ£ã‚µãƒ¼ãƒ“ã‚¹ã®æ–¹ã¨åŒæ§˜ã§ã™ã€‚

```
go mod init item-service
```

### protoãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚

```protobuf:item.proto
package item;

import "proto/rarity.proto";

service ItemService {
    rpc GetItem(GetItemRequest) returns (GetItemResponse) {}
    rpc GetInventory(GetInventoryRequest) returns (GetInventoryResponse) {}
}

message GetItemRequest {
    int64 user_id  = 1;
    int64 item_id  = 2;
    string item_name = 3;
    rarity.Rarity rarity = 4;
}

message GetItemResponse {
    int64 item_id  = 1;
    string item_name = 2;
    rarity.Rarity rarity = 3;
    int32 count = 4;
}

message GetInventoryRequest {
    int64 user_id  = 1;
}

message InventoryItem {
    int64 item_id  = 1;
    string item_name = 2;
    rarity.Rarity rarity = 3;
    int32 count = 4;
}

message GetInventoryResponse {
    repeated InventoryItem items = 1;
}
```

ä½œæˆã§ããŸã‚‰ã‚¬ãƒãƒ£ã®æ™‚ã¨åŒæ§˜Goã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

```
mkdir -p pkg/grpc
make proto
```

### serviceå‡¦ç†

mainé–¢æ•°ã¯ã‚¬ãƒãƒ£ã¨ã»ã¨ã‚“ã©å¤‰ã‚ã‚‰ãªã„ãŸã‚çœç•¥ã—ã¾ã™ã€‚ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚’æº€ãŸã™ã‚ˆã†å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```go
type ItemServiceServer interface {
	GetItem(context.Context, *GetItemRequest) (*GetItemResponse, error)
	GetInventory(context.Context, *GetInventoryRequest) (*GetInventoryResponse, error)
	mustEmbedUnimplementedItemServiceServer()
}
```

```go:service.go
type itemServiceServer struct {
	itempb.UnimplementedItemServiceServer
	db *sql.DB
}

type Inventory struct {
	Id        int64
	UserId    int64
	ItemId    int64
	ItemName  string
	Rarity    string
	Count     int
	CreatedAt time.Time
}

func NewItemServiceServer(db *sql.DB) itempb.ItemServiceServer {
	return &itemServiceServer{
		db: db,
	}
}

func (s *itemServiceServer) GetItem(ctx context.Context, req *itempb.GetItemRequest) (*itempb.GetItemResponse, error) {
	// ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ‰€æŒã—ã¦ã„ã‚‹ã‹ç¢ºèª
	inventry, err := get(req.UserId, req.ItemId, s.db)
	if err = handleError(err); err != nil {
		return nil, err
	}

	// DBæ›´æ–°
	if inventry.Id == 0 {
		// æœªæ‰€æŒ
		if _, err = insert(req.UserId, req.ItemId, req.ItemName, req.Rarity.String(), s.db); err != nil {
			return nil, err
		}
	} else {
		// æ‰€æŒæ¸ˆã¿
		if err = update(req.UserId, req.ItemId, s.db); err != nil {
			return nil, err
		}
	}

	return &itempb.GetItemResponse{
		ItemId:   req.ItemId,
		ItemName: req.ItemName,
		Rarity:   req.Rarity,
		Count:    int32(inventry.Count) + 1,
	}, nil
}

func (i *itemServiceServer) GetInventory(ctx context.Context, req *itempb.GetInventoryRequest) (*itempb.GetInventoryResponse, error) {
	rows, err := getInventries(req.UserId, i.db)
	if err != nil {
		log.Printf("failed to get inventries: %v\n", err)
		return nil, err
	}

	inventories := make([]*itempb.InventoryItem, len(rows))
	for i, inventry := range rows {
		inventories[i] = &itempb.InventoryItem{
			ItemId:   inventry.ItemId,
			ItemName: inventry.ItemName,
			Rarity:   itempb.Rarity(itempb.Rarity_value[inventry.Rarity]),
			Count:    int32(inventry.Count),
		}
	}

	return &itempb.GetInventoryResponse{
		Items: inventories,
	}, nil
}
```

å‡¦ç†ã®æµã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™

```GetItem()```
- æŒ‡å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ æ‰€æŒæƒ…å ±ã‚’å–å¾—ã™ã‚‹ã€‚
- ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°æ–°è¦ã§å–å¾—ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ãªã®ã§ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã™ã‚‹ã€‚
- æ—¢ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¦ã„ã‚Œã°æ‰€æŒæ¸ˆã®ã‚¢ã‚¤ãƒ†ãƒ ãªã®ã§æ‰€æŒæ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã™ã‚‹ã€‚

```GetInventory()```
- æŒ‡å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ†ãƒ æ‰€æŒæƒ…å ±ã‚’å–å¾—ã—ã¦è¿”ã™ã€‚

ã“ã“ã§å®Ÿè£…ã—ãŸ```GetItem```é–¢æ•°ã‚’gacha-servceiã®æ–¹ã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

## API-Gatewayã®å®Ÿè£…

API-Gatewayã®å®Ÿè£…ã§ã¯gRPCé€šä¿¡ã®ä»–ã«å¤–éƒ¨ã¨ã®HTTPé€šä¿¡ãŒå¿…è¦ãªãŸã‚ä»Šå›ã¯```echo```ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
go mode init api-gateway
```

gRPCã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã®å®Ÿè£…ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ä»Šã¾ã§åŒæ§˜Goã®ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãŠãã¾ã™ã€‚

```
mkdir -p pkg/grpc
make proto
```

ã¾ãŸã€ä»Šå›ã¯```echo```ã‚’ä½¿ç”¨ã™ã‚‹ã®ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚‚ã—ã¦ãŠãã¾ã™ã€‚

```
go get github.com/labstack/echo/v4
```

### mainå‡¦ç†

echoã®ãƒ«ãƒ¼ãƒ†ã‚¤ãƒ³ã‚°è¨­å®šã‚’ã—ã¦ã€HTTPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```go:main.go
package main

import (
	"fmt"

	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

func main() {
	fmt.Println("API Gateway Start!!")
	// Echo instance
	e := echo.New()

	// Middleware
	e.Use(middleware.Logger())
	e.Use(middleware.Recover())

	// Routes
	e.POST("/draw", Draw)
	e.GET("/histories/:user_id", GetHistories)
	e.GET("/inventories/:user_id", GetInventories)
	e.GET("/test", func(c echo.Context) error {
		return c.String(200, "test")
	})

	defer func() {
		if itemConn != nil {
			itemConn.Close()
		}
		if gachaConn != nil {
			gachaConn.Close()
		}
	}()

	// Start server
	e.Logger.Fatal(e.Start(":8080"))
}
```

### gRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…

HTTPé€šä¿¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ãŸã‚‰ã€gRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚gRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ãŠã‚Šä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã¨ã—ã¾ã—ãŸã€‚

```go:gacha.go
package main

import (
	gachapb "api-gateway/pkg/grpc/proto"
	"context"
	"fmt"
	"log"
	"net/http"
	"os"
	"strconv"

	"github.com/labstack/echo/v4"
	"google.golang.org/grpc"
	"google.golang.org/grpc/credentials/insecure"
)

var (
	gachaClient gachapb.GachaServiceClient
	gachaConn   *grpc.ClientConn
)

func init() {
	if gachaClient != nil {
		return
	}

	host := os.Getenv("GACHA_SERVICE_HOST")
	if host == "" {
		log.Fatal("GACHA_SERVICE_HOST is not set")
	}

	var err error
	gachaConn, err = grpc.Dial(
		fmt.Sprintf("%s:%s", host, "8080"),
		grpc.WithTransportCredentials(insecure.NewCredentials()),
		grpc.WithBlock(),
	)
	if err != nil {
		panic(err)
	}

	gachaClient = gachapb.NewGachaServiceClient(gachaConn)
}

type DrawRequest struct {
	UserId int64 `json:"user_id"`
}

// /draw
func Draw(c echo.Context) error {
	dr := new(DrawRequest)
	if err := c.Bind(dr); err != nil {
		return err
	}

	req := &gachapb.DrawRequest{
		UserId: dr.UserId,
	}
	res, err := gachaClient.Draw(context.Background(), req)
	if err != nil {
		return err
	}
	return c.JSON(http.StatusOK, res)
}

func GetHistories(c echo.Context) error {
	p := c.Param("user_id")
	userId, err := strconv.ParseInt(p, 10, 64)
	if err != nil {
		return err
	}

	req := &gachapb.GetHistoriesRequest{
		UserId: userId,
	}
	res, err := gachaClient.GetHistories(context.Background(), req)
	if err != nil {
		return err
	}
	return c.JSON(http.StatusOK, res)
}

func CloseGachaConnection() error {
	if gachaConn != nil {
		return gachaConn.Close()
	}
	return nil
}
```

ä»Šå›ä½¿ç”¨ã—ã¦ã„ã‚‹gRPCã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ã™ã‚‹ãŸã‚ã®ãƒ›ã‚¹ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚„DBæƒ…å ±ãªã©ã¯ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ãŒã€ã“ã‚Œã¯å¾Œè¿°ã®Kubernetesã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã§ã‚³ãƒ³ãƒ†ãƒŠã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

item-serviceã®å®Ÿè£…ã¾ã§ç¢ºèªã—ãŸã„æ–¹ã¯ä»¥ä¸‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://github.com/JY8752/microservice-demo/tree/main/api-gateway

ã“ã‚Œã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å®Ÿè£…ã¯å®Œäº†ã§ã™ã€‚

## Minikubeã§Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®æ§‹ç¯‰

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å®Ÿè£…ãŒå®Œäº†ã—ãŸã®ã§Kuberneteså´ã®æ§‹ç¯‰ã‚’ã—ã¦ã„ãã¾ã™ã€‚ä»Šå›ã¯ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«æ§‹ç¯‰ã™ã‚‹ã®ã§Minikubeã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

ã¾ã ã€Minikubeã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã„æ–¹ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚Macã®æ–¹ã¯brewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```
brew install minikube
```

```

## Helmã§å„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

## ã¾ã¨ã‚

## å‚è€ƒ