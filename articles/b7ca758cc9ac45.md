---
title: "Google Analytics Data API + Cloud Functionsã§ãƒ–ãƒ­ã‚°ã®é–²è¦§ãƒ¬ãƒãƒ¼ãƒˆã‚’é€šçŸ¥ã™ã‚‹"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GoogleAnalytics", "CloudFunctions", "GCP", "Go", "slack"]
published: true
---

å…ˆæ—¥ä½œæˆã—ãŸå€‹äººãƒ–ãƒ­ã‚°ã®é–²è¦§æ•°ãŒçŸ¥ã‚ŠãŸã‹ã£ãŸã®ã§GoogleAnalyticsã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’Cloud Functionsã‚’ä½¿ç”¨ã—æœˆæœ«ã«slacké€šçŸ¥ã™ã‚‹ã‚ˆã†ã«ã—ãŸã®ã§ãã®å‚™å¿˜éŒ²ã§ã™ã€‚Cloud Functionsã¯Goã§ä½œæˆã—ã¦ã„ã¾ã™ã€‚Google Analyticsã¨Slackã¯ãã‚Œãã‚ŒGoã®SDKã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ãƒ–ãƒ­ã‚°ä½œæˆã—ãŸè©±ã¯ã“ã¡ã‚‰

https://zenn.dev/jy8752/articles/0b842e7f380fb8

## å¯¾è±¡èª­è€…

- Cloud Functionsã‚’ä½¿ã£ãŸã“ã¨ãŒãªã„æ–¹
- Google Analytics Data APIã‚’Goã§ä½¿ç”¨ã—ã¦ã¿ãŸã„æ–¹
- Cloud Functionsã‚’Goã§ä½œæˆã—ãŸã„æ–¹
- Slack APIã‚’Goã§ä½¿ç”¨ã—ã¦ä½•ã‹ã—ã‚‰ã®é€šçŸ¥ã‚’ã—ãŸã„æ–¹

## ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³

ã¾ã ä½•ã‚‚æ›¸ã„ã¦ã„ãªã„ã‘ã©é–²è¦§ã—ã¦ãã‚ŒãŸæ–¹ãŒã©ã®ãã‚‰ã„ã‹ã‚ã‹ã‚‰ãªã„ã¨æ›¸ããƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã«ãªã‚‰ãªã„ã®ã§ğŸ˜“

## GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæº–å‚™

### GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ

GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚gcloudã§ã‚‚ä½œæˆã§ãã¾ã™ãŒä»Šå›ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä½œæˆã—ã¾ã—ãŸã€‚

### gcloud

ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆãªã©ã¯gcloudã‚’ä½¿ç”¨ã—æ‰‹å…ƒã§ä½œæˆã—ãŸã‹ã£ãŸã®ã§ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚

```
gcloud config set project $GCP_PROJECT_ID
```

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦è¨­å®šã—ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€ãŸã¶ã‚“profileã¿ãŸã„ãªã®ã‚’ä½œæˆã§ãã‚‹ã¨æ€ã†ã®ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®šã—ãŸããªã„æ–¹ã¯èª¿ã¹ã¦ã¿ã¦ãã ã•ã„ğŸ™‡

### ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ

Cloud Functionsã«ç´ã¥ã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚Cloud FunctionsãŒGoogle Analytics Data APIã‚’å®Ÿè¡Œã§ãã‚‹æ¨©é™ãŒã‚ã‚Œã°ã„ã„ã¨æ€ã†ã®ã§ã™ãŒowneræ¨©é™ã§ä½œæˆã—ã¦ã¾ã™ã€‚

```
gcloud projects add-iam-policy-binding $GCP_PROJECT_ID \
		--member serviceAccount:"my-blog-service-account@$GCP_PROJECT_ID.iam.gserviceaccount.com" \
		--role "roles/owner" \
		--no-user-output-enabled
```

### APIã®æœ‰åŠ¹åŒ–

ä»¥ä¸‹ã®APIã‚’æœ‰åŠ¹åŒ–ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ã§ã¾ã¨ã‚ã¦æœ‰åŠ¹åŒ–ã—ã¦ãŠãã¾ã™ã€‚

```
  // cloud functions
	// Cloud Functionsã¯è£å´ã§Cloud Runã‚„Cloud BuildãŒå‹•ãã®ã§ãã‚Œã‚‰ã‚‚æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚
	gcloud services enable cloudfunctions.googleapis.com
	gcloud services enable run.googleapis.com
	gcloud services enable artifactregistry.googleapis.com
	gcloud services enable cloudbuild.googleapis.com

  // google analytics
  gcloud services enable analyticsdata.googleapis.com

  // cloudscheduler
  gcloud services enable cloudscheduler.googleapis.com
  gcloud services enable eventarc.googleapis.com
```

## æœˆé–“ã®é–²è¦§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’å–å¾—ã™ã‚‹(Google Analytics Data API)

Goã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã¾ãšã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’å–å¾—ã—ã¦ã„ãã¾ã™ã€‚ã»ã¼ã»ã¼ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

https://qiita.com/RikuRicky/items/f048d6f334fced826718

### Google Analytics Data APIã«ã¤ã„ã¦

Google Analyticsã®APIã¯[Google Analytics Data API(G4)](https://developers.google.com/analytics/devguides/reporting/data/v1?hl=ja)ã¨ãã‚Œä»¥å‰ã¾ã§ä½¿ã‚ã‚Œã¦ã„ãŸ[Universal Analytics(G3)](https://developers.google.com/analytics/devguides/reporting/core/v3/reference?hl=ja)ãŒã‚ã‚Šã¾ã™ã€‚G3ã¯ã‚µãƒãƒ¼ãƒˆãŒçµ‚äº†ã™ã‚‹äºˆå®šãªã®ã§ã“ã‚Œã‹ã‚‰ä½¿ç”¨ã™ã‚‹ãªã‚‰G4ã®æƒ…å ±ã‚’è¿½ãˆã°è‰¯ã•ãã†ã§ã™ã€‚ç§ãŒä½œæˆã—ãŸãƒ–ãƒ­ã‚°ã«åŸ‹ã‚è¾¼ã‚“ã Google Analyticsã¯G4ã§å¯¾å¿œã—ã¦ã„ãŸã‚ˆã†ãªã®ã§ä»Šå›ã¯Google Analytics Data APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### Google Analyticsã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹

Google Analyticsã®ãƒ¬ãƒãƒ¼ãƒˆã—ãŸã„ã‚µã‚¤ãƒˆã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãã€ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚å·¦ä¸‹ã«ã‚ã‚‹ã€Œç®¡ç† > ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç† > ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã€ã‚’é¸æŠã—ã€ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ­ãƒ¼ãƒ«ã‚’ç®¡ç†è€…ã«è¨­å®šã—ã¦è¿½åŠ ã‚’æŠ¼ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

### Goãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä»¥ä¸‹ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
go get google.golang.org/api/analyticsdata/v1beta
go get google.golang.org/api/option
```

è©³ç´°çŸ¥ã‚ŠãŸã„æ–¹ã¯ä»¥ä¸‹ã®Goã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¬ãƒã‚¸ãƒˆãƒªã‚’è¦‹ã¦ã‚‚ã„ã„ã‹ã‚‚ã§ã™ã€‚

https://github.com/googleapis/google-api-go-client

```google.golang.org/api/option```ã¯èªè¨¼ã‚’é€šã™ã®ã«ä½¿ç”¨ã—ã€```google.golang.org/api/analyticsdata/v1beta```ã¯APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚

### èªè¨¼

ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜

```go
	// èªè¨¼
	base64Credential := os.Getenv("GOOGLE_CREDENTIAL")
	jsonCredential, err := base64.StdEncoding.DecodeString(base64Credential)
	if err != nil {
		fmt.Println(err.Error())
		return err
	}

	client, err := ga.NewService(ctx, option.WithCredentialsJSON(jsonCredential))

	if err != nil {
		fmt.Println(err.Error())
		return err
	}
```

ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼JSONã‚’GCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã®ã§ã€ãã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’```option.WithCredentialsFile()```ã«æŒ‡å®šã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã€ä»Šå›Cloud Functionsã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã®ã§èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚ãŸããªã‹ã£ãŸã®ã§ä»–ã«ã„ã„ã‚„ã‚Šæ–¹ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒä»Šå›ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’base64ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ãã®ã¾ã¾æ¸¡ã—ã¦ã„ã¾ã™ã€‚ãã—ã¦ã€base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦```option.WithCredentialsJSON()```ã®å¼•æ•°ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§èªè¨¼ã‚’é€šã—ã¦ã„ã¾ã™ã€‚

ãŸã¶ã‚“ã€æœ¬å½“ã¯GCPã®Secretã‚’ä½¿ç”¨ã—ãŸã»ã†ãŒã„ã„ã§ã™ã€‚

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹

ã“ã‚“ãªæ„Ÿã˜

```go
	// Google Analytics APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
	runReportRequest := &ga.RunReportRequest{
		DateRanges: []*ga.DateRange{
			{StartDate: startDate, EndDate: "today"}, // æœˆé–“
		},
		Dimensions: []*ga.Dimension{
			{Name: "pageTitle"},
		},
		Metrics: []*ga.Metric{
			{Name: "activeUsers"},
		},
		Limit: reportCount,
	}

	// ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
	propertyId := os.Getenv("BLOG_PROPERTY_ID")
	res, err := client.Properties.RunReport(fmt.Sprintf("properties/%s", propertyId), runReportRequest).Do() // XXXXXXXXX ã®éƒ¨åˆ†ã« property id ãŒå…¥ã‚‹
	if err != nil {
		fmt.Println(err.Error())
		return err
	}

	if bytes, err := res.MarshalJSON(); err == nil {
		fmt.Println(string(bytes))
	}

	// å–å¾—ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã ã‘æŠ½å‡º
	monthlyReports := make([]Report, 0, reportCount)
	for _, row := range res.Rows {
		if len(row.DimensionValues) != 1 {
			continue
		}

		if len(row.MetricValues) != 1 {
			continue
		}

		monthlyReports = append(monthlyReports, Report{row.DimensionValues[0].Value, row.MetricValues[0].Value})
	}
```

```ga.RunReportRequest```ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’ä½œæˆã—ã€```client.Properties.RunReport```ã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

- DateRanges å–å¾—ã™ã‚‹æœŸé–“ã‚’è¨­å®šã—ã¾ã™ã€‚```today```ã‚„```NdaysAgo```ã¨ã„ã£ãŸã‚ˆã†ã«æ–‡å­—åˆ—ã§æŒ‡å®šã—ã¾ã™ã€‚æœŸé–“ã¯è¤‡æ•°æŒ‡å®šå¯èƒ½ã§ã™ãŒ4ã¤ã¾ã§ã®æŒ‡å®šã—ã‹ã§ããšã€5ã¤ä»¥ä¸ŠæŒ‡å®šã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã¨ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚(ãã‚Œã«ã¤ã„ã¦æ›¸ã‹ã‚Œã¦ã„ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãƒ‘ãƒƒã¨è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã®ã§é–“é•ã£ã¦ã„ãŸã‚‰ã™ã¿ã¾ã›ã‚“ã€‚)è©³ã—ãã¯[ã“ã¡ã‚‰](https://developers.google.com/analytics/devguides/reporting/data/v1/rest/v1beta/DateRange?hl=ja)

- Dimensions å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å±æ€§ã§ã™ã€‚ä»Šå›ã¯ã©ã®ãƒšãƒ¼ã‚¸ã‹ã‚ã‹ã‚‹ã ã‘ã§ã„ã„ã®ã§```pageTitle```ã ã‘æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚è©³ã—ãã¯[ã“ã¡ã‚‰](https://developers.google.com/analytics/devguides/reporting/data/v1/rest/v1beta/Dimension?hl=ja)

- Metrics ãƒ¬ãƒãƒ¼ãƒˆã®å®šé‡çš„ãªæ¸¬å®šå€¤ã‚’æŒ‡å®šã§ãã¾ã™ã€‚ä»Šå›ã¯```activeUsers```ã ã‘æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚è©³ã—ãã¯[ã“ã¡ã‚‰](https://developers.google.com/analytics/devguides/reporting/data/v1/api-schema?hl=ja#metrics)

- ãã®ä»– ä»Šå›ã¯```Limit```ã ã‘æŒ‡å®šã—ã¦å–å¾—ä»¶æ•°ã‚’çµã‚Šã¾ã—ãŸã€‚è©³ã—ãã¯[ã“ã¡ã‚‰](https://developers.google.com/analytics/devguides/reporting/data/v1/basics#pagination)

```RunReport```ã®ç¬¬ä¸€å¼•æ•°ã«ã¯```properties/<property_id>```ã®å½¢å¼ã§æ–‡å­—åˆ—ã§æŒ‡å®šã—ã¾ã™ã€‚property_idã¯Google Analyticsã®ç®¡ç†ç”»é¢ãªã©ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚

å–å¾—ã¯Goã®æ§‹é€ ä½“ã¨ã—ã¦æ‰±ã†ã“ã¨ã‚‚ã§ãã¾ã™ã—ã€JSONã¨ã—ã¦æ‰±ã†ã“ã¨ã‚‚ã§ãã¾ã™ãŒä»Šå›ã¯æ§‹é€ ä½“ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã ã‘æŠ½å‡ºã—ã¾ã—ãŸã€‚

## Slackã§é€šçŸ¥ã™ã‚‹

ä»Šå›ã¯SlackãŒå…¬é–‹ã—ã¦ã„ã‚‹```slack-go```ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```
go get -u github.com/slack-go/slack
```

ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸ

https://zenn.dev/kou_pg_0131/articles/go-slack-go-usage

```go
	// slackã¸ã®é€šçŸ¥
	tkn := os.Getenv("SLACK_TOKEN")
	sc := slack.New(tkn)

	var sections []slack.Block

	// Header Section
	headerText := slack.NewTextBlockObject("mrkdwn", fmt.Sprintf("*MyBlog Google Analytics [%dæœˆ] æœˆé–“ãƒ¬ãƒãƒ¼ãƒˆ*\n", int(now.Month())), false, false)
	headerSection := slack.NewSectionBlock(headerText, nil, nil)
	sections = append(sections, headerSection)

	// æœˆé–“ãƒ¬ãƒãƒ¼ãƒˆ
	sections = append(sections, slack.NewSectionBlock(slack.NewTextBlockObject("mrkdwn", "*æœˆé–“*ğŸš€", false, false), nil, nil))
	for _, report := range monthlyReports {
		txt := slack.NewTextBlockObject("mrkdwn", fmt.Sprintf("*%s*\nã‚¢ã‚¯ã‚»ã‚¹æ•°: %s", report.PageTitle, report.ActiveUsers), false, false)
		sections = append(sections, slack.NewSectionBlock(txt, nil, nil))
	}

	// slacké€ä¿¡
	channelId := os.Getenv("SLACK_CHANNEL_ID")
	_, _, err = sc.PostMessage(channelId, slack.MsgOptionBlocks(
		sections...,
	))
```

ã¾ãšã€Slackã®APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã‚’ã—ã¾ã™ã€‚Slackã®APIãƒˆãƒ¼ã‚¯ãƒ³ã¯Slackã®APIãƒšãƒ¼ã‚¸ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚

```slack.NewSectionBlock```ã«```slack.NewTextBlockObject```ã‚’æŒ‡å®šã—ã¦ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚ä»Šå›ã¯ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã¨å–å¾—ã—ãŸãƒšãƒ¼ã‚¸ã”ã¨ã®ã‚¢ã‚¯ã‚»ã‚¹æ•°ã”ã¨ã«ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã—ã¦sliceã«æ ¼ç´ã—ã¦ãŠãã¾ã™ã€‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚„ãƒ–ãƒ­ãƒƒã‚¯ã«ã¤ã„ã¦ã¯ä»–ã«ã‚‚ã„ã‚ã„ã‚ã‚ã£ã¦ãƒªãƒƒãƒãªãƒ‡ã‚¶ã‚¤ãƒ³ã®é€šçŸ¥ã‚‚ã§ãã‚‹ã®ã§èˆˆå‘³ãŒã‚ã‚‹ã‹ãŸã¯slack-goã®[Example](https://github.com/slack-go/slack/tree/master/examples)ãŒå‚è€ƒã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã‚ã¨ã¯```PostMessage```ã«é€šçŸ¥ã—ãŸã„slackãƒãƒ£ãƒ³ãƒãƒ«ã®IDã¨æ ¼ç´ã—ã¦ãŠã„ãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¸¡ã™ã“ã¨ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€šçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## Pub/Subã®ä½œæˆ

ä½œæˆã—ãŸé–¢æ•°ã¯æ¯æœˆæœˆæœ«ã«é€šçŸ¥ã•ã‚Œã‚‹ã‚ˆã†ã«å®šæœŸå®Ÿè¡Œã—ã¾ã™ã€‚Cloud Functionsã‚’å®šæœŸå®Ÿè¡Œã™ã‚‹ã«ã¯GCPã®Pub/Subã¨Cloud Schedulerã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚ã¾ãšPub/Subã®ä½œæˆ

```
gcloud pubsub topics create <ãƒˆãƒ”ãƒƒã‚¯å>
```

## Cloud Scheduler

æ¬¡ã«ä½œæˆã—ãŸPub/Subã®ãƒˆãƒ”ãƒƒã‚¯åã‚’æŒ‡å®šã—ã¦Cloud Schedulerã‚’ä½œæˆã—ã¾ã™ã€‚

```
gcloud scheduler jobs create pubsub <ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å> \
--schedule="23 59 28-31 * *" \ // cronè¨­å®š
--topic=<ãƒˆãƒ”ãƒƒã‚¯å> \ // ä½œæˆã—ãŸPub/Subã®ãƒˆãƒ”ãƒƒã‚¯å
--message-body="{}" \ // ä½•ã‹æ¸¡ã—ãŸã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ãªã©ã‚ã‚Œã°
--time-zone=Asia/Tokyo \
--location=asia-northeast1
```

## Pub/Subã®ç™»éŒ²ã¨æœˆæœ«å®Ÿè¡Œã®å‡¦ç†

cronã®è¨­å®šã§ã™ãŒæœˆæœ«å®Ÿè¡Œãªã®ã§28-31æ—¥ã®ç¯„å›²ã«ãªã£ã¦ã—ã¾ã„ã€æ—¥ã«ã¡ã‚’æŒ‡å®šã§ããªã„ã®ã§28-31æ—¥ã§æ¯æ—¥å®Ÿè¡Œã—æ¬¡ã®æ—¥ãŒ1æ—¥ã§ã‚ã‚Œã°å®Ÿè¡Œã™ã‚‹ã‚ˆã†ãªå‡¦ç†ã‚’é–¢æ•°ã«ã„ã‚Œã‚‹ã“ã¨ã§æœˆæœ«ã«é€šçŸ¥ãŒé£›ã¶ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ä»Šå›ã¯Pub/Subãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚‹é–¢æ•°å®Ÿè¡Œãªã®ã§é–¢æ•°ã‚‚ãã‚Œã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ä¿®æ­£ã—ã¾ã™ã€‚

### Pub/Subã®å¯¾å¿œ

```
go get github.com/cloudevents/sdk-go/v2/event
go get github.com/GoogleCloudPlatform/functions-framework-go/functions
```

```go
func init() {
	functions.CloudEvent("BlogNotify", BlogNotify)
}

func BlogNotify(ctx context.Context, e event.Event) error {
```

### æœˆæœ«å®Ÿè¡Œã®å‡¦ç†

```go
	loc, err := time.LoadLocation("Asia/Tokyo")
	if err != nil {
		fmt.Println(err.Error())
		return err
	}
	now := time.Now().In(loc)
	addOneDay := now.AddDate(0, 0, 1)

	// æ¬¡ã®æ—¥ä»˜ãŒ1æ—¥ã§ãªã‘ã‚Œã°æœˆæœ«ã§ã¯ãªã„ã®ã§å‡¦ç†ã‚’çµ‚äº†ã™ã‚‹
	if addOneDay.Day() != 1 {
		fmt.Println("æœˆæœ«ã§ã¯ãªã„ã®ã§å‡¦ç†ã‚’skipã—ã¾ã™ã€‚")
		return nil
	}

	// å®Ÿè¡Œã—ãŸæ—¥ã«ã¡ã§ä½•æ—¥å‰ã¾ã§ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’å–å¾—ã™ã‚‹ã‹ã‚’æ±ºã‚ã‚‹
	var startDate string
	switch now.Day() {
	case 28:
		startDate = "27daysAgo"
	case 29:
		startDate = "28daysAgo"
	case 30:
		startDate = "29daysAgo"
	case 31:
		startDate = "30daysAgo"
	default:
		startDate = "28daysAgo"
	}

```

## Cloud Functionsã®ãƒ‡ãƒ—ãƒ­ã‚¤

ã“ã“ã¾ã§ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹é–¢æ•°ãŒå®Œæˆã—ãŸã®ã§Cloud Functionsã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

:::details é–¢æ•°ã®å…¨æ–‡ã¯ã“ã¡ã‚‰
```go:notify.go
package notifyanalytics

import (
	"context"
	"encoding/base64"
	"fmt"
	"os"
	"time"

	"github.com/GoogleCloudPlatform/functions-framework-go/functions"
	"github.com/cloudevents/sdk-go/v2/event"
	"github.com/slack-go/slack"
	ga "google.golang.org/api/analyticsdata/v1beta"
	"google.golang.org/api/option"
)

const (
	reportCount = 3
)

type Report struct {
	PageTitle   string `json:"pageTitle"`
	ActiveUsers string `json:"activeUsers"`
}

func init() {
	functions.CloudEvent("BlogNotify", BlogNotify)
}

func BlogNotify(ctx context.Context, e event.Event) error {
	loc, err := time.LoadLocation("Asia/Tokyo")
	if err != nil {
		fmt.Println(err.Error())
		return err
	}
	now := time.Now().In(loc)
	addOneDay := now.AddDate(0, 0, 1)

	debugMode := os.Getenv("DEBUG_MODE")
	isDebug := debugMode != ""

	// æ¬¡ã®æ—¥ä»˜ãŒ1æ—¥ã§ãªã‘ã‚Œã°æœˆæœ«ã§ã¯ãªã„ã®ã§å‡¦ç†ã‚’çµ‚äº†ã™ã‚‹
	if addOneDay.Day() != 1 && !isDebug {
		fmt.Println("æœˆæœ«ã§ã¯ãªã„ã®ã§å‡¦ç†ã‚’skipã—ã¾ã™ã€‚")
		return nil
	}

	// èªè¨¼
	base64Credential := os.Getenv("GOOGLE_CREDENTIAL")
	jsonCredential, err := base64.StdEncoding.DecodeString(base64Credential)
	if err != nil {
		fmt.Println(err.Error())
		return err
	}

	client, err := ga.NewService(ctx, option.WithCredentialsJSON(jsonCredential))

	if err != nil {
		fmt.Println(err.Error())
		return err
	}

	var startDate string
	switch now.Day() {
	case 28:
		startDate = "27daysAgo"
	case 29:
		startDate = "28daysAgo"
	case 30:
		startDate = "29daysAgo"
	case 31:
		startDate = "30daysAgo"
	default:
		startDate = "28daysAgo"
	}

	fmt.Println("startDate: ", startDate)

	// Google Analytics APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
	runReportRequest := &ga.RunReportRequest{
		DateRanges: []*ga.DateRange{
			{StartDate: startDate, EndDate: "today"}, // æœˆé–“
		},
		Dimensions: []*ga.Dimension{
			{Name: "pageTitle"},
		},
		Metrics: []*ga.Metric{
			{Name: "activeUsers"},
		},
		Limit: reportCount,
	}

	// ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
	propertyId := os.Getenv("BLOG_PROPERTY_ID")
	res, err := client.Properties.RunReport(fmt.Sprintf("properties/%s", propertyId), runReportRequest).Do() // XXXXXXXXX ã®éƒ¨åˆ†ã« property id ãŒå…¥ã‚‹
	if err != nil {
		fmt.Println(err.Error())
		return err
	}

	if bytes, err := res.MarshalJSON(); err == nil {
		fmt.Println(string(bytes))
	}

	// å–å¾—ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã ã‘æŠ½å‡º
	monthlyReports := make([]Report, 0, reportCount)
	for _, row := range res.Rows {
		if len(row.DimensionValues) != 1 {
			continue
		}

		if len(row.MetricValues) != 1 {
			continue
		}

		monthlyReports = append(monthlyReports, Report{row.DimensionValues[0].Value, row.MetricValues[0].Value})
	}

	// slackã¸ã®é€šçŸ¥
	tkn := os.Getenv("SLACK_TOKEN")
	sc := slack.New(tkn)

	var sections []slack.Block

	// Header Section
	headerText := slack.NewTextBlockObject("mrkdwn", fmt.Sprintf("*MyBlog Google Analytics [%dæœˆ] æœˆé–“ãƒ¬ãƒãƒ¼ãƒˆ*\n", int(now.Month())), false, false)
	headerSection := slack.NewSectionBlock(headerText, nil, nil)
	sections = append(sections, headerSection)

	// æœˆé–“ãƒ¬ãƒãƒ¼ãƒˆ
	sections = append(sections, slack.NewSectionBlock(slack.NewTextBlockObject("mrkdwn", "*æœˆé–“*ğŸš€", false, false), nil, nil))
	for _, report := range monthlyReports {
		txt := slack.NewTextBlockObject("mrkdwn", fmt.Sprintf("*%s*\nã‚¢ã‚¯ã‚»ã‚¹æ•°: %s", report.PageTitle, report.ActiveUsers), false, false)
		sections = append(sections, slack.NewSectionBlock(txt, nil, nil))
	}

	// slacké€ä¿¡
	channelId := os.Getenv("SLACK_CHANNEL_ID")
	_, _, err = sc.PostMessage(channelId, slack.MsgOptionBlocks(
		sections...,
	))

	if err != nil {
		fmt.Println(err.Error())
		return err
	}

	return nil
}
```
:::

```
	gcloud functions deploy <functionå> \
	--entry-point=BlogNotify \
	--region=asia-northeast1 \
	--runtime=go120 \
	--memory=128Mi \
	--env-vars-file=.env.yaml \
	--allow-unauthenticated \
	--gen2 \
	--run-service-account="${SERVICE_ACCOUNT_EMAIL}" \
	--service-account="${SERVICE_ACCOUNT_EMAIL}" \
	--trigger-topic=<Pub/Subã®ãƒˆãƒ”ãƒƒã‚¯å>
```

ç’°å¢ƒå¤‰æ•°ã¯```.env.yaml```ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¼‰ã—ã¦æ¸¡ã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯.gitignoreã«è¨˜è¼‰ã—ã¦pushã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€Cloud Functionsã«ä¸Šã’ãŸããªã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯```.gcloudignore```ã«è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ€ä½é™æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

```:.gcloudignore
*_test.go

.env
.env.yaml
.envrc

Makefile
```

ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ãŸã‚‰Cloud Schedulerã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã‚’é–‹ãå¼·åˆ¶å®Ÿè¡Œã—ã¦ã¡ã‚ƒã‚“ã¨é–¢æ•°ãŒå®Ÿè¡Œã•ã‚ŒSkacké€šçŸ¥ã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚å•é¡Œãªãå®Ÿè¡Œã•ã‚Œã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªSlacké€šçŸ¥ãŒã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/46d0dcdd5c8c-20230417.png)

## ãƒãƒã£ãŸã¨ã“ã‚

### Cloud Functionsã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ãƒ“ãƒ«ãƒ‰ãŒã“ã‘ã‚‹

Goã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åãŒã¡ã‚ƒã‚“ã¨ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å½¢å¼ã«ãã£ã¦ãªã„ã¨ãƒ“ãƒ«ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€‚ã‚ã‚“ã¾ã‚Šå…¬é–‹ã™ã‚‹ã‚ˆã†ãªã‚‚ã®ä½œã£ã¦ã„ãªã„ã®ã§ã¡ã‚ƒã‚“ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã¤ã‘ã¦ãªã‹ã£ãŸã®ã§ã¡ã‚ƒã‚“ã¨ã¤ã‘ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚

```
ERROR: (gcloud.functions.deploy) OperationError: code=3, message=Build failed with status: FAILURE and message: the module path in the function's go.mod must contain a dot in the first path element before a slash, e.g. example.com/module, found: test. For more details see the logs at https://console.cloud.google.com/cloud-build/builds;region=asia-northeast1/8563c2d5-6004-4ee5-825c-e9c58af32dd6?project=956708463040.
```

```
NG test
OK github.com/JY8752/test
```

## ã¾ã¨ã‚

Cloud Functionsã‚’åˆã‚ã¦ä½¿ã£ãŸã®ã§ã™ãŒæ…£ã‚Œã‚Œã°ã‹ãªã‚Šç°¡å˜ã«ä½¿ãˆãã†ã ãªã¨æ€ã„ã¾ã—ãŸã€‚æœ€åˆãƒ“ãƒ«ãƒ‰ã¯è‡ªåˆ†ã§ã™ã‚‹ã®ã‹ã¨æ€ã£ã¦ãƒ“ãƒ«ãƒ‰ã—ãŸå®Ÿè¡Œãƒã‚¤ãƒŠãƒªã‚’zipåŒ–ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã„ã†è¬ãªã“ã¨ã—ã¦ã¯ã¾ã£ãŸã‚“ã§ã™ãŒã€è£å´ã§ãƒ“ãƒ«ãƒ‰ã—ã¦ãã‚Œã¦ã‚‹ã‚“ã§ã™ã­ã€‚ã‚ã¡ã‚ƒãã¡ã‚ƒä¾¿åˆ©ã€‚

ä»¥ä¸Šã€Cloud Functionsã‚’å®šæœŸå®Ÿè¡Œã—ã¦æœˆé–“ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚’Slackã«é€šçŸ¥ã™ã‚‹æ–¹æ³•ã§ã—ãŸã€‚

ä»Šå›ä½œã£ãŸå…¨ã¦ã®æˆæœç‰©ã¯ã“ã¡ã‚‰

https://github.com/JY8752/my-blog/tree/main/gcp