---
title: "Cloud Buildã‹ã‚‰Cloud Runã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ãã®ç’°å¢ƒå¤‰æ•°ã®è¨­å®šæ–¹æ³•ã«ã¤ã„ã¦"
emoji: "ğŸš´"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["googlecloud", "gcp", "cloudrun", "cloudbuild"]
published: true
---

æœ€è¿‘ã€ã‚„ã£ã¨Cloud Runã‚’ä½¿ã„å§‹ã‚ãŸã®ã§ã™ãŒã€Cloud Buildã®æ§‹æˆã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ç’°å¢ƒå¤‰æ•°ã‚’ã„ã„æ„Ÿã˜ã«Cloud Runã«è¨­å®šã™ã‚‹æ–¹æ³•ãŒæ„å¤–ã¨è¦‹ã¤ã‹ã‚‰ãªæ–¹ã®ã§å‚™å¿˜éŒ²ã§ã™ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãª```cloudbuild.yaml```ãŒã‚ã‚‹ã¨ã—ã¦ã€ã“ã®ä¸­ã§Cloud Runã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

```yaml:cloudbuild.yaml
steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE}', '.' ]
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'push', '${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE}' ]
  - name: 'gcr.io/cloud-builders/gcloud'
    args: 
      - run
      - deploy
      - ${_SERVICE}
      - --image
      - ${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE}
      - --platform
      - managed
      - --region
      - ${_REGION}
      - --allow-unauthenticated
substitutions:
  _LOCATION: asia-northeast1
  _REPOSITORY: my-repository
  _IMAGE: my-image
  _SERVICE: my-service
  _REGION: asia-northeast1
timeout: 1200s
```


## æœ€åˆã«çµè«–

- Secret Managerã‚’ä½¿ã†
- ```--set-secrets```ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†

## ```--set-env-vars```,```--update-env-vars```ãŒä½¿ãˆãã†

æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ç’°å¢ƒå¤‰æ•°ã‚’ç›´æ¥æ›¸ããŸãã¯ãªã„ã¨æ€ã†ã®ã§ä½•ã‹ã—ã‚‰ã®æ–¹æ³•ã§ç’°å¢ƒå¤‰æ•°ã®å€¤ã‚’ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§æ‰±ã„ãŸã„ã®ã§ã™ãŒã€Secret Managerã‚’ä½¿ã†ã®ãŒ1ç•ªå®Ÿç”¨çš„ã§ã—ã‚‡ã†ã€‚Secret Managerã«è¨­å®šã—ãŸå€¤ã‚’æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«å†…ã§Cloud Runã«è¨­å®šã™ã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```yaml
steps:
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args: 
      - -c
      - |
        gcloud run deploy ${_SERVICE} \
          --image ${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE} \
          --platform managed \
          --region ${_REGION} \
          --allow-unauthenticated \
          --set-env-vars "FOO_BAR=$$FOO_BAR"
    secretEnv: ['FOO_BAR']
availableSecrets:
  secretManager:
    - versionName: projects/example/secrets/FOO_BAR/versions/1
      env: FOO_BAR
```

ã“ã‚Œã§Secret Managerã®å€¤ã‚’Cloud Runã«è¨­å®šã™ã‚‹ã“ã¨ã¯ã§ãã‚‹ãŒã€è¨­å®šã™ã‚‹ç’°å¢ƒå¤‰æ•°ã®æ•°ãŒå¤šããªã‚‹ã¨ã‹ãªã‚Šå†—é•·ã«ãªã‚‹ã—ã€è¨˜è¼‰æ¼ã‚ŒãŒå‡ºãã†ã€‚

ã¡ãªã¿ã«ã€ä¸Šè¨˜ã®ã‚ˆã†ã«ã—ã¦Secret Managerã®å€¤ã‚’ä½¿ã†ã«ã¯```entrypoint```ã«```bash```ã‚’æŒ‡å®šã—ã¦ã€```bash -c '...'```ã®å½¢å¼ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

## ```--env-vars-file```ã¨ã„ã†ã®ã‚‚ã‚ã‚‹ã‚‰ã—ã„

yamlãƒ•ã‚¡ã‚¤ãƒ«ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã€ãã‚Œã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‚‰ã—ã„ã€‚ã—ã‹ã—ã€çµå±€yamlãƒ•ã‚¡ã‚¤ãƒ«ã«ç§˜åŒ¿æƒ…å ±ã‚’æ›¸ã„ã¦ã—ã¾ã£ã¦ã¯GitHubã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚‚ã§ããªã„ã—ã€ãƒ¡ãƒ³ãƒãƒ¼é–“ã§å…±æœ‰ã™ã‚‹ã®ã‚‚é›£ã—ã„ã®ã§ã‚„ã¯ã‚ŠSecret Managerã‚’ä½¿ã„ãŸã„ã€‚

## ```--set-secrets```ã‚’ä½¿ã„ã¾ã—ã‚‡ã†

ã‚„ã‚„ã“ã—ã„ã“ã¨ã‚’ã›ãš```--set-secrets```ã‚’ä½¿ã†ã“ã¨ã§ç›´æ¥Secret Managerã®å€¤ã‚’Cloud Runã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

```yaml
steps:
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args: 
      - -c
      - |
        gcloud run deploy ${_SERVICE} \
          --image ${_LOCATION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE} \
          --platform managed \
          --region ${_REGION} \
          --allow-unauthenticated \
          --set-secrets="FOO_BAR=FOO_BAR:latest"
```

æŒ‡å®šã™ã‚‹ç’°å¢ƒå¤‰æ•°ã®åˆ†ã ã‘```--set-secrets```ã‚’æŒ‡å®šã™ã‚‹ã€‚æ•°ãŒå¤šããªã‚‹ã¨å¤§å¤‰ã ã‘ã©ä»–ã®æ–¹æ³•ã‚ˆã‚Šã¯ãƒã‚·ã§ã—ã‚‡ã†ã€‚

## ãŠã‚ã‚Šã«

Cloud Runã«DBã®æƒ…å ±ã®ã‚ˆã†ãªç§˜åŒ¿æƒ…å ±ã‚’è¨­å®šã—ãŸã„å ´åˆã¯Secret Managerã‚’ä½¿ã†ã®ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚ãã—ã¦ã€Cloud Runã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«Cloud Buildã‚’ä½¿ã†å ´åˆã¯```--set-secrets```ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§Secret Managerã®å€¤ã‚’Cloud Runã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

Cloud Buildã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«Secret Managerã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒå¿…è¦ãªã®ã§ãã‚Œã ã‘æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã¡ãªã¿ã«ã€ã‘ã£ã“ã†ãƒãƒƒãƒˆã®æƒ…å ±ã‚’æ¼ã£ãŸã‚“ã§ã™ãŒæ™®é€šã«å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚

https://cloud.google.com/run/docs/configuring/secrets?hl=ja#command-line

ãã‚Œã«ã—ã¦ã‚‚ã“ã‚“ãªã«ãƒ‡ãƒ—ãƒ­ã‚¤ç°¡å˜ã«ã§ãã‚‹ãªã‚“ã¦Cloud Runä¾¿åˆ©ã™ãã‚‹ã€‚

ä»Šå›ã¯ä»¥ä¸Šã§ã™ğŸ¼
