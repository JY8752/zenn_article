---
title: "Goã«ãŠã‘ã‚‹DBãƒ†ã‚¹ãƒˆ dockertest vs testcontainers æ¯”è¼ƒã—ã¦ã¿ãŸ"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go", "dockertest", "testcontainers", "docker", "test"]
published: true
---

Javaã‚„Kotlinã‚’æ›¸ã„ã¦ã„ãŸã¨ãã«testcontainersã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒéå¸¸ã«ä¾¿åˆ©ã ã£ãŸã®ã§Goã§ã‚‚ä½¿ãŠã†ã¨æ€ã£ãŸã‚‰dockertestã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚ã‚‹ã‚ˆã†ã§ã©ã£ã¡ä½¿ã£ãŸã‚‰ã„ã„ã®ã‹ã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§ã©ã£ã¡ã‚‚ä½¿ã£ã¦æ¯”è¼ƒã—ã¦ã¿ãŸã®ã§ãã®å‚™å¿˜éŒ²ã§ã™ã€‚

ä»Šå›ã¯DBã«mongoã‚’ä½¿ç”¨ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ãªUseRepositoryã®ãƒ†ã‚¹ãƒˆã‚’testcontainersãŠã‚ˆã³dockertestã§æ›¸ã„ã¦ã¿ã¾ã™ã€‚UserRepositoryã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã¨Idã§ã®æ¤œç´¢ã®2ã¤ã®é–¢æ•°ã‚’æŒã¤ã“ã¨ã¨ã—ã¾ã™ã€‚

```go:user.go
package datastore

import (
	"JY8752/demo-app/constant"
	model "JY8752/demo-app/domain/model/user"
	repository "JY8752/demo-app/domain/repository/user"
	applicationerror "JY8752/demo-app/error"
	datastore "JY8752/demo-app/infrastructure/datastore/mongo"
	"context"
	"fmt"
	"time"

	"go.mongodb.org/mongo-driver/bson"
	"go.mongodb.org/mongo-driver/bson/primitive"
)

const COLLECTION_NAME = "Users"

type user struct {
	Id        primitive.ObjectID `bson:"_id"`
	Name      string             `bson:"nm"`
	UpdatedAt time.Time          `bson:"updAt"`
	CreatedAt time.Time          `bson:"crtAt"`
}

type userRepository struct {
	client *datastore.MongoClient
}

func NewUserRepository(client *datastore.MongoClient) repository.UserRepository {
	return &userRepository{client: client}
}

func (u *userRepository) Create(ctx context.Context, name string, time time.Time) (string, error) {
	doc := &user{Id: primitive.NewObjectID(), Name: name, UpdatedAt: time, CreatedAt: time}
	result, err := u.client.GetDB(constant.MONGO_MAIN_DB).Collection(COLLECTION_NAME).InsertOne(ctx, doc)

	if err != nil {
		return "", applicationerror.NewApplicationError("Fail create user.", err)
	}

	if oid, ok := result.InsertedID.(primitive.ObjectID); ok {
		return oid.Hex(), nil
	}

	return "", applicationerror.NewApplicationError(fmt.Sprintf("Fail cast to objectId. result: %v\n", result), nil)
}

func (u *userRepository) FindById(ctx context.Context, id string) (*model.User, error) {
	oid, err := primitive.ObjectIDFromHex(id)
	if err != nil {
		return nil, applicationerror.NewApplicationError(fmt.Sprintf("argument id is not ObjectId. id: %s\n", id), err)
	}

	filter := bson.D{{Key: "_id", Value: oid}}
	var user user
	if err := u.client.GetDB(constant.MONGO_MAIN_DB).Collection(COLLECTION_NAME).FindOne(ctx, filter).Decode(&user); err != nil {
		return nil, applicationerror.NewApplicationError(fmt.Sprintf("Fail findById id: %s\n", id), err)
	}

	return &model.User{
		Id:        user.Id.Hex(),
		Name:      user.Name,
		UpdatedAt: user.UpdatedAt,
		CreatedAt: user.CreatedAt,
	}, nil
}
```

# testcontainersã¨ã¯

https://golang.testcontainers.org/

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¸Šã§ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ãƒ»åœæ­¢ã¾ã§è¡Œã„ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã§ãã‚‹Javaã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚Javaã ã‘ã§ãªãPython, Node, Rustãªã©ã§ã‚‚æä¾›ã•ã‚Œã¦ãŠã‚ŠGoã§ã‚‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚testcontainersã¯Ryukã¨ã„ã†åå‰ã®ç›£è¦–ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå¿…ãšç«‹ã¡ä¸ŠãŒã‚Šã„ã„æ„Ÿã˜ã«ä½¿ç”¨æ¸ˆã¿ã®ã‚³ãƒ³ãƒ†ãƒŠã®ç ´æ£„ãªã©ã‚’è‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹ã€‚

ä»¥ä¸‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚
```
go get github.com/testcontainers/testcontainers-go
```

:::message
Docker 22.06ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã¾ã§ã«replaceãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒDockerå´ã«è¿½åŠ ã•ã‚ŒãŸå½±éŸ¿ã§testcontainersã‚’ä½¿ç”¨ã™ã‚‹éš›ã«ã€ä»¥ä¸‹ã®è¨˜è¿°ãŒgo.modã«å¿…è¦ã¨ãªã£ã¦ã„ã¾ã™ã€‚testcontienrs-goã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§ã“ã¡ã‚‰ã¯å¯¾å¿œã•ã‚Œã‚‹äºˆå®šã®ã‚ˆã†ã§ã™ã€‚

```
replace github.com/docker/docker => github.com/docker/docker v20.10.3-0.20221013203545-33ab36d6b304+incompatible // 22.06 branch
```
:::

# testcontainersã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã‚‹
ä»¥ä¸‹ã®ã‚ˆã†ã«monogã‚³ãƒ³ãƒ†ãƒŠã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’æº–å‚™ã™ã‚‹ã€‚
```go
package container_testcontainers

import (
	"context"
	"time"

	"github.com/docker/go-connections/nat"
	"github.com/testcontainers/testcontainers-go"
	"github.com/testcontainers/testcontainers-go/wait"
)

type mongoContainer struct {
	testcontainers.Container
}

func SetupMongo(ctx context.Context) (*mongoContainer, error) {
	port, _ := nat.NewPort("", "27017")
	timeout := 2 * time.Minute // default

	req := testcontainers.ContainerRequest{
		Image:        "mongo:latest", // dockerã‚¤ãƒ¡ãƒ¼ã‚¸
		ExposedPorts: []string{"27017/tcp"}, // port
		Env: map[string]string{
			"MONGO_INITDB_ROOT_USERNAME": "user", // åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼
			"MONGO_INITDB_ROOT_PASSWORD": "password", // åˆæœŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
		},
		WaitingFor: wait.ForListeningPort(port).WithStartupTimeout(timeout), // èµ·å‹•ã¾ã§å¾…æ©Ÿ
	}

	container, err := testcontainers.GenericContainer(ctx, testcontainers.GenericContainerRequest{
		ContainerRequest: req,
		Started:          true,
	})
	if err != nil {
		return nil, err
	}

	return &mongoContainer{Container: container}, nil
}
```

ä¸Šè¨˜ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯TestMainã§ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹å‰ã«å®Ÿè¡Œã—ã€å®Ÿè¡Œã—ãŸã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶šã™ã‚‹ã€‚

```go
package datastore

import (
	"context"
	"fmt"
	"log"
	"os"
	"testing"
	"time"

	repository "JY8752/demo-app/domain/repository/user"
	datastore "JY8752/demo-app/infrastructure/datastore/mongo"
	container_testcontainers "JY8752/demo-app/test/container/testcontainers"

	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

var rep repository.ItemRepository

func TestMain(m *testing.M) {
	ctx := context.Background()
	container, err := container_testcontainers.SetupMongo(ctx)
	if err != nil {
		log.Fatal(err)
	}

	host, _ := container.Host(ctx)
	p, _ := container.MappedPort(ctx, "27017/tcp")

	connectionString := fmt.Sprintf("mongodb://user:password@%s:%d/?connect=direct", host, uint(p.Int()))
	mongoClient, err := mongo.Connect(ctx, options.Client().ApplyURI(
		connectionString,
	))
	if err != nil {
		log.Fatal(err)
	}

	client := datastore.NewMongoClient(mongoClient)
	rep = NewItemRepository(client)

	code := m.Run()

	if err = mongoClient.Disconnect(ctx); err != nil {
		log.Fatal(err)
	}

	os.Exit(code)
}

func TestUser(t *testing.T) {
	time := time.Date(2022, 1, 3, 0, 0, 0, 0, time.UTC)

	id, err := rep.Create(context.Background(), "user", time)
	if err != nil {
		t.Fatalf("fail create user. err: %s\n", err.Error())
	}

	user, err := rep.FindById(context.Background(), id)
	if err != nil {
		t.Fatalf("fail find user. err: %s\n", err.Error())
	}

	if user.Id != id {
		t.Fatalf("expect id is %s, but %s\n", id, user.Id)
	}

	if user.Name != "user" {
		t.Fatalf("expect name is 'user', but %s\n", user.Name)
	}

	if user.UpdatedAt != time {
		t.Fatalf("expect updatedAt is %v, but %v\n", time, user.UpdatedAt)
	}

	if user.CreatedAt != time {
		t.Fatalf("expect createdAt is %v, but %v\n", time, user.CreatedAt)
	}
}
```

å®Ÿè¡Œçµæœ

```terminal
2023/01/07 11:08:48 github.com/testcontainers/testcontainers-go - Connected to docker:
  Server Version: 20.10.17
  API Version: 1.41
  Operating System: Docker Desktop
  Total Memory: 1973 MB
2023/01/07 11:08:48 Starting container id: f21c2c07a63d image: docker.io/testcontainers/ryuk:0.3.4
2023/01/07 11:08:48 Waiting for container id f21c2c07a63d image: docker.io/testcontainers/ryuk:0.3.4
2023/01/07 11:08:48 Container is ready id: f21c2c07a63d image: docker.io/testcontainers/ryuk:0.3.4
2023/01/07 11:08:48 Starting container id: d2d1f0f698b9 image: mongo:latest
2023/01/07 11:08:49 Waiting for container id d2d1f0f698b9 image: mongo:latest
2023/01/07 11:08:50 Container is ready id: d2d1f0f698b9 image: mongo:latest
=== RUN   TestIUser
--- PASS: TestUser (2.53s)
PASS
ok      JY8752/demo-app/infrastructure/datastore/mongo/user    4.370s
```

ryukã¨ã„ã†åå‰ã®ã‚³ãƒ³ãƒ†ãƒŠã¨mongoã‚³ãƒ³ãƒ†ãƒŠã®2ã¤ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
ãƒ†ã‚¹ãƒˆã‚‚å•é¡Œãªããƒ‘ã‚¹ã—ã¦ã„ã¾ã™ã€‚

# dockertestã¨ã¯

https://github.com/ory/dockertest

testcontainersåŒæ§˜ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§dockerã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹Goè£½ã®ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã€‚ã‚¹ã‚¿ãƒ¼æ•°ã¯åŸ·ç­†æ™‚ç‚¹ã§testcontainersã®å€ãã‚‰ã„ã‚ã‚‹ã€‚ãƒªãƒªãƒ¼ã‚¹ãŒdockertestã¯2016å¹´ã”ã‚ã¨æ¯”è¼ƒã—ã¦testcontainersãŒ2019å¹´ã‚ãŸã‚Šãªã®ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚ã¾ã è©¦ç­†æ™‚ç‚¹ã§0.17.0ãªã®ã§testcontainers-goã®æ–¹ãŒå¾Œç™ºã§ã¾ã é–‹ç™ºä¸­ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

ä»¥ä¸‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚
```
go get -u github.com/ory/dockertest/v3
```

# dockertestã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ãªdockertestã®å‡¦ç†ã‚’ãƒ©ãƒƒãƒ—ã—ãŸé–¢æ•°ã‚’ç”¨æ„ã—ã¾ã™ã€‚

```go
package container_dockertest

import (
	"context"
	"fmt"
	"log"

	"github.com/ory/dockertest/v3"
	"github.com/ory/dockertest/v3/docker"
	"go.mongodb.org/mongo-driver/mongo"
	"go.mongodb.org/mongo-driver/mongo/options"
)

func Start() (*mongo.Client, func(), error) {
	// uses a sensible default on windows (tcp/http) and linux/osx (socket)
	pool, err := dockertest.NewPool("")
	if err != nil {
		log.Printf("Could not construct pool: %s\n", err)
		return nil, nil, err
	}

	// uses pool to try to connect to Docker
	err = pool.Client.Ping()
	if err != nil {
		log.Printf("Could not connect to Docker: %s", err)
		return nil, nil, err
	}

	runOptions := &dockertest.RunOptions{
		Repository: "mongo",
		Tag:        "latest",
		Env: []string{
			"MONGO_INITDB_ROOT_USERNAME=user",
			"MONGO_INITDB_ROOT_PASSWORD=password",
		},
	}

	resource, err := pool.RunWithOptions(runOptions,
		func(hc *docker.HostConfig) {
			hc.AutoRemove = true
			hc.RestartPolicy = docker.RestartPolicy{
				Name: "no",
			}
		},
	)

	port := resource.GetPort("27017/tcp")

        // èµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
	var dbClient *mongo.Client
	pool.Retry(func() error {
		dbClient, err = mongo.Connect(
			context.TODO(),
			options.Client().ApplyURI(
				fmt.Sprintf("mongodb://user:password@localhost:%s", port),
			),
		)
		if err != nil {
			return err
		}
		return dbClient.Ping(context.TODO(), nil)
	})

	if err != nil {
		log.Printf("Could not connect to docker: %s", err)
		return nil, nil, err
	}

	fmt.Println("start mongo containerğŸ³")

        // mongoã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚¯ãƒ­ãƒ¼ã‚ºé–¢æ•°ã‚’è¿”å´
	return dbClient, func() { close(dbClient, pool, resource) }, nil
}

func close(m *mongo.Client, pool *dockertest.Pool, resource *dockertest.Resource) {
	// disconnect mongodb client
	if err := m.Disconnect(context.TODO()); err != nil {
		panic(err)
	}

	// When you're done, kill and remove the container
	if err := pool.Purge(resource); err != nil {
		panic(err)
	}

	fmt.Println("close mongo containerğŸ³")
}
```

ãƒ†ã‚¹ãƒˆã¯testcontainersåŒæ§˜ã€TestMainã«è¨˜è¿°ã—ãƒ†ã‚¹ãƒˆé–‹å§‹å‰ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹ã€‚

```go
package datastore

import (
	repository "JY8752/demo-app/domain/repository/user"
	datastore "JY8752/demo-app/infrastructure/datastore/mongo"
	container "JY8752/demo-app/test/container/dockertest"
	"context"
	"log"
	"os"
	"testing"
	"time"
)

var rep repository.UserRepository

func TestMain(m *testing.M) {
	mongoClient, close, err := container.Start()
	if err != nil {
		log.Fatal(err)
	}

	client := datastore.NewMongoClient(mongoClient)

	rep = NewUserRepository(client)

	code := m.Run()

	close()

	os.Exit(code)
}

func TestUser(t *testing.T) {
  // ç•¥
}
```

å®Ÿè¡Œçµæœ

```
start mongo containerğŸ³
=== RUN   TestUser
--- PASS: TestUser (0.01s)
PASS
close mongo containerğŸ³
ok  	JY8752/demo-app/infrastructure/datastore/mongo/user	3.707s
```

testcontainersåŒæ§˜ã€å•é¡Œãªããƒ‘ã‚¹ã—ã¾ã—ãŸã€‚

# ã¾ã¨ã‚

## dockertestã®æ–¹ãŒè‹¥å¹²æ—©ã„
ä½•å›ã‹å®Ÿè¡Œã—ã¾ã—ãŸãŒdockertestã®æ–¹ãŒå®Ÿè¡Œé€Ÿåº¦ã¯é€Ÿã‹ã£ãŸã§ã™ã€‚ã“ã‚ŒãŒtestcontainersã®æ–¹ãŒèµ·å‹•ã‚³ãƒ³ãƒ†ãƒŠæ•°ãŒå¤šã„ã‹ã‚‰ãªã®ã‹è©³ã—ãã¯ã‚ã‹ã‚‰ãªã„ã®ã§ã™ãŒæ™‚é–“ãŒã‹ã‹ã‚‹ã®ã¯ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ã¨ç ´æ£„ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å‡¦ç†æ™‚é–“ã«ã¯å½±éŸ¿ãŒå‡ºãªã„ã¨æ€ã†ã®ã§ãã“ã¾ã§æ·±ãè€ƒãˆãªãã¦ã‚‚ã„ã„ã‹ãªã¨æ€ã£ã¦ã¾ã™ã€‚ãŸã ã€ä»Šå›ã¯ãƒ†ã‚¹ãƒˆï¼‘ã‚±ãƒ¼ã‚¹ã§ã—ã‹è©¦ã›ã¦ã„ãªã„ã®ã§ãƒ†ã‚¹ãƒˆæ•°ãŒå¢—ãˆã¦ããŸã¨ãã«ã‚‚ã£ã¨å·®ãŒã§ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## å‡¦ç†ã‚’ãƒ©ãƒƒãƒ—ã—ãŸé–¢æ•°ã¯ã‚ã£ãŸã»ã†ãŒã„ã„
ãƒ†ã‚¹ãƒˆã”ã¨ã«æ¯å›æ›¸ãã“ã¨ã«ãªã‚‹ã®ã§ã€ã©ã¡ã‚‰ã‚’ä½¿ã†ã«ã—ã‚ãƒ©ãƒƒãƒ—ã—ãŸé–¢æ•°ã®ã‚ˆã†ãªã‚‚ã®ã‚’ç”¨æ„ã—ãŸã»ã†ãŒã„ã„ã€‚testcontainersã®æ–¹ãŒè¨˜è¿°ãŒæ¥½ãªå°è±¡ã‚’å—ã‘ãŸã‘ã©ãƒ©ãƒƒãƒ—ã—ã¦ãŠã‘ã°æ¯å›æ›¸ã‹ãªãã¦ã„ã„ã®ã§ã©ã£ã¡ã‚’ä½¿ã£ã¦ã‚‚ã„ã„ã‹ãªã¨ã„ã†å°è±¡ã€‚

## dockertestã®æ–¹ãŒæ¯ã‚Œã¦ã„ãã†ï¼Ÿ
Javaè£½ã®testcontainersãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã®ã¯2015å¹´ã”ã‚ã§ã¯ã‚ã‚‹ãŒã€Goè£½ã®testcontainersãŒä½¿ãˆã‚‹ã‚ˆã«ãªã£ãŸã®ã¯2019å¹´ã”ã‚ã®ãŸã‚testcontainers-goãŒå‡ºã¦ãã‚‹å‰ã«Goã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹å ´åˆã«ã¯dockertestãŒæ¡ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã‹ã£ãŸã®ã ã¨æ€ã„ã¾ã™ã€‚å®Ÿéš›dockertestã®æ–¹ãŒãƒãƒƒãƒˆã§ã‚‚æƒ…å ±ã¯å¤šãã†ã€‚è¤‡é›‘ãªã“ã¨ã‚’ã—ãªã‘ã‚Œã°ãã‚“ãªã«ãƒãƒã‚‹ãƒã‚¤ãƒ³ãƒˆã‚‚ãªã„ã‚ˆã†ãªæ°—ãŒã™ã‚‹ãŒdockertestã‚’æ¡ç”¨ã—ãŸã»ã†ãŒãƒãƒã£ãŸã¨ãã«æƒ…å ±ãŒå¤šã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚ãŸã ã€testcontainersã¯ã¾ã é–‹ç™ºä¸­ãªæ„Ÿã˜ã‚‚ã™ã‚‹ã®ã§ã“ã‚Œã‹ã‚‰ã©ã‚“ã©ã‚“è‰¯ããªã£ã¦ã„ãã‚ˆã†ãªæ°—ã¯ã™ã‚‹ã€‚

## çµè«–
**ã©ã£ã¡ã§ã‚‚ã„ã„**

å€‹äººçš„ã«ã¯Javaã§ã ã„ã¶ãŠä¸–è©±ã«ãªã£ãŸã®ã§testcontainersæ¨ã—ã€‚å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§æ¡ç”¨ã™ã‚‹ãªã‚‰dockertestã®æ–¹ãŒã„ã„ã‹ã‚‚ã—ã‚Œãªã„ãŒã€DBã®ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹ã ã‘ãªã‚‰ã©ã£ã¡ã‚’ä½¿ã£ã¦ã‚‚ã„ã„ã¨æ€ã„ã¾ã™ã€‚

# å‚è€ƒ
dockertest x mongoã®æ›¸ãæ–¹å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸ
https://qiita.com/Domao/items/37f571f96ac7dd5ba3cd

# ãŠã¾ã‘
æ¤œè¨¼ã™ã‚‹ãªã‹ã§ã¯ã¾ã£ãŸã¨ã“ã‚

## dockertestã®ã‚³ãƒ³ãƒ†ãƒŠç ´æ£„ãŒçµ‚ã‚ã‚‰ãªã„
ã“ã®å‡¦ç†ã§Purge()ã‚’å®Ÿè¡Œã—ãŸã‚ã¨ã«Disconnect()ã‚’æ›¸ã„ã¦ã„ãŸã®ã ã‘ã©ãƒ†ã‚¹ãƒˆå®Œäº†ã™ã‚‹ã®ã«30ç§’è¿‘ãã‹ã‹ã£ã¦ã—ã¾ã£ã¦ãƒãƒã£ãŸã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«mongoåˆ‡æ–­ã—ãŸå¾Œã«Purge()ã™ã‚‹ã‚ˆã†ã«ã—ãŸã‚‰è§£æ±ºã—ãŸã€‚ã§ã‚‚ã€dockertestã®[example](https://github.com/ory/dockertest/blob/v3/examples/MongoDB.md)ãŒPurge()ã—ã¦ã‹ã‚‰mongoåˆ‡æ–­ã—ã¦ã‚‹ã®ã§ã‚ˆãã‚ã‹ã£ã¦ãªã„ã€‚

```go
func close(m *mongo.Client, pool *dockertest.Pool, resource *dockertest.Resource) {
	// disconnect mongodb client
	if err := m.Disconnect(context.TODO()); err != nil {
		panic(err)
	}

	// When you're done, kill and remove the container
	if err := pool.Purge(resource); err != nil {
		panic(err)
	}

	fmt.Println("close mongo containerğŸ³")
}
```

## dockertesetã®AutoRemoveãŒæ©Ÿèƒ½ã—ã¦ãªã„ï¼Ÿ
ã“ã“
```go
	resource, err := pool.RunWithOptions(&dockertest.RunOptions{
		Repository: "mongo",
		Tag:        "5.0",
		Env: []string{
			// username and password for mongodb superuser
			"MONGO_INITDB_ROOT_USERNAME=root",
			"MONGO_INITDB_ROOT_PASSWORD=password",
		},
	}, func(config *docker.HostConfig) {
		// set AutoRemove to true so that stopped container goes away by itself
		config.AutoRemove = true
		config.RestartPolicy = docker.RestartPolicy{
			Name: "no",
		}
	})
```

ã“ã®è¨­å®šãŒæœ‰åŠ¹ãªã‚‰
```go
	// When you're done, kill and remove the container
	if err = pool.Purge(resource); err != nil {
		log.Fatalf("Could not purge resource: %s", err)
	}
```

ã“ã®å‡¦ç†ãªãã¦ã‚‚ã‚³ãƒ³ãƒ†ãƒŠç ´æ£„ã•ã‚Œã‚‹ã®ã‹ã¨æ€ã£ãŸã‘ã©ãã‚“ãªã“ã¨ã¯ãªãä¸Šè¨˜ã®Purge()ãŒãªã„ã¨ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦æ®‹ã‚Šç¶šã‘ã‚‹ã€‚ã˜ã‚ƒã‚AutoRemoveã®è¨­å®šä½•ï¼Ÿã£ã¦ãªã£ãŸã‘ã©ã‚ˆãã‚ã‹ã£ã¦ãªã„ã€‚ã¨ã‚Šã‚ãˆãšdockertesetã‚’ä½¿ç”¨ã™ã‚‹ãªã‚‰ã¡ã‚ƒã‚“ã¨Purgeé–¢æ•°ã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒ†ãƒŠã‚’ç¢ºå®Ÿã«ç ´æ£„ã™ã‚‹ã‚ˆã†ã«ã—ãŸã»ã†ãŒã„ã„ã€‚ã¡ãªã¿ã«ã€testcontainersã¯ã“ã“ã‚‰ã¸ã‚“RyukãŒã„ã„æ„Ÿã˜ã«ã‚„ã£ã¦ãã‚Œã‚‹ã®ã§ã‚ã‚“ã¾ã‚Šè€ƒãˆãªãã¦è‰¯ã„ã®ã‚‚testcontainersã®è‰¯ã•ã ã¨æ€ã£ã¦ã‚‹ã€‚

## os.Exit()ã®ã‚ã¨ã«deferã¯å‡¦ç†ã•ã‚Œãªã„
MainTestå†…ã«deferã§closeå‡¦ç†æ›¸ãã¾ãã£ã¦ã‚³ãƒ³ãƒ†ãƒŠç ´æ£„ã•ã‚Œãªãã¦ã‚ã‚Œãƒ¼ï¼Ÿï¼Ÿã£ã¦ãªã£ãŸã‚„ã¤ã€‚

https://qiita.com/umanoda/items/39eb03c9651bd43bc657