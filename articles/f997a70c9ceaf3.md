---
title: "kotlin Ã— Spring Ã— kotest Ã— testcontainersã§æ›¸ãã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ(Repositoryç·¨)"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kotlin", "mockk", "Spring", "kotest", "Testcontainers"]
published: true
---

1. [kotlin Ã— Spring Ã— kotest Ã— mockkã§æ›¸ããƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ](https://zenn.dev/jy8752/articles/7e88836c2bc1d0)
2. kotlin Ã— Spring Ã— kotest Ã— testcontainersã§æ›¸ãã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ(Repositoryç·¨) <- ä»Šã“ã“
3. [kotlin Ã— Spring Ã— kotest Ã— testcontainersã§æ›¸ãã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ(gRPCç·¨)](https://zenn.dev/jy8752/articles/2e5059a4475484)

å‰å›ã®ç¶šãã§ä»Šå›ã¯Repositoryã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ãã¾ã™ã€‚Repositoryã‚¯ãƒ©ã‚¹ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆãªã®ã§åˆ†é¡ã™ã‚‹ãªã‚‰ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã ã‚ã¨æ€ã£ã¦ã„ãŸã®ã§ã™ãŒRepositoryã‚¯ãƒ©ã‚¹ãŒDBã¨å®Ÿéš›ã«æ¥ç¶šã•ã›ã¦ã¿ã¦æ­£å¸¸ã«å‹•ãã‹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ã§ã“ã‚Œã¯ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã§ã™ã€‚å‰å›ä½œæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã¨ã«ã‚„ã£ã¦ã„ãã¾ã™ã€‚

## testcontainersã®å°å…¥
DBã®ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹ã¨ãã¯ãªã‚‹ã¹ãæœ¬ç•ªç’°å¢ƒã«å¯„ã›ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚ãã®ãŸã‚ã€ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªDBã§ã¯ãªããƒ­ãƒ¼ã‚«ãƒ«ã§æ§‹ç¯‰ã—ãŸå®Ÿéš›ã®DBã‚‚ã—ãã¯dockerãªã©ã§èµ·å‹•ã—ãŸDBã‚³ãƒ³ãƒ†ãƒŠãªã©ã‚’ç”¨æ„ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸã„ã§ã™ã€‚ãŸã ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œç’°å¢ƒã«DBã®ç”¨æ„ãŒã•ã‚Œã¦ã„ãªã„ã¨å½“ç„¶ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã—ã¾ã™ã€‚ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆå®Ÿæ–½è€…ã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§DBã‚‚ã—ãã¯DBã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ã‚’å¿˜ã‚Œã¦ã—ã¾ã£ãŸæ™‚ãªã©ã«èµ·ã“ã‚Šã¾ã™ã€‚

dockerã§ã‚„ã‚‹ãªã‚‰dockerã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã ã‘ãªã®ã§ãã‚“ãªã«æ‰‹é–“ã§ã¯ãªã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒã“ã®ã‚ˆã†ãªå¤–éƒ¨ä¾å­˜æ€§ã¯ç„¡ãã—ãŸã„ã®ã¨ã€ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ä½•ã‹ã‚’å¼·è¦ã™ã‚‹ã®ã‚’é¿ã‘ãŸã‹ã£ãŸã®ã§ç­†è€…ã¯testcontainersã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚testcontainersã¯ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ä¸Šã§dockerã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ã‚„åœæ­¢ã‚’åˆ¶å¾¡ã§ãã‚‹ãŸã‚å®Œå…¨ã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®ä¸­ã ã‘ã§å®Œçµã—ã¾ã™ã—ã€éå¸¸ã«ç°¡å˜ã«å°å…¥ã§ãã¾ã™ã€‚ã¾ãšã€ä»¥ä¸‹ã‚’build.gradle.ktsã«è¿½åŠ ã—ã¾ã™ã€‚

```diff kotlin:build.gradle.kts
+	testImplementation("org.testcontainers:junit-jupiter:1.17.2")
+	testImplementation("org.testcontainers:mongodb:1.17.2")
```

æ¬¡ã«ã€ãƒ†ã‚¹ãƒˆã®èµ·å‹•ã«åˆã‚ã›ã¦DBã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã•ã›ãŸã„ã®ã§ã™ãŒä»Šå›ã¯ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«kotestã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§kotestã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹AbstractProjectConfigã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ãŸConfigã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€ãã“ã§testcontainersã®å‡¦ç†ã‚’æ›¸ã„ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚

```kotlin:ProjectConfig
internal class ProjectConfig : AbstractProjectConfig() {
    override fun extensions() = listOf(SpringExtension)

    override suspend fun beforeProject() {
        MongoDBContainer("mongo:latest").also {
            it.start()
            it.waitingFor(HostPortWaitStrategy())

            System.setProperty("spring.data.mongodb.uri", it.replicaSetUrl)
        }
    }

}
```

ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯2ç‚¹ã§ã¾ãšSpringæ‹¡å¼µã‚’ç™»éŒ²ã—ã¦ã„ã‚‹ã®ã¨ãƒ†ã‚¹ãƒˆã®èµ·å‹•å‰å‡¦ç†ã«testcontaienrsã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹MongoDBContainerã‚¯ãƒ©ã‚¹ã«dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ–‡å­—åˆ—ã§æŒ‡å®šã—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦ã„ã¾ã™ã€‚mongoã‚³ãƒ³ãƒ†ãƒŠã¯start()ã§èµ·å‹•ã§ãã¾ã™ã®ã§èµ·å‹•ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ã®ã¨ã€propertyã‚’èµ·å‹•ã—ãŸmongoã‚³ãƒ³ãƒ†ãƒŠã«æ¥ç¶šã™ã‚‹ã‚ˆã†ã«ä¸Šæ›¸ãã—ã¦ã„ã¾ã™ã€‚

:::message
ä»Šå›ã¯ProjectConfigã‚’ä½œæˆã—ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ãƒ†ã‚¹ãƒˆè¨­å®šã‚’ã—ã¾ã—ãŸãŒå€‹åˆ¥ã«è¨­å®šãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ã‚„ã‚‚ã£ã¨Configã‚„Propertyå‘¨ã‚Šã¯å·¥å¤«ãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ãªã®ã§ã€å°å…¥ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦é©åˆ‡ã«è¨­å®šã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
:::

ä»¥ä¸Šã§testcontainersã®æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

### ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
æ¬¡ã«å‰å›ç”¨æ„ã—ãŸUserRepositoryã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚UserRepositoryã®findByIdãƒ¡ã‚½ãƒƒãƒ‰ã®æˆ»ã‚Šå€¤ãŒOptionalã«ãªã‚‹ã®ãŒå«Œã ã£ãŸã®ã§UserRepositoryã‚’å°‘ã—ä¿®æ­£ã—ã¾ã™ã€‚(ã¤ã„ã§ã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ä¸€ã¤å¢—ã‚„ã—ã¦ãŠãã¾ã™ã€‚)

```diff kotlin:UserRepository
@Repository
- interface UserRepository : MongoRepository<UserDocument, ObjectId> {
+ interface UserRepository : CrudRepository<UserDocument, ObjectId> {
+    fun findFirstByName(name: String): UserDocument?
}
```

```kotlin:UserRepositoryTest
@SpringBootTest
internal class UserRepositoryTest(
    private val userRepository: UserRepository
) : StringSpec({
    "save and find" {
        //given
        val testTime = getTestTime()
        val document = UserDocument(name = "user", age = 32, createdAt = testTime, updatedAt = testTime)
        val saved = userRepository.save(document)

        //when
        val result = userRepository.findByIdOrNull(document.id)

        //then
        result shouldBe saved
    }
})
```

ç‰¹ã«ãƒã‚¤ãƒ³ãƒˆã®ã‚ˆã†ãªã‚‚ã®ã¯ãªã„ã§ã™ãŒå‰å›ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¨é•ã†ã¨ã“ã‚ã¯@SpringBootTestã‚’æŒ‡å®šã—ã¦Springã‚’èµ·å‹•ã•ã›ã¦ã„ã¾ã™ã€‚

:::message
æœ¬å½“ã¯@SpringBootTestã¯å…¨ã¦ã®Beanã®ç™»éŒ²ãŒèµ°ã‚Šç„¡é§„ãŒå¤šã„ã®ã§ä¸‹è¨˜ã®æ§˜ã«ã—ã¦Beanç™»éŒ²ã‚’çµã‚ŠãŸã„ã®ã§ã™ãŒã†ã¾ãã„ã‹ãªã‹ã£ãŸã®ã§è«¦ã‚ã¾ã—ãŸã€‚èª°ã‹ã„ã„ã‚„ã‚Šæ–¹ã”å­˜çŸ¥ã®æ–¹ã„ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„ğŸ’¦

```kotlin
@SpringBootTest(classes = [
  UserRepository::class
])
internal class UserRepositoryTest(
    private val userRepository: UserRepository
) : StringSpec({
```

:::

æ¬¡ã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å¢—ã‚„ã—ã¦ã¿ã¾ã™ã€‚

```diff kotlin:UserRepositoryTest
@SpringBootTest
@Transactional
internal class UserRepositoryTest(
    private val userRepository: UserRepository
) : StringSpec({
    "save and find" {
        //given
        val testTime = getTestTime()
        val document = UserDocument(name = "user", age = 32, createdAt = testTime, updatedAt = testTime)
        val saved = userRepository.save(document)

        //when
        val result = userRepository.findByIdOrNull(document.id)

        //then
        result shouldBe saved
    }
+    "findFirstByName" {
+        userRepository.save(UserDocument(name = "user"))
+        userRepository.findFirstByName("user") shouldNotBe null
+    }
+    "count" {
+        userRepository.count() shouldBe 0
+    }
})
```

ã“ã®çŠ¶æ…‹ã§å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã¨countã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã™ã€‚ã“ã‚Œã¯DBã‚³ãƒ³ãƒ†ãƒŠãŒUserRepositoryTestã®ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ã‹ã‚‰çµ‚äº†ã™ã‚‹ã¾ã§å…±é€šã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å…±æœ‰ã—ã¦ä½¿ç”¨ã™ã‚‹ãŸã‚ã€å‰æ®µã®ãƒ†ã‚¹ãƒˆã§è¿½åŠ ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå½±éŸ¿ã—ã¦ã—ã¾ã£ãŸãŸã‚ã§ã™ã€‚ã“ã®çŠ¶æ³ã¯ã‚ã¾ã‚Šæœ›ã¾ã—ããªãå„ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«ã¯å¸¸ã«DBã¯ã¾ã£ã•ã‚‰ãªç¶ºéº—ãªçŠ¶æ…‹ã§ã‚ã£ã¦æ¬²ã—ã„ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/efdbdcfc0ee5-20220701.png)

ä»¥ä¸‹ã€ã„ã‚ã„ã‚è©¦è¡ŒéŒ¯èª¤ã€‚

1. **ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®åº¦ã«èµ·å‹•ã—ç›´ã™**
ã“ã‚Œã§æ¯å›DBã®çŠ¶æ³ã¯åˆæœŸåŒ–ã•ã‚Œã¾ã™ãŒã‚³ãƒ³ãƒ†ãƒŠãŒæ¯å›èµ·å‹•ã™ã‚‹ã®ã§ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ™‚é–“ãŒã‹ãªã‚Šä¼¸ã³ã¾ã™ã€‚ã“ã®3ã‚±ãƒ¼ã‚¹ãã‚‰ã„ãªã‚‰ãã‚“ãªã«å·®ã¯å‡ºãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒå®Ÿãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’å›ãã†ã¨ã™ã‚‹ã¨è‡´å‘½çš„ã«ãªã‚‹ã®ã§æ–­å¿µã€‚

2. **ãƒ†ã‚¹ãƒˆçµ‚äº†æ™‚ã«æ¯å›ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€DBã‚’åˆæœŸåŒ–ã™ã‚‹**
`afterTest { }`ã«deleteAll()ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã€ã‚¤ãƒ³ã‚µãƒ¼ãƒˆã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã®IDã‚’ä¿æŒã—ã¦ãŠã„ã¦deleteã™ã‚Œã°æ¯å›ã¾ã£ã•ã‚‰ãªçŠ¶æ…‹ã§ãƒ†ã‚¹ãƒˆã§ãã‚‹ãŸã‚è¦ä»¶ã¯æº€ãŸã—ã¦ã„ã¾ã™ã€‚

3. **@Transactionalã‚’ä½¿ç”¨ã™ã‚‹**
ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã«@Transactionalã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆã®ãŸã³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã‚‹ãŸã‚æ‰‹å‹•ã§å‰Šé™¤ã™ã‚‹æ‰‹é–“ãŒãªããªã‚Šã¾ã™ã®ã§ã€ã“ã®æ–¹æ³•ã‚’æ¡ç”¨ã—ã¦ã¿ã¾ã™ã€‚

mongoã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã«Configã‚¯ãƒ©ã‚¹ã‚’æ–°ãŸã«ä½œæˆã—ã¾ã™ã€‚

```kotlin:MongoConfig
@Configuration
class MongoConfig {
    @Bean
    fun transactionManager(dbFactory: MongoDatabaseFactory) =
        MongoTransactionManager(dbFactory)
}
```

ã“ã‚Œã§@TransactionalãŒä½¿ç”¨ã§ãã¾ã™ã®ã§ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã«è¿½åŠ ã—å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```diff kotlin:UserRepositoryTest
@SpringBootTest
+ @Transactional
internal class UserRepositoryTest(
    private val userRepository: UserRepository
) : StringSpec({
    "save and find" {
        //given
        val testTime = getTestTime()
        val document = UserDocument(name = "user", age = 32, createdAt = testTime, updatedAt = testTime)
        val saved = userRepository.save(document)

        //when
        val result = userRepository.findByIdOrNull(document.id)

        //then
        result shouldBe saved
    }
    "findByName" {
        userRepository.save(UserDocument(name = "user"))
        userRepository.findFirstByName("user") shouldNotBe null
    }
    "count" {
        userRepository.count() shouldBe 0
    }
})
```

ç„¡äº‹å…¨ã¦ã®ã‚±ãƒ¼ã‚¹ãŒæˆåŠŸã—ã¾ã—ãŸï¼ï¼
![](https://storage.googleapis.com/zenn-user-upload/69c5c8fd642d-20220701.png)

## ã¾ã¨ã‚
testcontainersãŒæœ€å¼·ã€‚mongoä»¥å¤–ã«ã‚‚dockerã§å‡ºæ¥ã‚‹ã“ã¨ã¯ä½•ã§ã‚‚å‡ºæ¥ã‚‹ã€‚æ¬¡ã¯å…¨ä½“çš„ã«é€šã—ã§å‹•ã‹ã™ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆæ›¸ãã€‚