---
title: "gRPC(Connect)ã®Server Streamingã‚’ä½¿ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã®ãƒ†ã‚¹ãƒˆã‚’runnã¨Bufã‚’ä½¿ã£ã¦æ›¸ã„ã¦ã¿ãŸ"
emoji: "ğŸ¦­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["runn", "Go", "Buf", "gRPC", "Connect"]
published: true
---

æœ€è¿‘æ¥­å‹™ã§gRPCã®Server Streamingã‚’ä½¿ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã‚’Goã§æ›¸ã„ã¦ã„ã‚‹ã®ã§ã™ãŒè¤‡æ•°ã®ã‚´ãƒ«ãƒ¼ãƒãƒ³ã‚’èµ·å‹•ã—ãŸä¸¦è¡Œå‡¦ç†ãŒçµ¡ã‚“ã§ããŸã‚Šã¨å°‘ã—ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã®ãŒå¤§å¤‰ã ãªã¨æ„Ÿã˜ã¦ãŠã‚Šã€å‰ã‹ã‚‰æ°—ã«ãªã£ã¦ã„ãŸrunnã‚’ä½¿ã£ã¦E2Eãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ãŸãŸã‚ãã®å‚™å¿˜éŒ²ã§ã™ã€‚

runnã§ã¯gRPCãƒ©ãƒ³ãƒŠãƒ¼ãŒå®Ÿè£…ã•ã‚Œã¦ãŠã‚ŠStreamingã‚‚å…¨ã¦ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚·ãƒŠãƒªã‚ªè‡ªä½“ã¯æ›¸ã‘ã‚‹ã®ã§ã™ãŒServer Streamingã®è£å´ã§Redisã‚’è³¼èª­ã—ã¦ãŠã‚Šã€Redisã«messageã‚’Publishã—ãªã„ã¨å‡¦ç†ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã—ã¾ã†ã®ã§gRPCãƒ©ãƒ³ãƒŠãƒ¼å®Ÿè¡Œä¸­ã«ä¸¦è¡Œã—ã¦Redisã®Publishã‚’ã—ãŸã‹ã£ãŸã®ã§ã™ãŒèª¿ã¹ãŸé™ã‚Šrunnã®æ©Ÿèƒ½ã ã‘ã§ã¯å®Ÿç¾ã§ããã†ã«ãªã‹ã£ãŸãŸã‚å°‘ã—åŠ›æŠ€ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¾ã—ãŸã€‚

ã‚‚ã—ã€ã‚‚ã£ã¨ã„ã„æ–¹æ³•ã‚ã‚‹ã‚ˆã¨ã„ã†æ–¹ãŒã„ã¾ã—ãŸã‚‰ãœã²ã‚³ãƒ¡ãƒ³ãƒˆãªã©æ°—è»½ã«ã„ãŸã ã‘ã‚‹ã¨æ³£ã„ã¦å–œã³ã¾ã™ã€‚

ã¾ãŸã€runnã¯Bufã¨BSR(Buf Schema Registry)ã‚’ã‚µãƒãƒ¼ãƒˆã—ãŸã¨ã®ã“ã¨ã ã£ãŸã®ã§ã›ã£ã‹ããªã®ã§Bufã¨BSRã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸï¼

## å¯¾è±¡èª­è€…

- runnã‚’ä½¿ã£ãŸE2Eãƒ†ã‚¹ãƒˆ(ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ)ã«èˆˆå‘³ãŒã‚ã‚‹æ–¹
- runnã®gRPCãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ã£ãŸStreamingã®ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„æ–¹
- gRPCã®Streamingã‚’ä½¿ã£ãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã®ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦èˆˆå‘³ãŒã‚ã‚‹æ–¹
- runnã®Bufã‚µãƒãƒ¼ãƒˆã®å†…å®¹ã«èˆˆå‘³ãŒã‚ã‚‹æ–¹

## ä½¿ç”¨æŠ€è¡“

- go version go1.22.0 darwin/arm64
- runn version 0.115.0
- buf 1.32.1

## æˆæœç‰©

https://buf.build/jyapp/runndemo

https://github.com/JY8752/runn-connect-streaming-demo

## ã‚„ã‚ŠãŸã„ã“ã¨

æƒ³å®šã—ã¦ã„ã‚‹ä»•çµ„ã¿ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/d257fc1397f1-20240723.png)

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯gRPCã‚µãƒ¼ãƒãƒ¼(ä»Šå›ã¯Bufã®Connectã‚’ä½¿ç”¨äºˆå®š)ã¨Server Streamingã§ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ã™ã‚‹ã€‚
- gRPCã‚µãƒ¼ãƒãƒ¼ã¯è£å´ã§Redisã®PubSubã‚’ä½¿ã£ã¦messageã‚’è³¼èª­ã™ã‚‹ã€‚
- åˆ¥ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒgRPCã‚µãƒ¼ãƒãƒ¼ã«Unary rpcã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã€‚
- gRPCã‚µãƒ¼ãƒãƒ¼ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã£ãŸã‚‰Redisã«messageã‚’Publishã™ã‚‹ã€‚
- Publishã•ã‚ŒãŸmessageã‚’å—ã‘å–ã£ãŸã‚‰Server Streamingã‚’ä½¿ã£ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥ã€‚


ã“ã®ãƒ†ã‚¹ãƒˆã‚’runnã‚’ä½¿ã£ã¦æ›¸ã„ã¦ã„ãã¾ã™ï¼

## runnã«ã¤ã„ã¦

https://github.com/k1LoW/runn

runnã«é–¢ã—ã¦ã¯ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå……å®Ÿã—ã¦ã„ã‚‹ã®ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªzennæœ¬ãŒã‚ã‚‹ã®ã§è©³ã—ãã¯å‰²æ„›ã—ã¾ã™ãŒyamlã§ã‚·ãƒŠãƒªã‚ªãƒ™ãƒ¼ã‚¹ã«ãƒ†ã‚¹ãƒˆãŒæ›¸ã‘ã‚‹Goè£½ã®ãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚runnã¯gRPCã ã‘ã§ãªãHTTPã‚„sshãªã©è¤‡æ•°ã®å®Ÿè¡Œãƒ©ãƒ³ãƒŠãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãŠã‚Šè² è·ãƒ†ã‚¹ãƒˆã‚„ä¸€é€£ã®å‡¦ç†ã®è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã‚‚ä½¿ãˆã€éå¸¸ã«é«˜æ©Ÿèƒ½ã§ã™ã€‚

https://zenn.dev/katzumi/books/runn-tutorial

https://zenn.dev/k1low/books/runn-cookbook

## ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã®å®Ÿè£…

ã¾ãšã¯protoãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

ä»Šå›ã¯[Buf CLI](https://buf.build/product/cli)ã¨[BSR](https://buf.build/product/bsr)(Buf Schema Registry)ã‚’ä½¿ã£ã¦Protobufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¬é–‹ã—ã¦ã„ãã¾ã™ã€‚

Bufã‚„BSRã«ã¤ã„ã¦è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ã‚ãŸã—ãŒæ›¸ã„ãŸä»¥ä¸‹ã®zennæœ¬ãªã©ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/jy8752/books/33743f8091c39d

### BSRã«Protobufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¬é–‹ã™ã‚‹

```
mkdir -p runn-connect-streaming-demo/proto
cd runn-connect-streaming-demo/proto
```

```
buf config init
```

ä»¥ä¸‹3ã¤ã®protoãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```protobuf:jyapp/runndemo/hello/v1/hello.proto
syntax = "proto3";

package jyapp.runndemo.hello.v1;

message HelloRequest { string message = 1; }

message HelloResponse {}

service HelloService {
  rpc Hello(HelloRequest) returns (HelloResponse) {}
}
```

```protobuf:jyapp/runndemo/greet/v1/greet.proto
syntax = "proto3";

package jyapp.runndemo.greet.v1;

message GreetRequest { string message = 1; }

message GreetResponse {}

service GreetService {
  rpc Greet(GreetRequest) returns (GreetResponse) {}
}
```

```protobuf:jyapp/runndemo/pubsub/v1/pubsub.proto
syntax = "proto3";

package jyapp.runndemo.pubsub.v1;

message SubscribeRequest {}

message SubscribeResponse { string message = 1; }

service PubSubService {
  rpc Subscribe(SubscribeRequest) returns (stream SubscribeResponse) {}
}
```

```hello.proto```ã¨```greet.proto```ã¯Redisã«messageã‚’Publishã™ã‚‹ãŸã‚ã®Unary rpcã§ã™ã€‚```pubsub.proto```ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨gRPCã‚µãƒ¼ãƒãƒ¼é–“ã§Server Streamingã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºç«‹ã—ã€Redisã§å—ã‘å–ã£ãŸmessageã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ä¼æ¬ã™ã‚‹ãŸã‚ã®rpcã§ã™ã€‚

protoãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã§ããŸã‚‰```buf.yaml```ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦Protobufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚

```diff yaml:buf.yaml
version: v2
+ modules: 
+   - path: jyapp/runndemo
+     name: buf.build/jyapp/runndemo
lint:
  use:
    - DEFAULT
breaking:
  use:
    - FILE
```


BSRã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ã‚’ã—ã¦ãŠãã€‚

```
buf registry login
```

ãƒ­ã‚°ã‚¤ãƒ³ã«ã¯```ãƒ¦ãƒ¼ã‚¶ãƒ¼å```ã¨BSRã®è¨­å®šç”»é¢ã‹ã‚‰ä½œæˆã§ãã‚‹```ãƒˆãƒ¼ã‚¯ãƒ³```ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ãŸã‚‰Protobufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§BSRã«pushã—ã¾ã™ã€‚

```
% buf push --create-visibility public --create
buf.build/jyapp/runndemo:3c7f541462c54848988286002b79f2f5
```

```--create-visibility```ã¯Protobufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¬é–‹ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã®å¯è¦–æ€§ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯```private```ã§ã™ãŒä»Šå›ã¯```public```ã«ã—ã¦ã„ã¾ã™ã€‚```--create```ã¯ãƒªãƒã‚¸ãƒˆãƒªãŒãªã„ã¨ãã«ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°ã§ã™ã€‚

### Connectã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã™ã‚‹

å…¬é–‹ã—ãŸProtobufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦Goã®ã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ä»Šå›ã¯BufãŒé–‹ç™ºã—ã¦ã„ã‚‹[Connect](https://connectrpc.com/)ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

```
go mod init runn-connect-streaming-demo
```

æ¬¡ã«protoãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰Goã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã®ã«```buf.gen.yaml```ã‚’ä½œæˆã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã®protoãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã—ãã¯BSRã«å…¬é–‹ã—ãŸProtobufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒBSRã¯Protobufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å…¬é–‹ã—ãŸã¨ãã«å„ç¨®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦å„ç¨®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ä½¿ç”¨ã§ãã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãªã©ã‚’é€šã—ã¦ä¾å­˜é–¢ä¿‚ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚JSã€TSã§ã‚ã‚Œã°npmã§ã™ã—Goã§ã‚ã‚Œã°Goãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚ã¤ã¾ã‚ŠBSRã«å…¬é–‹ã—ã¦ã„ã‚Œã°**ã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆã¯ã‚‚ã¯ã‚„å¿…è¦ã‚ã‚Šã¾ã›ã‚“**ã€‚

ä»Šå›ã¯ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã™ã‚‹ã“ã¨ãªãGoãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¦å®Ÿè£…ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

```
go get buf.build/gen/go/jyapp/runndemo/connectrpc/go@latest
go get buf.build/gen/go/jyapp/runndemo/protocolbuffers/go@latest
go get connectrpc.com/connect
```

```go:main.go
package main

import (
	"context"
	"fmt"
	"net/http"

	"buf.build/gen/go/jyapp/runndemo/connectrpc/go/greet/v1/greetv1connect"
	"buf.build/gen/go/jyapp/runndemo/connectrpc/go/hello/v1/hellov1connect"
	"buf.build/gen/go/jyapp/runndemo/connectrpc/go/pubsub/v1/pubsubv1connect"
	greetv1 "buf.build/gen/go/jyapp/runndemo/protocolbuffers/go/greet/v1"
	hellov1 "buf.build/gen/go/jyapp/runndemo/protocolbuffers/go/hello/v1"
	pubsubv1 "buf.build/gen/go/jyapp/runndemo/protocolbuffers/go/pubsub/v1"
	"connectrpc.com/connect"
	"golang.org/x/net/http2"
	"golang.org/x/net/http2/h2c"
)

type GreetServer struct{}

func (g *GreetServer) Greet(
	ctx context.Context,
	req *connect.Request[greetv1.GreetRequest],
) (*connect.Response[greetv1.GreetResponse], error) {
	fmt.Println("call greet")
	return connect.NewResponse(&greetv1.GreetResponse{}), nil
}

type HelloServer struct{}

func (h *HelloServer) Hello(
	ctx context.Context,
	req *connect.Request[hellov1.HelloRequest],
) (*connect.Response[hellov1.HelloResponse], error) {
	fmt.Println("call hello")
	return connect.NewResponse(&hellov1.HelloResponse{}), nil
}

type PubSubServer struct{}

func (p *PubSubServer) Subscribe(
	ctx context.Context,
	req *connect.Request[pubsubv1.SubscribeRequest],
	stream *connect.ServerStream[pubsubv1.SubscribeResponse],
) error {
	return nil
}

func main() {
	var (
		greet  = &GreetServer{}
		hello  = &HelloServer{}
		pubsub = &PubSubServer{}
	)

	mux := http.NewServeMux()

	path, handler := greetv1connect.NewGreetServiceHandler(greet)
	mux.Handle(path, handler)

	path, handler = hellov1connect.NewHelloServiceHandler(hello)
	mux.Handle(path, handler)

	path, handler = pubsubv1connect.NewPubSubServiceHandler(pubsub)
	mux.Handle(path, handler)

	http.ListenAndServe(
		"localhost:8080",
		h2c.NewHandler(mux, &http2.Server{}),
	)
}

```

handlerã®ä¸­èº«ã¯ã¾ã ç©ºã®ã¾ã¾ã§ã™ãŒã€ä¸€æ—¦å‹•ä½œç¢ºèªã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«[evans](https://github.com/ktr0731/evans)ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚


```
% evans -p 8080 --proto proto/jyapp/runndemo/hello/v1/hello.proto 

  ______
 |  ____|
 | |__    __   __   __ _   _ __    ___
 |  __|   \ \ / /  / _. | | '_ \  / __|
 | |____   \ V /  | (_| | | | | | \__ \
 |______|   \_/    \__,_| |_| |_| |___/

 more expressive universal gRPC client


jyapp.runndemo.hello.v1.HelloService@127.0.0.1:8080> call Hello
message (TYPE_STRING) => aaa
{}

```

æ¬¡ã«Redisã®å°å…¥ã‚’ã—ã¦ã„ãã¾ã™ã€‚Redisã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯å…¬å¼ã®[go-redis](https://github.com/redis/go-redis)ã‚’ä½¿ã„ã¾ã™ã€‚

```
go get github.com/redis/go-redis/v9
```

```go:main.go
package main

import (
	"context"
	"fmt"
	"net/http"

	"buf.build/gen/go/jyapp/runndemo/connectrpc/go/greet/v1/greetv1connect"
	"buf.build/gen/go/jyapp/runndemo/connectrpc/go/hello/v1/hellov1connect"
	"buf.build/gen/go/jyapp/runndemo/connectrpc/go/pubsub/v1/pubsubv1connect"
	greetv1 "buf.build/gen/go/jyapp/runndemo/protocolbuffers/go/greet/v1"
	hellov1 "buf.build/gen/go/jyapp/runndemo/protocolbuffers/go/hello/v1"
	pubsubv1 "buf.build/gen/go/jyapp/runndemo/protocolbuffers/go/pubsub/v1"
	"connectrpc.com/connect"
	"github.com/redis/go-redis/v9"
	"golang.org/x/net/http2"
	"golang.org/x/net/http2/h2c"
)

const (
	greetChannel = "greet"
	helloChannel = "hello"
)

type GreetServer struct {
	redisClient *redis.Client
}

func (g *GreetServer) Greet(
	ctx context.Context,
	req *connect.Request[greetv1.GreetRequest],
) (*connect.Response[greetv1.GreetResponse], error) {
	fmt.Println("call greet")

	msg := fmt.Sprintf("Hi, %s", req.Msg.Message)
	if err := g.redisClient.Publish(ctx, greetChannel, msg).Err(); err != nil {
		return nil, connect.NewError(connect.CodeInternal, err)
	}

	return connect.NewResponse(&greetv1.GreetResponse{}), nil
}

type HelloServer struct {
	redisClient *redis.Client
}

func (h *HelloServer) Hello(
	ctx context.Context,
	req *connect.Request[hellov1.HelloRequest],
) (*connect.Response[hellov1.HelloResponse], error) {
	fmt.Println("call hello")

	msg := fmt.Sprintf("Hello, %s", req.Msg.Message)
	if err := h.redisClient.Publish(ctx, helloChannel, msg).Err(); err != nil {
		return nil, connect.NewError(connect.CodeInternal, err)
	}

	return connect.NewResponse(&hellov1.HelloResponse{}), nil
}

type PubSubServer struct {
	redisClient *redis.Client
}

func (p *PubSubServer) Subscribe(
	ctx context.Context,
	req *connect.Request[pubsubv1.SubscribeRequest],
	stream *connect.ServerStream[pubsubv1.SubscribeResponse],
) error {
	pubsub := p.redisClient.Subscribe(ctx, greetChannel, helloChannel)
	defer func() {
		_ = pubsub.Close()
	}()

	ch := pubsub.Channel()

	for {
		select {
		case msg := <-ch:
			fmt.Printf("channel: %s payload: %s\n", msg.Channel, msg.Payload)
			if err := stream.Send(&pubsubv1.SubscribeResponse{
				Message: msg.Payload,
			}); err != nil {
				return connect.NewError(connect.CodeInternal, err)
			}
		case <-ctx.Done():
			fmt.Println("context canceled")
			return nil
		}
	}
}

func main() {
	rdb := redis.NewClient(&redis.Options{})
	defer func() {
		_ = rdb.Close()
	}()

	var (
		greet  = &GreetServer{redisClient: rdb}
		hello  = &HelloServer{redisClient: rdb}
		pubsub = &PubSubServer{redisClient: rdb}
	)

	mux := http.NewServeMux()

	path, handler := greetv1connect.NewGreetServiceHandler(greet)
	mux.Handle(path, handler)

	path, handler = hellov1connect.NewHelloServiceHandler(hello)
	mux.Handle(path, handler)

	path, handler = pubsubv1connect.NewPubSubServiceHandler(pubsub)
	mux.Handle(path, handler)

	fmt.Println("start connect server...")

	http.ListenAndServe(
		"localhost:8080",
		h2c.NewHandler(mux, &http2.Server{}),
	)

	fmt.Println("end connect server...")
}

```

::: message
```Subscribe()```å†…ã®Redisã®Subscribeå‡¦ç†ã§ã™ãŒæœ€åˆä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã¾ã—ãŸãŒé–¢æ•°å†…ã®Redisã®SubscribeãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã¾ã¾æ®‹ã£ã¦ã—ã¾ã„è¤‡æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã™ã‚‹ã‚ˆã†ãªæŒ™å‹•ã‚’å–ã£ã¦ã—ã¾ã£ãŸãŸã‚contextã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚

```go
for msg := range ch
	fmt.Printf("channel: %s payload: %s\n", msg.Channel, msg.Payload)
	if err := stream.Send(&pubsubv1.SubscribeResponse{
		Message: msg.Payload,
	}); err != nil {
		return connect.NewError(connect.CodeInternal, err)
	}
}
```
:::

redisã¯dockerã§èµ·å‹•ã—ã¦ãŠãã¾ã™ã€‚

```
docker run --name runn-demo-redis -d -p 6379:6379 redis:7.2.5
```

èµ·å‹•ã§ããŸã‚‰å‹•ä½œç¢ºèªã‚’ã—ã¦ã¿ã¾ã™ã€‚

::: details Subscribe
```
evans -p 8080 --proto proto/jyapp/runndemo/pubsub/v1/pubsub.proto 

  ______
 |  ____|
 | |__    __   __   __ _   _ __    ___
 |  __|   \ \ / /  / _. | | '_ \  / __|
 | |____   \ V /  | (_| | | | | | \__ \
 |______|   \_/    \__,_| |_| |_| |___/

 more expressive universal gRPC client


jyapp.runndemo.pubsub.v1.PubSubService@127.0.0.1:8080> call Subscribe
```
:::

::: details greet
```
evans -p 8080 --proto proto/jyapp/runndemo/greet/v1/greet.proto proto/jyapp/runndemo/hello/v1/hello.proto 

  ______
 |  ____|
 | |__    __   __   __ _   _ __    ___
 |  __|   \ \ / /  / _. | | '_ \  / __|
 | |____   \ V /  | (_| | | | | | \__ \
 |______|   \_/    \__,_| |_| |_| |___/

 more expressive universal gRPC client


127.0.0.1:8080> package jyapp.runndemo.greet.v1

jyapp.runndemo.greet.v1@127.0.0.1:8080> service GreetService

jyapp.runndemo.greet.v1.GreetService@127.0.0.1:8080> call Greet
message (TYPE_STRING) => Connect!!
```

```
call greet
channel: greet payload: Hi, Connect!!
```
:::

:::details hello
```
jyapp.runndemo.greet.v1.GreetService@127.0.0.1:8080> package jyapp.runndemo.hello.v1

jyapp.runndemo.hello.v1@127.0.0.1:8080> service HelloService

jyapp.runndemo.hello.v1.HelloService@127.0.0.1:8080> call Hello
message (TYPE_STRING) => runn!!
{}
```

```
call hello
channel: hello payload: Hello, runn!!
```
:::

å•é¡Œãªã‘ã‚Œã°æ¬¡ã‹ã‚‰ã„ã‚ˆã„ã‚ˆrunnã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã„ãã¾ã™!

## runnã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ã

ã¾ãšã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚Macã§ã‚ã‚Œã°Homebrewã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
brew install k1LoW/tap/runn
```

runnã®è©³ã—ã„èª¬æ˜ã¯çœãã¾ã™ãŒãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã¨å‘¼ã°ã‚Œã‚‹yamlãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªãªã©ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãã—ã¦ã€runnã¯gRPCã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®[grpcurl](https://github.com/fullstorydev/grpcurl)ã‚’ä½¿ã£ã¦ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
runn new -- grpcurl localhost:8080 jyapp.runndemo.pubsub.v1.PubSubService/Subscribe  
desc: Generated by `runn new`
runners:
  greq: grpc://localhost:8080
steps:
- greq:
    jyapp.runndemo.pubsub.v1.PubSubService/Subscribe: {}
```

ä¸€æ—¦ã€ã“ã‚Œã‚’```books```é…ä¸‹ã«yamlãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦é…ç½®ã—ã¦ãŠãã¾ã™ã€‚

```
mkdir books
runn new -- grpcurl localhost:8080 jyapp.runndemo.pubsub.v1.PubSubService/Subscribe > books/pubsub.yaml
```

ä½œæˆã—ãŸãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```yaml:pubsub.yaml
desc: pubsub 
runners:
  greq:
    addr: localhost:8080
    tls: false
		bufDirs:
      - ../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
steps:
  pubsub:
    greq:
      jyapp.runndemo.pubsub.v1.PubSubService/Subscribe:
        message: {}
        timeout: 3sec # ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ãŸã»ã†ãŒè‰¯ã„
    # ã“ã“ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
    test: |
      current.res.status == 0
```

ã“ã‚Œã§gRPCãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨ã—ã¦```jyapp.runndemo.pubsub.v1.PubSubService/Subscribe```ã‚’ã‚³ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ä»Šå›ã¯Server Streamingã®ãŸã‚å‡¦ç†ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ã¦ãŠã„ãŸã»ã†ãŒã„ã„ã§ã—ã‚‡ã†ã€‚ã“ã‚Œã§ä¸€æ—¦å®Ÿè¡Œã—ã¦ã¿ã¾ã™

```
runn run books/pubsub.yaml
F

1) demo/runn-connect-streaming-demo/books/pubsub.yaml 2a8f84e6acc5743c11756c074ea9aef8d338b2e3
  Failure/Error: test failed on "pubsub".steps.pubsub: condition is not true
  
  Condition:
    current.res.status == 0
    
    â”‚
    â”œâ”€â”€ current.res.status => 4
    â””â”€â”€ 0
    
  Failure step (demo/runn-connect-streaming-demo/books/pubsub.yaml):
  10     greq:
  11       jyapp.runndemo.pubsub.v1.PubSubService/Subscribe:
  12         message: {}
  13         timeout: 3sec # ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ãŸã»ã†ãŒè‰¯ã„
  14     # ã“ã“ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
  15     test: |
  16       current.res.status == 0
```

Redisã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ã‘å–ã‚Œã¦ã„ãªã„ã®ã§å‡¦ç†ãŒãƒ–ãƒ­ãƒƒã‚¯ã—ãŸã¾ã¾ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

ã“ã®å‡¦ç†ãŒãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã„ã‚‹é–“ã«Redisã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚’è¡Œã„ã€Server Streamingã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ¤œè¨¼ã—ãŸã„ã¨ã„ã†ã®ãŒæœ¬è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«ã§ã™ã€‚Server Streamingã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­ã«ä»–ã®ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‹ã‚‰Redisã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã¯ã§ããªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

### ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­ã«ä»–ã®ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãŸã„

ã¨ã„ã†ã“ã¨ã§ã‚„ã£ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’æ–°ãŸã«ä½œæˆã—ã¾ã™ã€‚

```yaml:books/hello.yaml
desc: hello
runners:
  greq: 
    addr: localhost:8080
    tls: false
    bufDirs:
      - ../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
steps:
  hello:
    greq:
      jyapp.runndemo.hello.v1.HelloService/Hello: 
        message:
          message: from hello runbook!!
    test: |
      current.res.status == 0
```

ä»¥ä¸‹æ³¨æ„ç‚¹ã§ã™ã€‚

- buf CLIã®v2ã‚’ä½¿ç”¨ã—ã¦ã„ã¦runnã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„ã¨unsupportedã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ãã®å ´åˆã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ã‚‹ã€‚
- ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã™ã‚‹å ´åˆã€tlsã¯```false```ã‚’æŒ‡å®šã€‚
- ```bufDirs```ã«protobufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´æ‰€ã‚’æŒ‡å®šã™ã‚‹ã€‚
- ```bufDirs```ã¸ã®æŒ‡å®šã¯ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å®Ÿè¡Œå ´æ‰€ã‹ã‚‰ã®ãƒ‘ã‚¹ã«ãªã‚‹ã‚ˆã†ãªã®ã§è¦ªã®éšå±¤ã«ã‚ã‚‹å ´åˆã¯ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®šã™ã‚‹ã€‚

ã¨ã‚Šã‚ãˆãšã“ã‚Œã§å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
go run ./...
start connect server...
```

```
runn run books/hello.yaml
.

1 scenario, 0 skipped, 0 failures
```

```
call hello
```

runnçµŒç”±ã§ã‚µãƒ¼ãƒãƒ¼ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é£›ã°ã™ã“ã¨ã¯ã§ããŸã¿ãŸã„ã§ã™ã€‚ã§ã¯ã€ã“ã®ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’å…ˆã«ä½œã£ãŸpubsubã®ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã¨åŒæ™‚ã«å®Ÿè¡Œã§ãã‚Œã°ã†ã¾ãã„ããã†ã§ã™ã€‚

### ```--concurrent```ãƒ•ãƒ©ã‚°ã‚’ä½¿ã„ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹

runnã«ã¯```--concurrent```ãƒ•ãƒ©ã‚°ãŒç”¨æ„ã•ã‚Œã¦ã„ã¦ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å®Ÿè¡Œã‚’ä¸¦åˆ—ã«å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ã§äºŒã¤ã®ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’åŒæ™‚ã«å®Ÿè¡Œã§ããã†ã€‚

```
runn run books/*.yaml --concurrent on
```

ãŸã ã€Server StreamingãŒã¤ãªãŒã‚‹å‰ã«Redisã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®PublishãŒå®Ÿè¡Œã•ã‚Œã¦ã—ã¾ã†ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã§ããªãã¦ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ã—ã¾ã†ã®ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¹ãƒªãƒ¼ãƒ—å‡¦ç†ã‚’å…¥ã‚Œã¦Server StreamingãŒã¤ãªãŒã‚‹ã®ã‚’å¾…ã¡ã¾ã™ã€‚

```diff yaml:books/hello.yaml
desc: hello
runners:
  greq: 
    addr: localhost:8080
    tls: false
    bufDirs:
      - ../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
steps:
+ wait:
+   exec:
+    command: sleep 1
  hello:
    greq:
      jyapp.runndemo.hello.v1.HelloService/Hello: 
        message:
          message: From hello runbook!!
    test: |
      current.res.status == 0

```

å®Ÿè¡Œã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã«ãªã‚Šã¾ã™ã€‚

```
runn run --scopes run:exec books/*.yaml --concurrent on
```

ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã§ã™ã€‚

- sleepã®å‡¦ç†ã¯runnã®Executeãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
- Executeãƒ©ãƒ³ãƒŠãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã«```--scopes run:exec```ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
- ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’åŒæ™‚å®Ÿè¡Œã™ã‚‹ãŸã‚ã«```--concurrent on```ã‚’è¿½åŠ ã—ã¦å®Ÿè¡Œã™ã‚‹ã€‚

ä¸€æ—¦ã“ã®çŠ¶æ…‹ã§å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
runn run --scopes run:exec books/*.yaml --concurrent on
.F

1) demo/runn-connect-streaming-demo/books/pubsub.yaml 2a8f84e6acc5743c11756c074ea9aef8d338b2e3
  Failure/Error: test failed on "pubsub".steps.pubsub: condition is not true
  
  Condition:
    current.res.status == 0
    
    â”‚
    â”œâ”€â”€ current.res.status => 4
    â””â”€â”€ 0
```

å¤±æ•—ã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã“ã‚Œã¯```pubsub.yaml```ã®```test```ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ­£å¸¸çµ‚äº†ã§ã‚ã‚‹```0```ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã®ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ã‚ã‚‹```4```ã‚’å—ä¿¡ã—ã¦ã—ã¾ã£ãŸãŸã‚ã«å¤±æ•—ã—ã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã«ã¤ã„ã¦ã¯æ‚©ã‚“ã ã®ã§ã™ãŒä»Šã®å®Ÿè£…ã®ã¾ã¾ã§ã¯Server Streamingã®çµ‚äº†ã‚’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ã—ã‹ã§ããªã„ã®ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®æ¤œè¨¼ã‚’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ã‚ã‚‹```4```ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚å¤–éƒ¨ã‹ã‚‰Server Streamingã‚’æ­£å¸¸çµ‚äº†ã•ã›ã‚‹rpcã‚’è¿½åŠ ã™ã‚‹ãªã©ã‚‚è€ƒãˆãŸã®ã§ã™ãŒä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯Server Streamingã¯ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³åˆ‡æ–­ã—ãªã„é™ã‚Šå‡¦ç†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ç¶šã‘ã‚‹ã‚‚ã®ã¨ã—ã¦ä½œã£ã¦ã„ã‚‹ã®ã§å¤–éƒ¨ã‹ã‚‰åˆ‡æ–­ã§ãã‚‹ãƒ«ãƒ¼ãƒˆã‚’ä½œã‚ŠãŸããªã‹ã£ãŸã¨ã„ã†ã®ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»Šå›ã•ã»ã©é‡è¦ã§ã¯ãªã„ã¨ã„ã†ã®ãŒç†ç”±ã§ã™ã€‚

```diff yaml:books/pubsub.yaml
desc: pubsub 
runners:
  greq:
    addr: localhost:8080
    tls: false
    bufDirs:
      - ../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
steps:
  pubsub:
    greq:
      jyapp.runndemo.pubsub.v1.PubSubService/Subscribe:
        message: {}
        timeout: 3sec # ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ãŸã»ã†ãŒè‰¯ã„
    # ã“ã“ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
    test: |
-      current.res.status == 0
+      current.res.status == 4

```

ä¿®æ­£ã§ããŸã‚‰å†åº¦å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```
go run main.go
start connect server...
```

```
runn run --scopes run:exec books/*.yaml --concurrent on
..

2 scenarios, 0 skipped, 0 failures
```

```
call pubsub
call hello
channel: hello payload: Hello, from hello runbook!!
context canceled
```

æœŸå¾…ã—ãŸæŒ™å‹•ã«ãªã£ã¦ã„ãã†ã§ã™ï¼ï¼

æœ€å¾Œã«å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œè¨¼ã‚’è¿½åŠ ã—ã¦å†åº¦ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```diff yaml:books/pubsub.yaml
desc: pubsub 
runners:
  greq:
    addr: localhost:8080
    tls: false
    bufDirs:
      - ../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
steps:
  pubsub:
    greq:
      jyapp.runndemo.pubsub.v1.PubSubService/Subscribe:
        message: {}
        timeout: 3sec # ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ãŸã»ã†ãŒè‰¯ã„
    # ã“ã“ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
    test: |
      current.res.status == 4
+      && len(current.res.messages) == 1
+      && current.res.messages[0].message == 'Hello, from hello runbook!!'

```

```
runn run --scopes run:exec books/*.yaml --concurrent on
..

2 scenarios, 0 skipped, 0 failures
```

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ¤œè¨¼ã‚‚ã§ãã¾ã—ãŸï¼

### ```Greet```rpcã®ãƒ†ã‚¹ãƒˆã‚‚è¿½åŠ ã™ã‚‹

å‰å›ã¾ã§ã§```Hello```rpcã§Publishã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’```Subscribe```rpcã§å—ã‘å–ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã—ãŸã€‚æ¬¡ã«```Greet```rpcã§ã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

åŒã˜è¦é ˜ã§ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã¯ä½œæˆã§ãã‚‹ã¨æ€ã„ã¾ã™ãŒ```books/```é…ä¸‹ã®åŒã˜éšå±¤ã«ãƒ†ã‚¹ãƒˆã‚’ç½®ã„ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã™ã‚‹ã¨2ã¤ã®ãƒ†ã‚¹ãƒˆãŒç«¶åˆã—ã¦ã—ã¾ã„ã†ã¾ãè¡Œã‹ãªãã†ãªã®ã§æ–°ãŸã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦éšå±¤ã‚’åˆ†ã‘ãŸã„ã¨æ€ã„ã¾ã™ã€‚

```
mkdir hello greet
mv books/hello.yaml books/hello 
mv books/pubsub.yaml books/hello 
```

bufãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‘ã‚¹æŒ‡å®šãŒå¤‰ã‚ã‚‹ã®ã§ãã‚Œã‚‚ä¿®æ­£ã—ã¦ãŠãã¾ã™ã€‚

```diff yaml:books/hello/hello.yaml
desc: hello
runners:
  greq: 
    addr: localhost:8080
    tls: false
    bufDirs:
+      - ../../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
-      - ../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
    # importPaths:
    #   - ../proto/jyapp/runndemo/hello
steps:
  wait:
    exec:
      command: sleep 1
  hello:
    greq:
      jyapp.runndemo.hello.v1.HelloService/Hello: 
        message:
          message: from hello runbook!!
    test: |
      current.res.status == 0

```

```diff yaml:books/hello/pubsub.yaml
desc: pubsub 
runners:
  greq:
    addr: localhost:8080
    tls: false
    bufDirs:
+      - ../../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
-      - ../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
steps:
  pubsub:
    greq:
      jyapp.runndemo.pubsub.v1.PubSubService/Subscribe:
        message: {}
        timeout: 3sec # ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ãŸã»ã†ãŒè‰¯ã„
    # ã“ã“ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
    test: |
      current.res.status == 4
      && len(current.res.messages) == 1
      && current.res.messages[0].message == 'Hello, from hello runbook!!'

```

ä¸€æ—¦ã“ã®çŠ¶æ…‹ã§ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```
runn run --scopes run:exec books/hello/*yaml --concurrent on
..

2 scenarios, 0 skipped, 0 failures
```

å¤§ä¸ˆå¤«ãã†ã§ã™ã€‚

ã§ã¯ã€greetã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

```yaml:books/greet/greet.yaml
desc: greet
runners:
  greq: 
    addr: localhost:8080
    tls: false
    bufDirs:
      - ../../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
steps:
  wait:
    exec:
      command: sleep 1
  hello:
    greq:
      jyapp.runndemo.greet.v1.GreetService/Greet: 
        message:
          message: from greet runbook!!
    test: |
      current.res.status == 0

```

```yaml:books/greet/pubsub.yaml
desc: pubsub 
runners:
  greq:
    addr: localhost:8080
    tls: false
    bufDirs:
      - ../../proto # ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®å ´æ‰€ã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§æŒ‡å®š
steps:
  pubsub:
    greq:
      jyapp.runndemo.pubsub.v1.PubSubService/Subscribe:
        message: {}
        timeout: 3sec # ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ãŸã»ã†ãŒè‰¯ã„
    # ã“ã“ã§ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
    test: |
      current.res.status == 4
      && len(current.res.messages) == 1
      && current.res.messages[0].message == 'Hi, from greet runbook!!'
```

ä½œæˆã§ããŸã‚‰å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```
runn run --scopes run:exec books/greet/*yaml --concurrent on
..

2 scenarios, 0 skipped, 0 failures
```

è‰¯ã•ãã†ã§ã™ï¼ï¼

### å…¨ã¦ã®ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹

ä½œæˆã—ãŸãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®ãƒ†ã‚¹ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã‚ˆã†ã¨ã™ã‚‹ã¨```pubsub.yaml```ã§ä»–ã®ãƒ†ã‚¹ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å—ä¿¡ã—ã¦ã—ã¾ã„ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

```
runn run --scopes run:exec books/**/*yaml --concurrent on 
```

ãªã®ã§ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¯ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å˜ä½ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¨ã¯ã„ãˆãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã”ã¨ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã®ã‚‚é¢å€’ãªã®ã§ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã§ä¸€æ‹¬å®Ÿè¡Œã—ã¦ã¿ã¾ã—ãŸã€‚(ã“ã“ã§[ã‚·ã‚§ãƒ«ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼160æœ¬ãƒãƒƒã‚¯ã‚’èµ°ã‚Šåˆ‡ã£ãŸçµŒé¨“](https://sizu.me/junichi_y/posts/otb9b24vetk4)ãŒæ´»ãã¦ãã‚‹ã€‚ã‚·ã‚§ãƒ«ã«è‹¦æ‰‹æ„è­˜ã®ã‚ã‚‹æ–¹ãŠã™ã™ã‚ã§ã™ã‚ˆã€‚)

```
find books -type f -name "*.yaml" | sed 's|[^/]*$|*.yaml|' | uniq | xargs -I {} runn run --scopes run:exec {} --concurrent on  
..

2 scenarios, 0 skipped, 0 failures
..

2 scenarios, 0 skipped, 0 failures
```

ä½•åº¦ã‚‚å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã§ã‚ã‚Œã°Makefileãªã©ã«æ›¸ã„ã¦ãŠãã¨å®Ÿè¡ŒãŒæ¥½ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```Makefile
.PHONY: books
books:
	@find books -type f -name "*.yaml" | sed 's|[^/]*$$|*.yaml|' | uniq | xargs -I {} runn run --scopes run:exec {} --concurrent on
```

```$```ãŒMakefileå†…ã ã¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãŒå¿…è¦ãªã®ã¨ã‚¿ã‚¹ã‚¯åã‚’```books```ã¨ã™ã‚‹å ´åˆã¯ã™ã§ã«åŒã˜åå‰ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã®ã§```.PHONY: books```ã®è¨˜è¼‰ãŒå¿…è¦ãªç‚¹ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

```
make books  
..

2 scenarios, 0 skipped, 0 failures
..

2 scenarios, 0 skipped, 0 failures
```

ã„ã„æ„Ÿã˜ã§ã™ï¼

## ãŠã‚ã‚Šã«

ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã®ã‚ˆã†ãªã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…ã‚„ãƒ†ã‚¹ãƒˆã¯ä¸€èˆ¬çš„ãªAPIã¨æ¯”ã¹ã‚‹ã¨ã‚„ã¯ã‚Šè¤‡é›‘ã§é›£ã—ã„ã§ã™ã€‚ä»Šå›ã¯Server Streamingã‚’æ‰±ã„ã¾ã—ãŸãŒWebsocketã‚µãƒ¼ãƒãƒ¼ã¨Redisã®PubSubã‚’çµ„ã¿åˆã‚ã›ãŸã‚ˆã†ãªã‚ªãƒ³ãƒ©ã‚¤ãƒ³å‡¦ç†ã®ã»ã†ãŒã‚ˆã‚Šä¸€èˆ¬çš„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã“ã®ã‚ˆã†ãªãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã®ã‚ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹å ´åˆã€è¤‡æ•°ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒä¸¦è¡Œã§å‹•ä½œã—ã¦ã„ãŸã‚Šã™ã‚‹ãŸã‚ãƒ†ã‚¹ãƒˆæ¡ä»¶ã‚’æº€ãŸã™ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã®ã¯è¤‡é›‘ã«ãªã‚ŠãŒã¡ã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

ä»Šå›ç´¹ä»‹ã—ã¾ã—ãŸrunnã¯gRPCãƒ©ãƒ³ãƒŠãƒ¼ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã“ã¨ã§yamlãƒ™ãƒ¼ã‚¹ã§gRPCã‚µãƒ¼ãƒãƒ¼ã®ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ãŒã§ãã‚‹ã®ã¨Bufå¯¾å¿œã‚’ã—ã¦ãã‚Œã¦ã„ãŸã‚Šã€ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã®åŒæ™‚å®Ÿè¡Œã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¦ãã‚ŒãŸã‚Šã¨é«˜æ©Ÿèƒ½ãªãƒ„ãƒ¼ãƒ«ã¨ãªã£ã¦ãŠã‚Šã€ãã‚Œã‚‰ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã‚’ç°¡å˜ã«æ›¸ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ã—ã‹ã—ã€èª²é¡Œã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªç‚¹ãŒã‚ã‚‹ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒåŒæ™‚ã«å®Ÿè¡Œã§ããªã„ã®ã¨sleepå‡¦ç†ã‚’æŒŸã‚“ã§ã„ã‚‹ãŸã‚å®Ÿè¡Œæ™‚é–“ãŒé•·æ™‚é–“ã«ãªã£ã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œãªã„ã€‚
- Server Streamingã®çµ‚äº†ã‚’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§å®Ÿè¡Œã—ã¦ã„ã‚‹ãŸã‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®æ¤œè¨¼ãŒã§ããªã„ã€‚
- Publishã®ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’sleepã•ã›ã¦Server Streamingã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç¢ºç«‹å¾Œã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ãŒå®Œå…¨ãªåˆ¶å¾¡ã§ã¯ãªã„ã®ã§ä»Šå¾Œä¸éƒ½åˆãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„

ã¨ã¯ã„ãˆã€ç¾çŠ¶ã“ã®è¨˜äº‹ã§ç´¹ä»‹ã—ãŸã‚ˆã†ãªã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹ã«ã¯ååˆ†ã‹ãªã¨ã„ã†æ°—ã¯ã—ã¦ã¯ã„ã¾ã™ãŒã‚‚ã£ã¨ã„ã„æ–¹æ³•ã‚ã‚‹ã‚ˆã¨ã‹ãŒã‚ã‚Œã°ãœã²ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

ä»Šå›ã¯ä»¥ä¸Šã¨ãªã‚Šã¾ã™ğŸ¼

(BSRã«Protobufã‚’å…¬é–‹ã—ãŸã‘ã©runnã®Bufå¯¾å¿œã«ã¯ã‚ã¾ã‚Šé–¢ä¿‚ãªã‹ã£ãŸã®ã§å…¬é–‹ã—ãªãã¦ã‚‚è‰¯ã‹ã£ãŸã‹ã‚‚...)