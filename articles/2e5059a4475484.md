---
title: "kotlin Ã— Spring Ã— kotest Ã— testcontainersã§æ›¸ãã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ(gRPCç·¨)"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kotlin", "Spring", "kotest", "Testcontainers", "gRPC"]
published: true
---

1. [kotlin Ã— Spring Ã— kotest Ã— mockkã§æ›¸ããƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ](https://zenn.dev/jy8752/articles/7e88836c2bc1d0)
2. [kotlin Ã— Spring Ã— kotest Ã— testcontainersã§æ›¸ãã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ(Repositoryç·¨)](https://zenn.dev/jy8752/articles/f997a70c9ceaf3)
3. kotlin Ã— Spring Ã— kotest Ã— testcontainersã§æ›¸ãã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ(gRPCç·¨) <- ä»Šã“ã“

å‰å›ã®ç¶šãã§ä»Šå›ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¾ã§ã®ä¸€é€£ã®å‡¦ç†ã‚’ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã¨ã—ã¦æ›¸ã„ã¦ã¿ã¾ã™ã€‚ãŸã ç¹‹ã’ã‚‹ã ã‘ã‚‚ã¤ã¾ã‚‰ãªã„ã®ã§ä»Šå›ã¯gRPCã‚’å°å…¥ã—ã¦ã¿ã¾ã™ã€‚

## gRPCã‚’å®Ÿè£…ã™ã‚‹
ä»Šå›ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ã„ã¦ã¾ã™ã€‚
https://blog.takehata-engineer.com/entry/grpc-kotlin-with-grpc-spring-boot-starter

### build.gradle.ktsã‚’ä¿®æ­£
gRPCã®ä¾å­˜é–¢ä¿‚ãªã©ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚
```diff kotlin:build.gradle.kts
import com.google.protobuf.gradle.*
import org.jetbrains.kotlin.gradle.tasks.KotlinCompile

plugins {
	id("org.springframework.boot") version "2.7.0"
	id("io.spring.dependency-management") version "1.0.11.RELEASE"
	kotlin("jvm") version "1.6.21"
	kotlin("plugin.spring") version "1.6.21"

+	id("io.github.lognet.grpc-spring-boot") version "4.7.0"
+	id("com.google.protobuf") version "0.8.18"
}

group = "com.example"
version = "0.0.1-SNAPSHOT"
java.sourceCompatibility = JavaVersion.VERSION_17

repositories {
	mavenCentral()
}

extra["testcontainersVersion"] = "1.17.2"

+ val grpcKotlinVersion = "1.3.0"
+ val grpcVersion = "1.47.0"
+ val protobufVersion = "3.21.1"
+
+ protobuf {
+ 	protoc {
+ 		artifact = "com.google.protobuf:protoc:$protobufVersion"
+ 	}
+ 	plugins {
+ 		id("grpc") {
+ 			artifact = "io.grpc:protoc-gen-grpc-java:$grpcVersion"
+ 		}
+ 		id("grpckt") {
+ 			artifact = "io.grpc:protoc-gen-grpc-kotlin:$grpcKotlinVersion:jdk8@jar"
+ 		}
+ 	}
+ 	generateProtoTasks {
+ 		all().forEach { task ->
+ 			task.plugins {
+ 				id("grpc") { }
+ 				id("grpckt") { }
+ 			}
+ 		}
+ 	}
+ }

dependencies {
	implementation("org.springframework.boot:spring-boot-starter-data-mongodb")
	implementation("org.springframework.boot:spring-boot-starter-data-redis")
	implementation("org.springframework.boot:spring-boot-starter-web")
	implementation("com.fasterxml.jackson.module:jackson-module-kotlin")
	implementation("org.jetbrains.kotlin:kotlin-reflect")
	implementation("org.jetbrains.kotlin:kotlin-stdlib-jdk8")

+	implementation("io.github.lognet:grpc-spring-boot-starter:4.7.0")
+	implementation("io.grpc:grpc-kotlin-stub:$grpcKotlinVersion")
+	implementation("io.grpc:grpc-protobuf:$grpcVersion")
+	implementation("com.google.protobuf:protobuf-kotlin:$protobufVersion")

	testImplementation("org.springframework.boot:spring-boot-starter-test")
	testImplementation("org.testcontainers:junit-jupiter")
	testImplementation("org.testcontainers:mongodb")

	testImplementation(platform("io.kotest:kotest-bom:5.3.1"))
	testImplementation("io.kotest:kotest-runner-junit5")

	testImplementation("io.kotest.extensions:kotest-extensions-spring:1.1.1")

	testImplementation("io.mockk:mockk:1.12.4")

}

dependencyManagement {
	imports {
		mavenBom("org.testcontainers:testcontainers-bom:${property("testcontainersVersion")}")
	}
}

tasks.withType<KotlinCompile> {
	kotlinOptions {
		freeCompilerArgs = listOf("-Xjsr305=strict")
		jvmTarget = "17"
	}
}

tasks.withType<Test> {
	useJUnitPlatform()
}
```

## protoãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
ä»¥ä¸‹ã®ã‚ˆã†ãªprotoãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```protobuf:user.proto
syntax = "proto3";

option java_package = "com.example.testdemo.proto.user";
option java_multiple_files = true;

package user;

import "google/protobuf/empty.proto";

service User {
  rpc Register(CreateUserRequest) returns (UserResponse) {}
  rpc GetUser(GetUserRequest) returns (UserResponse) {}
  rpc GetUsers(google.protobuf.Empty) returns (UserListResponse) {}
}

message CreateUserRequest {
  string name = 1;
  int32 age = 2;
}

message UserResponse {
  string id = 1;
  string name = 2;
  int32 age = 3;
}

message GetUserRequest {
  string id = 1;
}

message UserListResponse {
  repeated UserResponse user_list = 1;
}
```

### ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ãŸprotoãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
```terminal
./gradlew generateProto
```

### GrpcServiceã®å®Ÿè£…
å…ˆã«å‰å›ã¾ã§ã«ä½œæˆã—ã¦ã„ãŸUserServiceã‚’ä¿®æ­£ã—ã¾ã™ã€‚
```diff kotlin:UserService
@Service
class UserService(
    private val userRepository: UserRepository
) {
    fun create(user: User): User {
        val document = this.userRepository.save(UserDocument(user))
        return User(document)
    }
+     fun getUser(id: String) = userRepository.findByIdOrNull(ObjectId(id))?.let { User(it) }
+ 
+     fun getUsers() = userRepository.findAll().map { User(it) }
}
```

æ¬¡ã«GrpcServiceã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
```kotlin:UserGrpcService
@GRpcService
class UserGrpcService(
    private val userService: UserService
) : UserGrpcKt.UserCoroutineImplBase() {
    override suspend fun register(request: CreateUserRequest): UserResponse {
        return this.userService.create(User(name = request.name, age = request.age)).toResponse()
    }

    override suspend fun getUser(request: GetUserRequest): UserResponse {
        return this.userService.getUser(request.id)?.toResponse() ?: UserResponse.getDefaultInstance()
    }

    override suspend fun getUsers(request: Empty): UserListResponse {
        val users = this.userService.getUsers().map { it.toResponse() }
        return UserListResponse.newBuilder().addAllUserList(users).build()
    }

    private fun User.toResponse(): UserResponse {
        return UserResponse.newBuilder()
            .setId(this.id.toString())
            .setName(this.name)
            .setAge(this.age)
            .build()
    }
}
```

ã“ã‚Œã§æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

## ãƒ†ã‚¹ãƒˆã‚’æ›¸ã
```kotlin:TestHelper.kt
fun getChannel(vararg interceptors: ClientInterceptor): ManagedChannel {
    return ManagedChannelBuilder.forAddress("localhost", 6565)
        .intercept(*interceptors)
        .usePlaintext()
        .build()
}
```

```kotlin:UserGrpcTest
@SpringBootTest
//@Transactional
internal class UserGrpcTest(
    private val userRepository: UserRepository
) : StringSpec({
    val stub: UserGrpcKt.UserCoroutineStub by lazy { UserGrpcKt.UserCoroutineStub(getChannel()) }

    fun buildCreateUserRequest(name: String = "user", age: Int = 32) = CreateUserRequest.newBuilder()
        .setName(name)
        .setAge(age)
        .build()
    fun buildGetUserRequest(id: String) = GetUserRequest.newBuilder()
        .setId(id)
        .build()
    fun buildUserResponse(id: String, name: String = "user", age: Int = 32) = UserResponse.newBuilder()
        .setId(id)
        .setName(name)
        .setAge(age)
        .build()

    afterTest { userRepository.deleteAll() }

    "User.Register" {
        val response = withContext(Dispatchers.Default) {
            stub.register(buildCreateUserRequest())
        }

        response shouldBe buildUserResponse(id = response.id)
    }
    "User.GetUser" {
        //given
        val savedDocument = userRepository.save(UserDocument(name = "user", age = 32))
        val savedId = savedDocument.id.toString()

        //when
        val response = async { stub.getUser(buildGetUserRequest(savedId)) }

        //then
        response.await() shouldBe buildUserResponse(id = savedId)
    }
    "User.GetUsers" {
        //given
        userRepository.save(UserDocument(name = "user1"))
        userRepository.save(UserDocument(name = "user2"))

        //when
        val response = stub.getUsers(Empty.getDefaultInstance())

        //then
        response.userListCount shouldBe 2
    }
})
```

ç‰¹ç­†ã™ã‚‹ã“ã¨ã¯ã‚ã¾ã‚Šãªã„ã®ã§ã™ãŒ1ç‚¹ã ã‘@Transactionalã‚’ã‚¯ãƒ©ã‚¹ã«ä»˜ä¸ã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒã†ã¾ãã„ãã¾ã›ã‚“ã§ã—ãŸã€‚æŒ™å‹•çš„ã«stubã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã¨ãã«ã¯å‰æ®µã§ç”¨æ„ã—ã¦ã„ãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚ˆã†ãªå‹•ãã§ã—ãŸã€‚kotestã¯Junitã‚ˆã‚Šã‚‚è¤‡é›‘ãªä½œã‚Šã«ãªã£ã¦ãŠã‚Šã€ã“ã¡ã‚‰ãŒäºˆæœŸã—ãŸé€šã‚Šã«ã¯å‹•ã„ã¦ãã‚Œãªã„æ§˜ã§ã™ã€‚(kotestã§ã„ã„æ„Ÿã˜ã«@Transactionalã‚’ä½¿ãˆã‚‹æ–¹æ³•ã”å­˜çŸ¥ã®æ–¹ã„ã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„ï¼)ä»¥å‰ã®è¨˜äº‹ã§æ›¸ã„ãŸã‚ˆã†ãªç°¡å˜ãªãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãªã‚‰å•é¡Œã¯è¦‹ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸãŒä»Šå›ã¯@Transactionalã¯ä½¿ç”¨ã›ãšã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¾Œã«æ‰‹å‹•ã§DBã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ã€‚

å°‘ã—å¤ã„ã§ã™ãŒåŒã˜ã‚ˆã†ãªè³ªå•ãŒã‚ã£ãŸã®ã§å‚è€ƒã¾ã§ã«
https://stackoverflow.com/questions/52776385/kotlintest-with-spring-test-transactional-not-working-applied

# ã¾ã¨ã‚
kotest, testcontainers, mockkãŒã‚ã‚Œã°å¤§ä½“ãƒ†ã‚¹ãƒˆæ›¸ãã®ã«å›°ã‚‰ãªã„ã€‚ä»¥ä¸Šï¼