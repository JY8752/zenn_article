---
title: "è¦‹ãªã„ã‚ˆã†ã«ã—ã¦ã„ãŸSpring Securityã®èªè¨¼å®Ÿè£…ã¨å‘ãåˆã£ãŸè©±(MVC)"
emoji: "ğŸ˜½"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kotlin", "Java", "Spring"]
published: true
---
æœ€è¿‘ã®Springã‚’ä½¿ã£ãŸå®Ÿè£…ã¯å¤§ä½“ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ä½•ã‹ã—ã‚‰ã§å‘¼ã°ã‚Œã‚‹æƒ³å®šã®APIå®Ÿè£…ãŒå¤šã„ã‘ã©èªè¨¼ã®å®Ÿè£…ã‚’ã¡ã‚ƒã‚“ã¨ã‚„ã£ãŸã“ã¨ãŒãªã‹ã£ãŸã®ã§è‰²ã€…èª¿ã¹ãŸã€‚
Spring Securityã¯SecurityConfigã‚’ä½œã£ã¦è‰²ã€…è¨­å®šã—ã¦ç‹¬è‡ªã§UserDetailså®Ÿè£…ã™ã‚‹ãã‚‰ã„ã®çŸ¥è­˜ã—ã‹ãªã‹ã£ãŸã®ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªç†ç”±ã§è¿·å®®å…¥ã‚Šã™ã‚‹ã€‚

- Spring Security5.7ã§æ›¸ãæ–¹ãŒçµæ§‹å¤‰ã‚ã£ã¦ã‚‹ã€‚
- Springã§å…¨éƒ¨æ›¸ã„ã¦ã‚‹æƒ³å®šã®ãƒ•ã‚©ãƒ¼ãƒ èªè¨¼ã®æ–¹æ³•ãŒã‚„ã£ã±ã‚Šå¤šã„ã€‚å¤ã‚ã®è¨˜äº‹ã¯å¤§ä½“ãã†
- SPAã¨ã‹ã®APIã¨ã—ã¦ã®Spring Securityã®èªè¨¼è¨˜äº‹ãŒå°‘ãªã„ã€‚
- Spring SecurityãŒåŸºæœ¬ã‚«ã‚¹ã‚¿ãƒ ã—ã¦å®Ÿè£…ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã¦ã€è‡ªç”±åº¦ãŒå‰²ã¨é«˜ãã€æ›¸ãæ–¹ãŒåŒã˜ã‚‚ã®ãŒæ„å¤–ã¨ãªã„ã€‚(ã¿ã‚“ãªå¾®å¦™ã«é•ã†)

Spring SecurityãŒç†ç”±ã§SpringãŒå«Œã„ã«ãªã‚‰ãªã„ã‚ˆã†ã«å®Ÿè£…æ–¹æ³•ã¨ãƒã‚¤ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
(SpringSecurityã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å®Œå…¨ã«ç†è§£ã—ãŸã‚ã‘ã§ã¯ãªã„ã®ã§é–“é•ã£ã¦ã‚‹ã¨ã“ã‚ãŒã‚ã‚Œã°ãƒã‚µã‚«ãƒªãã ã•ã„ãƒ¼)

å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰
https://github.com/JY8752/auth-kotlin-spring

# å¯¾è±¡èª­è€…
- Spring bootã‚ã‚‹ç¨‹åº¦ã‚ã‹ã‚‹äºº
- Spring Securityã®èªè¨¼å®Ÿè£…ã‚’ãªã‚“ã¨ãªãç†è§£ã—ã¦ã‚‹ãã‚‰ã„ã®äºº

# Spring Security5.7ã«ã¤ã„ã¦
ä»¥ä¸‹ã®è¨˜äº‹ã§é›°å›²æ°—ã¯æ´ã‚ã‚‹ã¯ãš
https://qiita.com/suke_masa/items/908805dd45df08ba28d8

# Sessionèªè¨¼

## å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

### login

```terminal
curl -X POST -H "Content-Type: application/json" -d '{"email": "test@test.com", "password": "password"}' localhost:8080/login -i -c cookie.txt

HTTP/1.1 200 
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Set-Cookie: SESSION=ZDE2NTkxNzQtYzk3NC00MDcxLTg4ZWQtNTFmYjg5NWRlOTZh; Path=/; HttpOnly; SameSite=Lax
Content-Length: 0
Date: Tue, 09 Aug 2022 15:19:59 GMT
```

### hello

```terminal
curl -i -b cookie.txt localhost:8080/hello                                                                                           

HTTP/1.1 200 
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Frame-Options: DENY
Content-Type: text/plain;charset=UTF-8
Content-Length: 5
Date: Tue, 09 Aug 2022 15:22:26 GMT

Hello%    
```

## å®Ÿè£…
èªè¨¼ã®å‡¦ç†ã¯UserDetailsServiceã‚’ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹ã‹ã€UsernamePasswordAuthenticationFilterã¨AuthenticationProviderã‚’å®Ÿè£…ã—ã¦ã™ã‚‹ã‹ãŒä¸€ç•ªè¦‹ã‹ã‘ã‚‹æ°—ãŒã™ã‚‹ã€‚
ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã¯AuthenticationProviderã‚’ã‚«ã‚¹ã‚¿ãƒ ã—ã¦èªè¨¼ã‚’è¡Œã†ã€‚
èªè¨¼ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¯SecurityContextHolderã®ä¸­ã®Authenticationå†…ã«ä¿æŒã•ã‚Œã¦ã‚‹ã®ã§ãã“ã‹ã‚‰èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ãŸã‚Šã‚‚ã™ã‚‹ã€‚
ã‚„ã£ã¦ã‚‹ã“ã¨ã¯ã–ã£ãã‚Šä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã€‚
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é€ã‚‰ã‚Œã¦æ¥ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’UsernamePasswordAuthenticationFilterã‚’ç¶™æ‰¿ã—ãŸç‹¬è‡ªã‚¯ãƒ©ã‚¹ã§UsernamePasswordAuthenticationTokenä½œæˆã™ã‚‹ã€‚
- authenticationManager#authenticationã‚’å‘¼ã³å‡ºã™ã€‚
- AuthenticationProviderã‚’ç¶™æ‰¿ã—ãŸç‹¬è‡ªã‚¯ãƒ©ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ã€UsernamePasswordAuthenticationTokenã‚’è¿”ã™ã€‚

è©³ã—ãçŸ¥ã‚ŠãŸã„äººã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒè©³ã—ãå®Ÿè£…è¿½ã£ã¦ã„ã¦ã¾ã˜ç¥
https://volkruss.com/?p=2727

### èªè¨¼å‡¦ç†

```kotlin:Authentication.kt
package com.example.mvcsessiondemo.config

import com.example.mvcsessiondemo.AuthenticationRequest
import com.fasterxml.jackson.databind.ObjectMapper
import org.springframework.security.authentication.AuthenticationManager
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken
import org.springframework.security.core.Authentication
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter
import javax.servlet.http.HttpServletRequest
import javax.servlet.http.HttpServletResponse

class AuthenticationFilter(
    authenticationManager: AuthenticationManager,
    private val objectMapper: ObjectMapper,
) : UsernamePasswordAuthenticationFilter(authenticationManager) {
    override fun attemptAuthentication(request: HttpServletRequest, response: HttpServletResponse?): Authentication {
        //ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦èªè¨¼æƒ…å ±ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
        val principal = this.objectMapper.readValue(request.inputStream, AuthenticationRequest::class.java)
        val authRequest = UsernamePasswordAuthenticationToken(principal.email, principal.password)
        this.setDetails(request, authRequest)
        return this.authenticationManager.authenticate((authRequest))
    }
}

data class AuthenticationRequest(
    val email: String,
    val password: String
)
```

```kotlin:AuthenticationProvider
package com.example.mvcsessiondemo.config

import org.springframework.security.authentication.UsernamePasswordAuthenticationToken
import org.springframework.security.core.Authentication
import org.springframework.stereotype.Component

/**
 * å®Ÿéš›ã®èªè¨¼å‡¦ç†ã‚’è¡Œã†ã‚¯ãƒ©ã‚¹
 */
@Component
class AuthenticationProvider : org.springframework.security.authentication.AuthenticationProvider {
    override fun authenticate(authentication: Authentication): Authentication {
        //å‰æ®µã®AuthenticationFilterã§è¨­å®šã—ãŸèªè¨¼æƒ…å ±ã‚’å–ã‚Šå‡ºã™
        val email = authentication.principal as String
        val password = authentication.credentials as String

        /** ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ¤œè¨¼ */

        val user = HelloUserDetails(email, password)
        return UsernamePasswordAuthenticationToken(user, null, emptyList())
    }

    override fun supports(authentication: Class<*>?): Boolean {
        return UsernamePasswordAuthenticationToken::class.java.isAssignableFrom(authentication)
    }
}
```

## SecurityConfigã®ä½œæˆ
AuthenticationManagerã‚’Beanç™»éŒ²ã—ã¦ç½®ã‹ãªã„ã¨å‹•ã‹ãªã„ã®ãŒå°‘ã—ã¯ã¾ã£ãŸã€‚

```kotlin:SecurityConfig.kt
package com.example.mvcsessiondemo.config

import com.fasterxml.jackson.databind.ObjectMapper
import org.springframework.context.annotation.Bean
import org.springframework.http.HttpStatus
import org.springframework.security.authentication.AuthenticationManager
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration
import org.springframework.security.config.annotation.web.builders.HttpSecurity
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder
import org.springframework.security.web.SecurityFilterChain
import org.springframework.security.web.util.matcher.AntPathRequestMatcher


@EnableWebSecurity
class SecurityConfig(
    private val authenticationProvider: AuthenticationProvider,
    private val objectMapper: ObjectMapper
) {
    @Bean
    fun securityFilterChain(http: HttpSecurity): SecurityFilterChain {
        http.csrf().disable()

        http.authorizeRequests()
            .antMatchers("/login").permitAll()
            .anyRequest().authenticated()

        return http.build()
    }

    @Bean
    fun authenticationFilter(
        authenticationManager: AuthenticationManager
    ): AuthenticationFilter {
        val authFilter = AuthenticationFilter(authenticationManager, this.objectMapper).also {
            it.setRequiresAuthenticationRequestMatcher(AntPathRequestMatcher("/login", "POST"))
            it.setAuthenticationSuccessHandler { _, response, _ -> response.status = HttpStatus.OK.value() }
        }
        return authFilter
    }

    @Bean
    fun authenticationManager(authenticationConfiguration: AuthenticationConfiguration): AuthenticationManager {
        return authenticationConfiguration.authenticationManager
    }

    @Bean
    fun passwordEncoder() = BCryptPasswordEncoder()
}
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è¨­å®š
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¿å­˜å…ˆã‚’Redisã«å¤‰æ›´ã™ã‚‹ã€‚
```kotlin:HttpSessionConfig.kt
package com.example.mvcsessiondemo.config

import org.springframework.context.annotation.Bean
import org.springframework.data.redis.connection.lettuce.LettuceConnectionFactory
import org.springframework.session.data.redis.config.annotation.web.http.EnableRedisHttpSession

@EnableRedisHttpSession
class HttpSessionConfig {
    @Bean
    fun connectionFactory() = LettuceConnectionFactory()
}
```

ä¾å­˜é–¢ä¿‚ã«ä»¥ä¸‹ã®è¿½åŠ ãŒå¿…è¦

```kotlin:build.gradle.kts
	//Redis
	implementation("org.springframework.boot:spring-boot-starter-data-redis")
	implementation("org.springframework.session:spring-session-data-redis")
```

# JWTã‚’ä½¿ã£ãŸèªè¨¼
APIã¨ã—ã¦ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚ˆã‚Šã‚‚ãƒˆãƒ¼ã‚¯ãƒ³ã«ã‚ˆã‚‹èªè¨¼ã®æ–¹ãŒä½¿ã‚ã‚Œã‚‹ã®ã‹ãªï¼Ÿ
JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã¦èªè¨¼å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã¿ã‚‹ã€‚

## å®Œæˆã‚¤ãƒ¡ãƒ¼ã‚¸

### login

```terminal
curl -X POST -H "Content-Type: application/json" -d '{"username": "user", "password": "password"}' localhost:8080/login -i                                                                                                          

HTTP/1.1 200 
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Authorization: Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyIiwiaWF0IjoxNjYwMTE0MjYyLCJleHAiOjE2NjAxNDMwNjJ9.tF0Y0leK749jOsEPKRtrcJmHEkKgO_oYtniY6fmqo44sGp3Sg6Po0G5ERi-5g88RrFpuFz0idFreNnq3vox1aA
X-Content-Type-Options: nosniff
```

### hello

```terminal
curl localhost:8080/hello -v -H "Authorization: Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyIiwiaWF0IjoxNjYwMTE0MjYyLCJleHAiOjE2NjAxNDMwNjJ9.tF0Y0leK749jOsEPKRtrcJmHEkKgO_oYtniY6fmqo44sGp3Sg6Po0G5ERi-5g88RrFpuFz0idFreNnq3vox1aA"

*   Trying ::1:8080...
* Connected to localhost (::1) port 8080 (#0)
> GET /hello HTTP/1.1
> Host: localhost:8080
> User-Agent: curl/7.77.0
> Accept: */*
> Authorization: Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyIiwiaWF0IjoxNjYwMTE0MjYyLCJleHAiOjE2NjAxNDMwNjJ9.tF0Y0leK749jOsEPKRtrcJmHEkKgO_oYtniY6fmqo44sGp3Sg6Po0G5ERi-5g88RrFpuFz0idFreNnq3vox1aA
> 
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 
< Vary: Origin
< Vary: Access-Control-Request-Method
< Vary: Access-Control-Request-Headers
< Set-Cookie: JSESSIONID=B1AB9DDB852B51FB63A2F7F247765DEA; Path=/; HttpOnly
< X-Content-Type-Options: nosniff
< X-XSS-Protection: 1; mode=block
< Cache-Control: no-cache, no-store, max-age=0, must-revalidate
< Pragma: no-cache
< Expires: 0
< X-Frame-Options: DENY
< Content-Type: text/plain;charset=UTF-8
< Content-Length: 5
< Date: Wed, 10 Aug 2022 07:41:00 GMT
< 
* Connection #0 to host localhost left intact
Hello%   
```

## å®Ÿè£…
ã“ã¡ã‚‰ã®è¨˜äº‹ãŒå¤§å¤‰å‚è€ƒã«ãªã‚Šã¾ã—ãŸï¼
https://qiita.com/nyasba/items/f9b1b6be5540743f8bac

- ã‚»ãƒƒã‚·ãƒ§ãƒ³èªè¨¼ã®æ™‚ã¨åŒã˜UsernamePasswordAuthenticationFilterã‚’ç¶™æ‰¿ã—ãŸç‹¬è‡ªã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã€UsernamePasswordAuthenticationTokenã‚’ä½œæˆã™ã‚‹ã®ã¯åŒã˜ã€‚
- èªè¨¼ãŒæˆåŠŸã—ãŸã¨ãã®å‡¦ç†ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«ç”Ÿæˆã—ãŸJWTã‚’è¨­å®šã™ã‚‹ã€‚
- èªè¨¼ä»¥å¤–ã®å…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãŠã„ã¦JWTæ¤œè¨¼ã‚’ã™ã‚‹ã‚ˆã†ã«ã‚‚ã†ä¸€ã¤ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒ ã—è¿½åŠ ã™ã‚‹ã€‚

JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã™ã‚‹ã®ã«ä»¥ä¸‹è¿½åŠ ã€‚

```kotlin:build.gradle.kts
    //jjwt
    implementation("io.jsonwebtoken:jjwt-api:0.11.5")
    implementation("io.jsonwebtoken:jjwt-impl:0.11.5")
    implementation("io.jsonwebtoken:jjwt-jackson:0.11.5")
```

ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆã—ãŸã‚Šãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™æ¤œè¨¼ã—ãŸã‚Šã¨ã‹ã‚ã‚‹ã®ã§å…ˆã«ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã€‚

```kotlin:JWTUtils.kt
package com.example.mvcjwtdemo.utils

import io.jsonwebtoken.Claims
import io.jsonwebtoken.Jwts
import io.jsonwebtoken.security.Keys
import java.util.*

class JWTUtils {
    companion object {
        private const val secret = "ThisIsSecretForJWTHS512SignatureAlgorithmThatMUSTHave64ByteLength"
        private const val expirationTime = "28800" //sec

        private val key by lazy { Keys.hmacShaKeyFor(secret.toByteArray()) }

        /**
         * tokenã‹ã‚‰Claim(ã‚­ãƒ¼ã¨å€¤ã®ãƒšã‚¢)ã‚’å–å¾—ã™ã‚‹
         */
        fun getAllClaimsFromToken(token: String): Claims? {
            return Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .body
        }

        /**
         * ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã™ã‚‹
         */
        fun getUsernameFromToken(token: String): String {
            return getAllClaimsFromToken(token)?.subject ?: ""
        }

        /**
         * ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰æœ‰åŠ¹æœŸé™ã‚’å–å¾—ã™ã‚‹
         */
        fun getExpirationDateFromToken(token: String): Date? {
            return getAllClaimsFromToken(token)?.expiration
        }

        /**
         * ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½œæˆã™ã‚‹
         */
        fun generateToken(username: String): String {
            val expirationTimeLong = expirationTime.toLong()
            val createdDate = Date()
            val expirationDate = Date(createdDate.time + expirationTimeLong * 1000)

            return Jwts.builder()
                .setSubject(username)
                .setIssuedAt(createdDate)
                .setExpiration(expirationDate)
                .signWith(key)
                .compact()
        }

        /**
         * ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ã‹æ¤œè¨¼ã™ã‚‹
         */
        fun validateToken(token: String) = !isTokenExpired(token)

        private fun isTokenExpired(token: String): Boolean {
            val expiration = getExpirationDateFromToken(token) ?: run {
                return true
            }
            return expiration.before(Date())
        }
    }
}
```

## èªè¨¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

```kotlin:AuthenticationFilter.kt
package com.example.mvcjwtdemo.security

import com.example.mvcjwtdemo.utils.JWTUtils
import com.fasterxml.jackson.databind.ObjectMapper
import org.springframework.http.HttpHeaders
import org.springframework.security.authentication.AuthenticationManager
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken
import org.springframework.security.core.Authentication
import org.springframework.security.core.userdetails.UserDetails
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter
import javax.servlet.FilterChain
import javax.servlet.http.HttpServletRequest
import javax.servlet.http.HttpServletResponse

/**
 * å®Ÿéš›ã«èªè¨¼å‡¦ç†ã‚’ã™ã‚‹ã‚¯ãƒ©ã‚¹
 */
class Authenticationfilter(
    authenticationManager: AuthenticationManager,
    private val objectMapper: ObjectMapper
) : UsernamePasswordAuthenticationFilter() {
    init {
        this.authenticationManager = authenticationManager
    }

    override fun attemptAuthentication(request: HttpServletRequest, response: HttpServletResponse?): Authentication {
        val authRequest = this.objectMapper.readValue(request.inputStream, AuthRequest::class.java)
        return this.authenticationManager.authenticate(
            UsernamePasswordAuthenticationToken(
                authRequest.username,
                authRequest.password,
                emptyList()
            )
        )
    }

    /**
     * èªè¨¼ãŒæˆåŠŸã—ãŸã¨ãã®å‡¦ç†
     */
    override fun successfulAuthentication(
        request: HttpServletRequest,
        response: HttpServletResponse,
        chain: FilterChain,
        authResult: Authentication
    ) {
        val user = authResult.principal as UserDetails
        val token = JWTUtils.generateToken(user.username)

        response.addHeader(HttpHeaders.AUTHORIZATION, "Bearer $token")
    }
}

data class AuthRequest(
    val username: String,
    val password: String
)
```

## èªå¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

```kotlin:AuthorizationFilter.kt
package com.example.mvcjwtdemo.security

import com.example.mvcjwtdemo.utils.JWTUtils
import org.springframework.http.HttpHeaders
import org.springframework.security.authentication.AuthenticationManager
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken
import org.springframework.security.core.context.SecurityContextHolder
import org.springframework.security.web.authentication.www.BasicAuthenticationFilter
import javax.servlet.FilterChain
import javax.servlet.http.HttpServletRequest
import javax.servlet.http.HttpServletResponse

/**
 * èªå¯ã®å‡¦ç†
 */
class AuthorizationFilter(authenticationManager: AuthenticationManager) :
    BasicAuthenticationFilter(authenticationManager) {
    override fun doFilterInternal(request: HttpServletRequest, response: HttpServletResponse, chain: FilterChain) {
        val token = request.getHeader(HttpHeaders.AUTHORIZATION).let {
            if (it == null || !it.startsWith("Bearer ")) {
                chain.doFilter(request, response)
                return
            }
            it.substring(7)
        }

        if (!JWTUtils.validateToken(token)) {
            chain.doFilter(request, response)
            return
        }

        val username = JWTUtils.getUsernameFromToken(token)
        //principalã‚’userDetailsã«ã™ã‚Œã°SecurityContextHolderã‹ã‚‰å–å¾—ã§ãã‚‹ã‹ãª??
        val authentication =
            UsernamePasswordAuthenticationToken(HelloUserDetails(username, "password"), null, emptyList())
        SecurityContextHolder.getContext().authentication = authentication

        chain.doFilter(request, response)
    }
}
```

## SecurityConfig

```kotlin:SecurityConfig.kt
@EnableWebSecurity
class SecurityConfig {
    @Bean
    fun securityFilterChain(
        http: HttpSecurity,
        authenticationManager: AuthenticationManager,
        objectMapper: ObjectMapper
    ): SecurityFilterChain {
        http.cors()

        http.authorizeRequests()
            .antMatchers("/login").permitAll()
            .anyRequest().authenticated()

        http.csrf().disable()

        http.addFilter(AuthorizationFilter(authenticationManager))
        http.addFilter(Authenticationfilter(authenticationManager, objectMapper))

        return http.build()
    }

    @Bean
    fun passwordEncoder() = BCryptPasswordEncoder()

    @Bean
    fun authenticationManager(authenticationConfiguration: AuthenticationConfiguration): AuthenticationManager {
        return authenticationConfiguration.authenticationManager
    }
}
```

# ã¾ã¨ã‚
SpringSecurityã®æ§‹æˆã‚¯ãƒ©ã‚¹ã¯å¤šã„ã†ãˆã«ç¶™æ‰¿é–¢ä¿‚ã¨ã‹ã‚ã£ã¦å‡¦ç†ã®æµã‚ŒãŒé ­ã«å…¥ã£ã¦ã„ãªã„ã¨ã¾ã˜ã§ã‚ã‹ã‚“ãªããªã‚‹ã‘ã©ã€å¤§ã¾ã‹ã«ã¯ã‚„ã£ã¦ã‚‹ã“ã¨ã¯ä¸€ç·’ã€‚(ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰èªè¨¼æƒ…å ±å–ã‚Šå‡ºã—ã¦èªè¨¼ã€‚èªè¨¼ã™ã‚‹å ´æ‰€ã‚„æ–¹æ³•ãŒå¾®å¦™ã«å¤‰ã‚ã‚‹ã€èªè¨¼ã—ãŸæƒ…å ±ã¯å–ã‚Šå‡ºã›ã‚‹ã€‚)
ä»Šå›ã®å®Ÿè£…ã§ã–ã£ãã‚Šèªè¨¼ã®æµã‚Œã‚’ã¤ã‹ã‚ãŸã®ã§æ¬¡ã¯OAuthã®èªè¨¼ã¨ã‹ã‚‚è§¦ã£ã¦è¦‹ãŸã„ã‘ã©ã‚‚ã†ãŠè…¹ã„ã£ã±ã„ãªã®ã§ã¾ãŸæ¬¡å›ã€‚
ä¸€å¿œã€WebFluxç‰ˆã§ã‚‚å®Ÿè£…ã—ãŸã®ã§ãã®è¨˜äº‹ã‚‚æ›¸ãäºˆå®šã€‚

SpringSecurityã¯æ€–ããªã„ã‹ã‚‰Java(kotlin)ã‚’å«Œã„ã«ãªã‚‰ãªã„ã§ã­ï¼ï¼