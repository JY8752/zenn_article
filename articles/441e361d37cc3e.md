---
title: "[protovalidte徹底解析] Protobufをバリデーションしてより安全でドキュメント性の高いスキーマ駆動開発をしよう"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["protovalidate", "Buf", "Protocolbuffers", "gRPC", "Go"]
published: false
---

最近Protocol Buffersの開発体験の向上のために熱意を注いでいるBufが気になってます。

Protobufのバリデーションとして[protoc-gen-validate](https://github.com/bufbuild/protoc-gen-validate)(PGV)というものがあったようですがこのPGVの完全な後継として[protovalidate](https://github.com/bufbuild/protovalidate)がリリースされており、この開発を引き継いだのもBufです。

このprotovalidateはPGV同様、Protobufスキーマファイルに制約を記述しますが評価式に[CEL](https://cel.dev/overview/cel-overview?hl=ja)(Common Expression Language)を採用しており、初見だと難しさを感じてしまう気がしました。

本記事ではBufとProtobufの布教の一環としてprotovalidateの使い方を完全に網羅するチートシートを公開することでprotovalidateの利用を広めたいというのが目的です。

記事の内容は基本的には以下のスクラップをまとめたものです。

https://zenn.dev/jy8752/scraps/f65173fdd1844b

Bufについて詳しく知りたいと言う方は以下をご参照ください

https://zenn.dev/jy8752/books/33743f8091c39d

## 使用技術

- Buf CLI v1.3.2
- Go go version go1.22.0 darwin/arm64

## protovalidateについて

Protobufのスキーマをバリデーションする方法として前述したprotoc-gen-validate(PGV)が使われてきたようです。EnvoyのプロジェクトがJSONスキーマからProtobufへの移行を開始する際に制約を定義する方法としてPGVが選ばれ2019年にEnvoyに開発が移行しました。そして、2022年にBufにメンテナンスが引き継がれPGVは十分に安定しており、すでにその役割を終えたとして、後継のprotovalidateの開発を進めています。

詳しくはこちらの公式ブログでより詳細に説明されていますので興味がある方はご覧ください

https://buf.build/blog/protoc-gen-validate-v1-and-v2/

protovalidateの大きな特徴として値の評価式を書くためにGoogleが開発したCEL(Common Expression Language)を採用し、より柔軟な検証ルールが定義できるようになっています。protovalidateの主な目的は**コードを生成することなくデータの一貫性と整合性を確保できるようにすること**としている。

CELに関しては後述のcel制約の説明でより詳しく説明します。

また、protovalidateはPGVの機能を全てサポートしているためPGVからprotovalidateへの移行機能も用意されていますし、これから新規で採用を考えているならばprotovalidateを採用することを推奨しています。

## protovalidateの導入ガイド

簡単なサンプルコードを用意してprotovalidateの使い方を紹介します。まずは以下のコマンドを実行してProtobufモジュールの初期化を行います。Protobufモジュールの開発にはBuf CLIを使用します。

```
mkdir proto
cd proto
buf config init
```

```
mkdir -p example/hello/v1
touch example/hello/v1/hello.proto
```

```
tree .
.
├── buf.yaml
└── example
    └── hello
        └── v1
            └── hello.proto
```

```buf.yaml```にprotovalidateの依存関係を追加します。

```diff yaml:buf.yaml
version: v2
+deps:
+  - buf.build/bufbuild/protovalidate
lint:
  use:
    - DEFAULT
breaking:
  use:
    - FILE
```

追加できたら```buf dep update```を実行して依存関係をダウンロードします。この際に```buf.lock```ファイルが作成されます。

```
buf dep update
WARN	Module buf.build/bufbuild/protovalidate is declared in your buf.yaml deps but is unused. This command only modifies buf.lock files, not buf.yaml files. Please remove buf.build/bufbuild/protovalidate from your buf.yaml deps if it is not needed.
```

警告が出るかもしれませんがこの段階では無視で大丈夫です。ここまでで以下のようなディレクトリになっているはずです。

```
% tree .
.
├── buf.lock
├── buf.yaml
└── example
    └── hello
        └── v1
            └── hello.proto
```

:::message
BSR(Buf Schema Registry)にログインしていなければ```buf registry login```を実行してログインしてから依存関係の更新を実行してください。BSRのアカウントがまだなければ作成してください。BSRのログインにはユーザー名とBSRのマイページから作成できるトークンが必要です。
:::

次に```hello.proto```を以下のように実装します。

```protobuf:hello.proto
syntax = "proto3";

package example.hello.v1;

import "buf/validate/validate.proto";

message Hello { string hello = 1 [ (buf.validate.field).string.min_len = 1 ]; }
```

ポイントは2つあってまず依存関係に追加したprotovalidateをimportすることと、```Hello```messageのoption指定で```(buf.validate.field).string.min_len = 1```のように制約を追加することです。

このoption指定について細かく見ていくと```buf/validate/validate.proto```内で定義されている```FieldConstraints```というmessageをフィールドに追加しており、```FieldConstratins.StringRules.min_len```というフィールドの値を```1```で上書きしています。このようにすることで```Hello.hello```の文字列長は1文字以上が保証されるためゼロ値が混入しないことを保証することができます。

```FieldConstraints```などは以下に定義されていますので興味がある方は見てみるといいかもしれません

https://github.com/bufbuild/protovalidate/blob/main/proto/protovalidate/buf/validate/validate.proto

ちなみに、VSCodeでBufを使ったProtobufを書く場合、Bufの拡張機能を使うことができますがprotovalidateのimportで以下のような警告が出てしまうかもしれません。

![](https://storage.googleapis.com/zenn-user-upload/886bf918c86c-20240525.png)

これがでたらbufのVSCodeプラグインではなくvscode-proto3プラグイン起因でのエラーらしく、このエラーを消すにはBufのモジュールキャッシュをvscode-proto3プラグインのインポートに指定するといいようです。

```json
  "protoc": {
    "options": ["-I=~/.cache/buf/v1/module/data/buf.build"]
  }
```

https://github.com/bufbuild/vscode-buf/issues/10#issuecomment-962526162

## Protobufを検証する(protovalidate-go)

ここまでで制約のついたProtobufスキーマを作成することができたため、次にスキーマの検証をしてみたいと思います。執筆時点でprotovalidateをサポートしているのは以下の言語です。

- Go: [protovalidate-go](https://github.com/bufbuild/protovalidate-go) (beta release)
- C++: [protovalidate-cc](https://github.com/bufbuild/protovalidate-cc) (beta release)
- Java: [protovalidate-java](https://github.com/bufbuild/protovalidate-java) (beta release)
- Python: [protovalidate-python](https://github.com/bufbuild/protovalidate-python) (beta release)
- TypeScript: protovalidate-ts (coming soon)

今回は```protovalidate-go```を使ってGoのプログラムで検証してみたいと思います。前回のHello.protoを使用していきます。

```
go mod init protovalidate-demo
touch main.go
```

```
go get github.com/bufbuild/protovalidate-go
```

```
tree .
.
├── go.mod
├── go.sum
├── main.go
└── proto
    ├── buf.lock
    ├── buf.yaml
    └── example
        └── hello
            └── v1
                └── hello.proto
```

コード生成にはBuf CLIを使いますので以下のように```buf.gen.yaml```を作成します。

```yaml:buf.gen.yaml
version: v2
managed:
  enabled: true
  override:
    - file_option: go_package_prefix
      value: protovalidate-demo/gen
  disable:
    - module: buf.build/bufbuild/protovalidate
      file_option: go_package_prefix
plugins:
  - remote: buf.build/protocolbuffers/go:v1.34.1
    out: gen
    opt: paths=source_relative
```

作成できたら以下のコマンドでコードを生成します。

```
buf generate proto
```



## protovalidate制約一覧

### message

### oneof

### string

### bool

### bytes

### 数値型

### enum

### map

### repeated

### ```google.protobuf.Any```

### ```google.protobuf.Duration```

### ```google.protobuf.Timestamp```

### required

### ignore

### cel

## protovalidateにコントリビュートしたい