---
title: "[protovalidte徹底解析] Protobufをバリデーションしてより安全でドキュメント性の高いスキーマ駆動開発をしよう"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["protovalidate", "Buf", "Protocolbuffers", "gRPC", "Go"]
published: false
---

最近Protocol Buffersの開発体験の向上のために熱意を注いでいるBufが気になってます。

Protobufのバリデーションとして[protoc-gen-validate](https://github.com/bufbuild/protoc-gen-validate)(PGV)というものがあったようですがこのPGVの完全な後継として[protovalidate](https://github.com/bufbuild/protovalidate)がリリースされており、この開発を引き継いだのもBufです。

このprotovalidateはPGV同様、Protobufスキーマファイルに制約を記述しますが評価式に[CEL](https://cel.dev/overview/cel-overview?hl=ja)(Common Expression Language)を採用しており、初見だと難しさを感じてしまう気がしました。

本記事ではBufとProtobufの布教の一環としてprotovalidateの使い方を完全に網羅するチートシートを公開することでprotovalidateの利用を広めたいというのが目的です。

記事の内容は基本的には以下のスクラップをまとめたものです。

https://zenn.dev/jy8752/scraps/f65173fdd1844b

Bufについて詳しく知りたいと言う方は以下をご参照ください

https://zenn.dev/jy8752/books/33743f8091c39d

## 使用技術

- Buf CLI v1.3.2
- Go go version go1.22.0 darwin/arm64

## protovalidateについて

Protobufのスキーマをバリデーションする方法として前述したprotoc-gen-validate(PGV)が使われてきたようです。EnvoyのプロジェクトがJSONスキーマからProtobufへの移行を開始する際に制約を定義する方法としてPGVが選ばれ2019年にEnvoyに開発が移行しました。そして、2022年にBufにメンテナンスが引き継がれPGVは十分に安定しており、すでにその役割を終えたとして、後継のprotovalidateの開発を進めています。

詳しくはこちらの公式ブログでより詳細に説明されていますので興味がある方はご覧ください

https://buf.build/blog/protoc-gen-validate-v1-and-v2/

protovalidateの大きな特徴として値の評価式を書くためにGoogleが開発したCEL(Common Expression Language)を採用し、より柔軟な検証ルールが定義できるようになっています。protovalidateの主な目的は**コードを生成することなくデータの一貫性と整合性を確保できるようにすること**としている。

CELに関しては後述のcel制約の説明でより詳しく説明します。

また、protovalidateはPGVの機能を全てサポートしているためPGVからprotovalidateへの移行機能も用意されていますし、これから新規で採用を考えているならばprotovalidateを採用することを推奨しています。

## protovalidateの導入ガイド

簡単なサンプルコードを用意してprotovalidateの使い方を紹介します。まずは以下のコマンドを実行してProtobufモジュールの初期化を行います。Protobufモジュールの開発にはBuf CLIを使用します。

```
mkdir proto
cd proto
buf config init
```

```
mkdir -p example/hello/v1
touch example/hello/v1/hello.proto
```

```
tree .
.
├── buf.yaml
└── example
    └── hello
        └── v1
            └── hello.proto
```

```buf.yaml```にprotovalidateの依存関係を追加します。

```diff yaml:buf.yaml
version: v2
+deps:
+  - buf.build/bufbuild/protovalidate
lint:
  use:
    - DEFAULT
breaking:
  use:
    - FILE
```

追加できたら```buf dep update```を実行して依存関係をダウンロードします。この際に```buf.lock```ファイルが作成されます。

```
buf dep update
WARN	Module buf.build/bufbuild/protovalidate is declared in your buf.yaml deps but is unused. This command only modifies buf.lock files, not buf.yaml files. Please remove buf.build/bufbuild/protovalidate from your buf.yaml deps if it is not needed.
```

警告が出るかもしれませんがこの段階では無視で大丈夫です。ここまでで以下のようなディレクトリになっているはずです。

```
% tree .
.
├── buf.lock
├── buf.yaml
└── example
    └── hello
        └── v1
            └── hello.proto
```

:::message
BSR(Buf Schema Registry)にログインしていなければ```buf registry login```を実行してログインしてから依存関係の更新を実行してください。BSRのアカウントがまだなければ作成してください。BSRのログインにはユーザー名とBSRのマイページから作成できるトークンが必要です。
:::

次に```hello.proto```を以下のように実装します。

```protobuf:hello.proto
syntax = "proto3";

package example.hello.v1;

import "buf/validate/validate.proto";

message Hello { string hello = 1 [ (buf.validate.field).string.min_len = 1 ]; }
```

ポイントは2つあってまず依存関係に追加したprotovalidateをimportすることと、```Hello```messageのoption指定で```(buf.validate.field).string.min_len = 1```のように制約を追加することです。

このoption指定について細かく見ていくと```buf/validate/validate.proto```内で定義されている```FieldConstraints```というmessageをフィールドに追加しており、```FieldConstratins.StringRules.min_len```というフィールドの値を```1```で上書きしています。このようにすることで```Hello.hello```の文字列長は1文字以上が保証されるためゼロ値が混入しないことを保証することができます。

```FieldConstraints```などは以下に定義されていますので興味がある方は見てみるといいかもしれません

https://github.com/bufbuild/protovalidate/blob/main/proto/protovalidate/buf/validate/validate.proto

ちなみに、VSCodeでBufを使ったProtobufを書く場合、Bufの拡張機能を使うことができますがprotovalidateのimportで以下のような警告が出てしまうかもしれません。

![](https://storage.googleapis.com/zenn-user-upload/886bf918c86c-20240525.png)

これがでたらbufのVSCodeプラグインではなくvscode-proto3プラグイン起因でのエラーらしく、このエラーを消すにはBufのモジュールキャッシュをvscode-proto3プラグインのインポートに指定するといいようです。

```json
  "protoc": {
    "options": ["-I=~/.cache/buf/v1/module/data/buf.build"]
  }
```

https://github.com/bufbuild/vscode-buf/issues/10#issuecomment-962526162

## Protobufを検証する(protovalidate-go)

ここまでで制約のついたProtobufスキーマを作成することができたため、次にスキーマの検証をしてみたいと思います。執筆時点でprotovalidateをサポートしているのは以下の言語です。

- Go: [protovalidate-go](https://github.com/bufbuild/protovalidate-go) (beta release)
- C++: [protovalidate-cc](https://github.com/bufbuild/protovalidate-cc) (beta release)
- Java: [protovalidate-java](https://github.com/bufbuild/protovalidate-java) (beta release)
- Python: [protovalidate-python](https://github.com/bufbuild/protovalidate-python) (beta release)
- TypeScript: protovalidate-ts (coming soon)

今回は```protovalidate-go```を使ってGoのプログラムで検証してみたいと思います。前回のHello.protoを使用していきます。

```
go mod init protovalidate-demo
touch main.go
```

```
go get github.com/bufbuild/protovalidate-go
```

```
tree .
.
├── go.mod
├── go.sum
├── main.go
└── proto
    ├── buf.lock
    ├── buf.yaml
    └── example
        └── hello
            └── v1
                └── hello.proto
```

コード生成にはBuf CLIを使いますので以下のように```buf.gen.yaml```を作成します。

```yaml:buf.gen.yaml
version: v2
managed:
  enabled: true
  override:
    - file_option: go_package_prefix
      value: protovalidate-demo/proto
  disable:
    - module: buf.build/bufbuild/protovalidate
      file_option: go_package_prefix
plugins:
  - remote: buf.build/protocolbuffers/go:v1.34.1
    out: gen
    opt: paths=source_relative
```

作成できたら以下のコマンドでコードを生成します。

```
buf generate proto
```

```yaml:buf.gen.yaml
tree .
.
├── buf.gen.yaml
├── gen
│   └── example
│       └── hello
│           └── v1
│               └── hello.pb.go
├── go.mod
├── go.sum
├── main.go
└── proto
    ├── buf.lock
    ├── buf.yaml
    └── example
        └── hello
            └── v1
                └── hello.proto
```

コードが生成できたら以下のようにmain.goに実装します。

```go:main.go
package main

import (
	"fmt"
	hellov1 "protovalidate-demo/gen/example/hello/v1"

	"github.com/bufbuild/protovalidate-go"
)

func main() {
	msg := &hellov1.Hello{
		Hello: "",
	}

	v, err := protovalidate.New()
	if err != nil {
		panic(err)
	}

	if err = v.Validate(msg); err != nil {
		fmt.Println("validation failed:", err)
	} else {
		fmt.Println("validation succeeded")
	}
}

```

空のmessageを生成して```Validate()```で検証しています。このプログラムを実行してみましょう。

```
go run main.go

validation failed: validation error:
 - hello: value length must be at least 1 characters [string.min_len]
```

最小文字列長が1で設定されているため空のmessageはバリデーションエラーになりました！

このバリデーション検証はどこか一箇所で全てのリクエストに対して実行できるとよいでしょう。BufのConnectを使っているのであれば以下のライブラリを使うことで全てのリクエストを検証するインターセプターを簡単に追加することができます。

https://github.com/connectrpc/validate-go

## protovalidate制約一覧

protovalidateの制約にはCELで評価式を書くカスタム制約とprotovalidateが用意した検証ルールを使う標準制約の２パターンが存在します。

また、制約はmessageのフィールドに対してだけでなくmessage自体に対して設定することもできますがmessageのフィールドに対しての制約が全てのデータ型に対して用意されているため、フィールド単位でのバリデーションルールを書くことが多くなるでしょう。以下でprotovalidateで用意された制約を紹介していきます。

### message

[MessageConstraints](https://buf.build/bufbuild/protovalidate/docs/main:buf.validate#buf.validate.MessageConstraints)として定義されている。

#### disabled

messageに指定できる制約は執筆時点で以下のような```disabled```だけです。

```protobuf
message DisabledExample {
  option (buf.validate.message).disabled = true;
  // このバリデーションは無効化される
  string val = 1 [ (buf.validate.field).string.min_len = 1 ];
}
```

### oneof

```google.protobuf.OneofOptions```を拡張し、[OneofConstraints](https://buf.build/bufbuild/protovalidate/docs/main:buf.validate#buf.validate.OneofConstraints)型の新しいフィールドを追加します。執筆時点でOneofConstraintsに用意されている制約フィールドは```required```のみです。

#### required

この制約はoneofで値が最低一つは指定されることを保証するための制約です。

```protobuf
message OneofExample {
  oneof union {
    option (buf.validate.oneof).required = true;
    string val1 = 1;
    string val2 = 2;
  }
}
```

### フィールド制約

```google.protobuf.FieldOptions```を拡張して[FieldConstraints](https://buf.build/bufbuild/protovalidate/docs/main:buf.validate#buf.validate.FieldConstraints)型の新しいオプションの名前付きフィールドを追加することで、Messageのフィールドに対して制約を記述することができます。

FieldConstraintsでは以下のように各データ型ごとに用意された検証ルールを一つ持つようになっている。

```protobuf
oneof type {
		// Scalar Field Types
		FloatRules float = 1;
		DoubleRules double = 2;
		Int32Rules int32 = 3;
		Int64Rules int64 = 4;
		UInt32Rules uint32 = 5;
		UInt64Rules uint64 = 6;
		SInt32Rules sint32 = 7;
		SInt64Rules sint64 = 8;
		Fixed32Rules fixed32 = 9;
		Fixed64Rules fixed64 = 10;
		SFixed32Rules sfixed32 = 11;
		SFixed64Rules sfixed64 = 12;
		BoolRules bool = 13;
		StringRules string = 14;
		BytesRules bytes = 15;
		// Complex Field Types
		EnumRules enum = 16;
		RepeatedRules repeated = 18;
		MapRules map = 19;
		// Well-Known Field Types
		AnyRules any = 20;
		DurationRules duration = 21;
		TimestampRules timestamp = 22;
	}
```

### string

```StringRules```で定義されている文字列型の値に対する検証ルールです。

#### const

```protobuf
  // const_value = "const" ok
  // const_value = "const1" NG
  string const_value = 1 [ (buf.validate.field).string.const = "const" ];
```

#### len, min_len, max_len



### bool

### bytes

### 数値型

### enum

### map

### repeated

### ```google.protobuf.Any```

### ```google.protobuf.Duration```

### ```google.protobuf.Timestamp```

### required

### ignore

### cel

## protovalidateにコントリビュートしたい