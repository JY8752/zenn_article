---
title: "gRPCé–‹ç™ºã«ãŠã‘ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GitLab", "gRPC"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã®gRPCã«ã¤ã„ã¦ã®èª¬æ˜ãŒå°‘ã—å¤ããªã£ã¦ãã¾ã—ãŸã€‚protocã«ä»£ã‚ã‚‹Bufã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦æœ¬ã‚’æ›¸ã„ãŸã®ã§ã‚ˆã‘ã‚Œã°ã“ã¡ã‚‰ã‚‚ã”å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/jy8752/books/33743f8091c39d
:::

gRPCã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãŸã‚ã®å‚™å¿˜éŒ²ã§ã™ã€‚

GitHub Actionsã§å®Ÿè¡Œã—ãŸå ´åˆã¯ã“ã¡ã‚‰ã‚’å‚ç…§

https://zenn.dev/jy8752/articles/294dc9a64c18f3

## ãªãœã‚„ã‚‹ã‹
gRPCã®é–‹ç™ºã«ãŠã‘ã‚‹ãƒ¡ãƒªãƒƒãƒˆã®ä¸€ã¤ã«ã‚¹ã‚­ãƒ¼ãƒé§†å‹•ã®é–‹ç™ºã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚protoãƒ•ã‚¡ã‚¤ãƒ«ãŒå…¨ã¦ãªã®ã§rpcã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã‘ã‚Œã°protoãƒ•ã‚¡ã‚¤ãƒ«è¦‹ã‚Œã°ã„ã„ã˜ã‚ƒã‚“å‹¢ã§ã—ãŸãŒã€ã€Œã“ã®Fieldä½•ï¼Ÿã€ã¨ã‹ã€Œã“ã®rpcã¯ã©ã†ã„ã†ã‚¨ãƒ©ãƒ¼åãã®ï¼Ÿã€ã¨ã‹èã‹ã‚ŒãŸã¨ãã«å…¨ç„¶protoãƒ•ã‚¡ã‚¤ãƒ«è¦‹ã¦ã‚‚ã‚ã‹ã‚“ãªã„ãªã¨ãªã‚Šã€åˆ¥é€”æ‰‹å‹•ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†ã™ã‚‹ã®ã¯ã‚„ã‚ŠãŸããªã‹ã£ãŸã®ã§ä½•ã‹ã„ã„æ–¹æ³•ãªã„ã‹ãªã¨èª¿ã¹ãŸã¨ãã«protoc-gen-docã®å­˜åœ¨ã‚’çŸ¥ã‚Šã¾ã—ãŸã€‚protoãƒ•ã‚¡ã‚¤ãƒ«ã¯çµ¶å¯¾æ›¸ãã“ã¨ã«ãªã‚‹ã®ã§protoãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±é‡ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§å¢—ã‚„ã—ã€ãã“ã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚Œã°å®Ÿè£…è€…ã®è² æ‹…ã‚‚æ¸›ã‚‹ã—ã€ä½¿ã†å´ã‚‚æœ€æ–°ã®æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ã—win-winã ãªã¨æ€ã„å°å…¥ã€‚ã‚‚ã—ã€ãƒãƒ¼ãƒ å†…ã§æ¡ç”¨ã™ã‚‹ã®ã§ã‚ã‚Œã°protoãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒ«ãƒ¼ãƒ«ã‚’äº‹å‰ã«æ±ºã‚ã¦ãŠãã“ã¨ã§å®Ÿéš›ã«protoãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨ãã«æ‚©ã¾ãªã„ã¨æ€ã„ã¾ã™ã€‚

## protocbufã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
brew update
brew upgrade
brew install protobuf
brew upgrade protobuf

protoc --version
> libprotoc 3.19.4
```

## protoc-gen-docã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
go version
> go version go1.18.3 darwin/arm64

go install github.com/pseudomuto/protoc-gen-doc/cmd/protoc-gen-doc@latest
```

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
(./docãƒ•ã‚©ãƒ«ãƒ€ã¯äº‹å‰ã«ä½œæˆã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚)
```
protoc \
  --doc_out=./doc \
  --doc_opt=markdown,index.md \
  ./**/*.proto
```

å•é¡Œãªã‘ã‚Œã°./doc/index.mdãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

## pushæ™‚ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹
ä»Šå›ã¯GitLabã®CI/CDã‚’ä½¿ç”¨ã—ã¾ã™ãŒGitHub Actionsãªã©ã§ã‚‚åŒã˜æ„Ÿã˜ã§ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãªgitlab-ci.ymlã‚’ä½œæˆã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ãŸå¾Œã«ã‚³ãƒŸãƒƒãƒˆã—ç›´ã™å¿…è¦ãŒã‚ã‚‹ã®ã§ssh, gitã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®šã‚‚å¿…è¦ã€‚ã‚ã¨ã€mainãƒ–ãƒ©ãƒ³ãƒã®protoãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã‚ã£ãŸæ™‚ã«æ¡ä»¶çµã£ã¦ã¾ã™ã€‚

:::message
äº‹å‰ã«GitLabã®ã€ŒSettings > Repository > Deploy keyã€ã«ç”Ÿæˆã—ãŸå…¬é–‹éµã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚Grant write permissions to this keyã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãŠã„ã¦ãã ã•ã„ã€‚åŠ ãˆã¦ã€ã€ŒSettings > CI/CD > Variablesã€ã«å…ˆã»ã©ç™»éŒ²ã—ãŸéµã®å¯¾ã¨ãªã‚‹ç§˜å¯†éµã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚keyã®åå‰ã¯ãªã‚“ã§ã‚‚ã„ã„ã§ã™ãŒã€ŒSSH_PRIVATE_KEYã€ã§ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚
:::
```yaml:gitlab-ci.yml
# protoc-gen-docã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«Goã‚’ä½¿ã†ã®ã§Goã®dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨
image: golang:latest

stages:
  - build

protoc-gen-doc:
  stage: build
  script: 
    - apt-get update && apt-get install -y unzip sudo openssh-server git
    # protocolbufã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - curl -OL https://github.com/google/protobuf/releases/download/v3.19.4/protoc-3.19.4-linux-x86_64.zip
    - unzip protoc-3.19.4-linux-x86_64.zip -d protoc3
    - sudo mv protoc3/bin/* /usr/local/bin/
    - sudo mv protoc3/include/* /usr/local/include/
    # protoc-gen-docã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - go install github.com/pseudomuto/protoc-gen-doc/cmd/protoc-gen-doc@latest
    # sshã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H "$CI_SERVER_HOST" >> ~/.ssh/known_hosts
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | ssh-add - > /dev/null
    # gitã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - git config user.name $GITLAB_USER_NAME
    - git config user.email $GITLAB_USER_EMAIL
    - git remote set-url --push origin git@$CI_SERVER_HOST:$CI_PROJECT_PATH.git
    - git checkout $CI_COMMIT_REF_NAME
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
    - ./generate-document.sh
  artifacts:
    paths:
      - doc/
  rules:
    - changes: 
      - "**/*.proto"
      if: '$CI_COMMIT_REF_NAME == "main"'
      when: on_success
```

```sh:generate-document.sh
#!/bin/bash

# docãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãªã‘ã‚Œã°ä½œã‚‹
if [ ! -d ./doc ]; then
  mkdir ./doc
fi

# ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ(markdownã¨htmlã®2ç¨®é¡ã‚’ç”Ÿæˆ)
protoc \
  --doc_out=./doc \
  --doc_opt=html,index.html \
  ./**/*.proto

protoc \
  --doc_out=./doc \
  --doc_opt=markdown,index.md \
  ./**/*.proto

# ã”ã¿å‰Šé™¤
if [ -d ./protoc3 ]; then
  rm -r protoc3
fi

if [ -e protoc-3.19.4-linux-x86_64.zip ]; then
  rm protoc-3.19.4-linux-x86_64.zip
fi

# å·®åˆ†ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆã—ç›´ã™
if [ `git status -s | wc -l` -gt 0 ]; then
  git add ./doc
  git commit -m 'update document'
  git push --push-option=ci.skip origin $CI_COMMIT_REF_NAME
  
  echo "Success commit"
else
  echo "Exit due to no difference"
fi
```

protoãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã‚‹çŠ¶æ…‹ã§pushã‚’ã—ã€GitLabã®jobãŒæˆåŠŸã—ã¦ã„ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸã€‚ã“ã‚“ãªæ„Ÿã˜
![](https://storage.googleapis.com/zenn-user-upload/0c62ea87aaf9-20220627.png)


## ãŠã¾ã‘(GitLab pagesã§å…¬é–‹ã™ã‚‹)
htmlå½¢å¼ã§ã‚‚å‡ºåŠ›ã‚’ã—ã¦ã„ãŸã®ã§GitLab pagesã«ã¦å…¬é–‹ã—ã¦ã¿ã‚‹ã€‚gitlab-ci.ymlã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã€‚
```diff yaml:gitlab-ci.yml
image: golang:latest

stages:
  - build
+  - deploy

protoc-gen-doc:
  stage: build
  script: 
    - apt-get update && apt-get install -y unzip sudo openssh-server git
    # protocolbufã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - curl -OL https://github.com/google/protobuf/releases/download/v3.19.4/protoc-3.19.4-linux-x86_64.zip
    - unzip protoc-3.19.4-linux-x86_64.zip -d protoc3
    - sudo mv protoc3/bin/* /usr/local/bin/
    - sudo mv protoc3/include/* /usr/local/include/
    # protoc-gen-docã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - go install github.com/pseudomuto/protoc-gen-doc/cmd/protoc-gen-doc@latest
    # sshã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H "$CI_SERVER_HOST" >> ~/.ssh/known_hosts
    - eval "$(ssh-agent -s)"
    - echo "$SSH_PRIVATE_KEY" | ssh-add - > /dev/null
    # gitã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - git config user.name $GITLAB_USER_NAME
    - git config user.email $GITLAB_USER_EMAIL
    - git remote set-url --push origin git@$CI_SERVER_HOST:$CI_PROJECT_PATH.git
    - git checkout $CI_COMMIT_REF_NAME
    # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
    - ./generate-document.sh
  artifacts:
    paths:
      - doc/
  rules:
    - changes: 
      - "**/*.proto"
      if: '$CI_COMMIT_REF_NAME == "main"'
      when: on_success

+pages:
+  stage: deploy
+  dependencies:
+    - protoc-gen-doc
+  script:
+    - mv doc/ public/
+  artifacts:
+    paths:
+      - public
+  rules:
+    - if: '$CI_COMMIT_REF_NAME == "main"'
+      when: on_success
+    - when: never
```

:::message alert
å…¬é–‹URLã«ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå«ã¾ã‚Œã‚‹ãŒ.(ãƒ‰ãƒƒãƒˆ)ãŒå«ã¾ã‚Œã‚‹ã¨SSLã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€ãã®å ´åˆã¯ã‚°ãƒ«ãƒ¼ãƒ—å†…ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç§»ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—åã§å…¬é–‹URLã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
:::

ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚è¨­å®šã§ãã¦ã€GitLabã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«å…¬é–‹ã‚‚ã§ãã‚‹ã®ã§ãƒãƒ¼ãƒ å†…ã®ã¿ã«å…¬é–‹ã¨ã‹ã‚‚ã§ãã‚‹ã—ã€é€†ã«èª°ã§ã‚‚è¦‹ã‚Œã‚‹ã‚ˆã†ã«å…¬é–‹ã‚‚ã§ãã‚‹ã€‚å‚è€ƒã¾ã§ã«ä½œæˆã—ãŸã‚‚ã®ã¯ã“ã¡ã‚‰ã§ã™ã€‚
https://my-app11.gitlab.io/test-proto/

ä»¥ä¸Šï¼