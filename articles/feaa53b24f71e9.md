---
title: "rbコマンドを使ったrubyワンライナーの世界"
emoji: "💎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ruby", "rb", "shell"]
published: false
---

本記事ではワンライナーでrubyを使うための**rb**というコマンドについて紹介する記事です。

## モチベーション

[1日1問、半年以内に習得 シェル・ワンライナー160本ノック](https://www.amazon.co.jp/1%E6%97%A51%E5%95%8F%E3%80%81%E5%8D%8A%E5%B9%B4%E4%BB%A5%E5%86%85%E3%81%AB%E7%BF%92%E5%BE%97-%E3%82%B7%E3%82%A7%E3%83%AB%E3%83%BB%E3%83%AF%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%8A%E3%83%BC160%E6%9C%AC%E3%83%8E%E3%83%83%E3%82%AF-Software-Design-plus%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA/dp/4297122677)という技術書の中でrubyを使用したワンライナーが紹介されていました。Mac標準のsedやawkといったコマンドはBSD系のコマンドであり、LinuxなどのGNU系のコマンドと挙動が違うことが多く、オプション覚えるのも大変だったのでそういったときはrubyを使用してワンライナーを書いてみました。

PerlやPythonによるワンライナーも紹介されていたのですが、Perlはまったく知識0だったので今から新たに学ぶのがしんどかったのとPythonhはワンライナーで書きづらそうだったためrubyなら少しはわかるのでrubyを選択しました。

rubyをワンライナーで使用したのは初めてだったのですが、書いてみたらとても楽しく、rubyでいい感じにワンライナーを書くための**rb**というコマンドの存在を知ったので布教と備忘録をかねて本記事を書いています。

## rubyでワンライナー

先に簡単にrubyでのワンライナーの書き方の紹介です。基本的には```ruby```コマンドに```-e```オプションを付け、実行したいスクリプトを渡してあげるとrubyで書いた処理を実行することができます。

```
% ruby -e 'puts "Hello Ruby Oneliner!!"'
Hello Ruby Oneliner!!
```

ワンライナーでrubyを使う場合は以下のように標準入力を処理することが多くなると思います。標準入力は```ARGF```というファイルオブジェクトを扱うことで処理することができます。ARGFは特殊なオブジェクトであり、Enumerableモジュールをミックスインしてるため```each```や```map```といった処理が可能です。

```
% seq 1 10 | ruby -e 'ARGF.each{|num| puts num.to_i * 2}'
2
4
6
8
10
12
14
16
18
20
```

```-n```オプションをつけると標準入力を１行ずつ処理することができます。この場合```$_```という変数に文字列で行データが格納されることになります。

```
% seq 1 10 | ruby -ne 'puts $_.to_i * 2'                   
2
4
6
8
10
12
14
16
18
20
```

```-n```オプションと合わせて使われるのに```-l```オプションがあります。このオプションは行単位で処理するときに行データの末尾の改行を自動で取り除いてくれるオプションのようなのですが筆者はいまいち理解できなかったので以下のようなワンライナーを考えてみます。

```
% seq 1 10 | ruby -ne 'BEGIN{a=""};a+=$_ if $_.to_i % 2 == 0;END{puts a}'  
2
4
6
8
10
```

1−10の範囲の数値を標準入力で渡して偶数のみを変数に格納して出力しています。この場合、各行データの末尾には改行が付いているので改行されて出力されます。これに```-l```オプションをつけてみます。

```
% seq 1 10 | ruby -lne 'BEGIN{a=""};a+=$_ if $_.to_i % 2 == 0;END{puts a}'
246810
```

改行されずに横一列で出力されました。これは各行データの末尾の改行が除去された状態で変数に追加されていったためです。また、```-l```オプションをつけると```print```などで出力するときに改行を自動で入れてくれます。改行があることで予期せぬ挙動を生むこともあるので基本```-n```オプションを使う時はつけてもいいかもしれません。もしくは、```-n```オプションを使うときに思った挙動にならないときにつけてもいいかもしれません。

awkなどに慣れている方は問題ないと思いますが上記の例のように```BEGIN```と```END```ブロックを使用することで集計処理なども書くことができます。

```-p```オプションは```-n```オプションの機能に加え最後に```print $_```を実行してくれます。標準入力に対して破壊的変更を加えるときに便利。

```
% echo {a..z} | ruby -pe '$_.upcase!'
A B C D E F G H I J K L M N O P Q R S T U V W X Y Z
```

```-n```オプションまたは```-p```オプションを使用する時は```$.```という変数に行番号が格納されます。

```
% seq 11 20 | ruby -lne 'print "#{$.} #{$_}"'
1 11
2 12
3 13
4 14
5 15
6 16
7 17
8 18
9 19
10 20
```

```-a```オプションは```-n```もしくは```-p```オプションと合わせて使用することで```$F```という変数に```$.split```の結果が代入される。このオプションを使用するときの区切り文字は空白もしくはタブですが```-F```オプションを使用することで区切り文字を変更することが可能です。

```
% echo {a..z} | ruby -ane '$F.each{|str|print str.upcase};puts'
ABCDEFGHIJKLMNOPQRSTUVWXYZ

% ruby -e 'puts ("a".."z").to_a.join(",")' | ruby -F, -ane '$F.each{|str|print str.upcase}'
ABCDEFGHIJKLMNOPQRSTUVWXYZ
```

```-r```オプションを使用することでrubyの標準ライブラリを読み込んで使用することができます。

```
# unライブラリを使用してwebサーバーを起動
% ruby -run -e httpd -- -p 8888 .

# jsonライブラリを使用
% echo '{"lang": "Ruby"}' | ruby -rjson -ne 'puts JSON.parse($_)["lang"]'
Ruby
```

