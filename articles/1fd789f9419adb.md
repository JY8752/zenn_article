---
title: "Springã®ä»£ã‚ã‚Šã‚’æ±‚ã‚ãŸå…ˆã«~Ktor + Exposed~"
emoji: "ğŸ‘Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kotlin", "Spring", "Ktor", "Exposed"]
published: true
---
ä¸€å¿œã“ã‚Œã®ç¶šã
https://zenn.dev/jy8752/articles/a4bc17f14e1b70

ä»Šå›ã®æˆæœç‰©
https://github.com/JY8752/ktor-demo

# ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨
kotlin + Spring bootã®çµ„ã¿åˆã‚ã›ã§æ™®æ®µé–‹ç™ºã‚’ã—ã¦ã„ã¦Springã§ãªã„è»½ã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§é–‹ç™ºã—ãŸããªã£ãŸã€‚ãã®å€™è£œã¨ã—ã¦quarkus, micronaut, Ktorã‚’é †ç•ªã«è§¦ã£ã¦ã¿ã¦ãã®æ¯”è¼ƒã€æœ€çµ‚ç« ã€‚

# ktorã¨ã¯
https://ktor.io/

ãƒ”ãƒ¥ã‚¢kotlinã®è»½é‡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚quarkus, micronautã¨é•ã£ã¦ç´”æ­£kotlinã€‚kotlinå¥½ãã®ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚coroutineã«ã‚ˆã‚‹éåŒæœŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŠã‚ˆã³ã‚µãƒ¼ãƒãƒ¼å‡¦ç†ã‚’ã‹ã‘ã‚‹ã€‚å®‰å¿ƒã®JetBrainsãŒé–‹ç™ºã‚’ã—ã¦ã„ã‚‹ã€‚èµ·å‹•ã‚‚æ—©ã„ãŸã‚ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã€ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã§ã‚‚æ´»ç”¨ã§ãã‚‹ã€‚quarkus, micronautãŒã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–æ™‚ä»£ã®ãƒã‚¤ã‚¯ãƒ­ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦èª•ç”Ÿã—ãŸã‚ˆã†ã«æ„Ÿã˜ã‚‹ãŒã€ktorã¯ã€Œè»½é‡ã§éåŒæœŸã§kotlinã‚‰ã—ãã€ã¿ãŸã„ãªé›°å›²æ°—ã‚’æ„Ÿã˜ã‚‹ã€‚ç´”æ­£kotlinãªã®ã§å½“ç„¶å¯¾å¿œè¨€èªã¯kotlinã€‚ãªã®ã§ktorã‚’quarkusã¨micronautã¨æ¯”ã¹ã‚‹ã®ã¯è‹¥å¹²ã‚¸ãƒ£ãƒ³ãƒ«ãŒé•ã†æ°—ãŒã—ãªãã‚‚ãªã„ã‘ã©kotlinä½¿ã„ãŒSpringã«ä»£ã‚ã‚‹è»½é‡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã†ãªã‚‰è¦‹ãŸã„ãªã‚¸ãƒ£ãƒ³ãƒ«ã¨ã—ã¦æ¯”è¼ƒã—ã¦ã¾ã™ã€‚

# ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
IntelliJã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã§ãã‚‹ã¨æ›¸ã„ã¦ã‚ã£ãŸã®ã§ã©ã‚“ã ã‘æ¢ã—ã¦ã‚‚ãªãã¦ãªã‚“ã§ãƒ¼ã£ã¦ãªã£ãŸã‚‰Ultimateç‰ˆã ã‘ã ã£ãŸã€‚ç„¡èª²é‡‘ã®ãŸã‚[Generatorã‚µã‚¤ãƒˆ](https://start.ktor.io/?_ga=2.173995301.701091928.1661217570-430710285.1661217570&_gl=1*spcytx*_ga*NDMwNzEwMjg1LjE2NjEyMTc1NzA.*_ga_9J976DJZ68*MTY2MTQyMjc3NS4xMC4xLjE2NjE0MjQxMzcuMC4wLjA.#/settings?name=ktor-native-demo&website=example.com&artifact=com.example.ktor-native-demo&kotlinVersion=1.7.10&ktorVersion=2.1.0&buildSystem=GRADLE_KTS&engine=NETTY&configurationIn=CODE&addSampleCode=true&plugins=)ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã€‚ä¸€æ—¦ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ãªã—ã§ãã®ã¾ã¾ä½œæˆã€‚

kotestã¨ORMã«ã¯Exposedã‚’ä»Šå›ã¯ä½¿ç”¨ã™ã‚‹ã®ã§ä»¥ä¸‹ã®ä¾å­˜é–¢ä¿‚ã‚’ã¨ã‚Šã‚ãˆãšè¿½åŠ ã€‚

```kotlin:build.gradle.kts
    //kotest
    val kotest_version: String by project
    val kotest_assertions_ktor_version: String by project
    testImplementation("io.kotest:kotest-runner-junit5-jvm:$kotest_version")
    testImplementation("io.kotest.extensions:kotest-assertions-ktor:$kotest_assertions_ktor_version")

    //Exposed
    val exposedVersion: String by project
    implementation("org.jetbrains.exposed:exposed-core:$exposedVersion")
    implementation("org.jetbrains.exposed:exposed-dao:$exposedVersion")
    implementation("org.jetbrains.exposed:exposed-jdbc:$exposedVersion")
    implementation("org.jetbrains.exposed:exposed-jodatime:$exposedVersion")
    implementation("mysql:mysql-connector-java:8.0.30")

    //json
    implementation("io.ktor:ktor-server-content-negotiation:$ktor_version")
    implementation("io.ktor:ktor-serialization-jackson:$ktor_version")
```

# Application.kt
ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’ä¿®æ­£ã—ã¦ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®èª­ã¿è¾¼ã¿ã‚„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®è¨­å®šã€å¾Œè¿°ã™ã‚‹DBæ¥ç¶šãªã©ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚

```kotlin:Application.kt
package com.example

import com.example.data.Migration
import io.ktor.server.engine.*
import io.ktor.server.netty.*
import com.example.routes.configureRouting
import com.fasterxml.jackson.annotation.JsonInclude
import com.fasterxml.jackson.databind.SerializationFeature
import io.ktor.serialization.jackson.*
import io.ktor.server.application.*
import io.ktor.server.plugins.contentnegotiation.*
import java.text.DateFormat

fun Application.module() {
    //APIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®JSONã‚’ã‚¯ãƒ©ã‚¹ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ãŸã‚ã«
    install(ContentNegotiation) {
        jackson {
            enable(SerializationFeature.INDENT_OUTPUT)
            disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)
            setDefaultPropertyInclusion(JsonInclude.Include.NON_NULL)
            dateFormat = DateFormat.getDateInstance()
        }
    }
    //ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    configureRouting()
    //DBæ¥ç¶š
    Migration()
}
fun main(args: Array<String>) {
    embeddedServer(Netty, commandLineEnvironment(args)).start(wait = true)
}
```

main/resourcesé…ä¸‹ã«application.confã‚’ä½œæˆã™ã‚‹ã€‚

```:application.conf
ktor {
    deployment {
        port = 8080
        port = ${?PORT}
    }
    application {
        modules = [ com.example.ApplicationKt.module ]
    }
}
```

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(Exposed)
https://github.com/JetBrains/Exposed/wiki
Ktorã¨ä¸€ç·’ã«ä½¿ã‚ã‚Œã‚‹ã‚‚ã®ã¨ã—ã¦ExposedãŒã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªã®ã§ä»Šå›ã¯ã“ã¡ã‚‰ã‚’ä½¿ç”¨ã€‚Domaã‚„JOOQã¨ã„ã£ãŸã‚‚ã®ã‚’ä½¿ã£ã¦ã¿ã‚‹ã“ã¨ã‚‚ã§ããŸãŒã›ã£ã‹ãKtorä½¿ã†ã®ã§ã¨ã“ã¨ã‚“kotlinãŒã„ã„ã‹ãªã¨æ€ã„Exposedã«ã—ã¾ã—ãŸã€‚ã¡ã‚‡ã£ã¨æ°—ã«ãªã£ãŸã®ãŒKtorã¯coroutineãŒå¤šç”¨ã•ã‚Œã¦ã‚‹ã¨æ€ã†ã®ã§ãªã‚‹ã¹ããƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã®å‡¦ç†ã¯æ›¸ã‹ãªã„æ–¹ãŒã„ã„ã®ã‹ã¨æ€ã£ã¦ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãªORMã‚’ä½¿ç”¨ã—ãŸæ–¹ãŒã„ã„ã®ã‹ã¨æ€ã„è»½ãèª¿ã¹ãŸã‘ã©ã‚ã‚“ã¾ã‚Šã„ã„æƒ…å ±ãŒå‡ºã¦ã“ãªã‹ã£ãŸã€‚Exposedã«é–¢ã—ã¦ã¯R2DBCå¯¾å¿œã§ããªã„ã®ã‹ãªãƒ¼ã¿ãŸã„ãªisuueã¯ã‚ã£ãŸãŒã¾ã å¯¾å¿œä¸­ã£ã½ã„ã€‚

https://github.com/JetBrains/Exposed/issues/456

JOOQãŒR2DBCå¯¾å¿œã—ã¦ãã†ã ã£ãŸã®ã¨ã€komapperã¨ã„ã†ORMãªã©ã‚‚ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°å¯¾å¿œã—ã¦ãã†ãªæ°—é…ãŒã‚ã£ãŸã‘ã©æœ¬é¡Œã¨ãšã‚Œãã†ã ã£ãŸã®ã§ä¸€æ—¦Exposedã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

https://blog.jooq.org/reactive-sql-with-jooq-3-15-and-r2dbc/

https://www.komapper.org/ja/

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã—ã¦ã¯flywayã‚’å°å…¥ã—ã‚ˆã†ã¨æ€ã£ãŸã®ã ã‘ã©ExposedãŒDBã®ä½œæˆã‚„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã¿ãŸã„ãªDDLãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ãªã®ã§ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦æ›¸ã„ã¦ã¿ãŸã€‚
```kotlin:Migration.kt
package com.example.data

import org.jetbrains.exposed.sql.Database
import org.jetbrains.exposed.sql.Schema
import org.jetbrains.exposed.sql.SchemaUtils
import org.jetbrains.exposed.sql.transactions.transaction

class Migration {
    companion object {
        val database = Database.connect("jdbc:mysql://localhost:3306/demo", driver = "com.mysql.cj.jdbc.Driver",
            user = "root", password = "root")

        val schema = Schema("demo").also {
            transaction {
                SchemaUtils.createSchema(it)
            }
        }

        val tables = arrayOf(
            UserTable
        ).also {
            transaction {
                SchemaUtils.create(*it)
            }
        }
    }
}
```

ã“ã‚Œã‚’Application.moduleå†…ã§èª­ã¿è¾¼ã‚€ã“ã¨ã§å®Ÿè¡Œæ™‚ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆã¨ã‹ã—ã¦ãã‚Œã‚‹ã€‚

```kotlin:User.kt
object UserTable : IntIdTable("user") {
    val name: Column<String> = varchar("name", 50)
}

object UserRepository {
    fun create(name: String) = transaction {
        UserTable.insertAndGetId { it[this.name] = name }.value
    }

    fun find(id: Int) = transaction {
        UserTable.select { UserTable.id eq id }.singleOrNull()?.let {
            User(it[UserTable.id].value, it[UserTable.name])
        }
    }
}
```

Userãƒ†ãƒ¼ãƒ–ãƒ«ã®Entityã¨Repositoryå®šç¾©ã€‚Ktorã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯DIã®æ©Ÿèƒ½ãŒãªã„ã®ã§ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¯objectã«IntIdTableã‚’ç¶™æ‰¿ã•ã›ã¦ã„ã‚‹ã€‚(companionä»¥å¤–ã§åˆã‚ã¦objectä½¿ã£ãŸ...)ãƒ†ãƒ¼ãƒ–ãƒ«ã¯SQLã®ã‚ˆã†ã«æ›¸ã‘ã‚‹ã®ã§æ˜ç¢ºã ãªã¨æ„Ÿã˜ãŸã€‚Spring Dataã¨ã‹ã ã¨SQLã¨Entityã§ã†ã¾ããƒãƒƒãƒ”ãƒ³ã‚°ã§ããªã„ã¿ãŸã„ãªã®ã‚ˆãã‚ã‚‹ã‹ã‚‰ãƒŸã‚¹æ¸›ã‚Šãã†ã€‚

Repositoryã‚‚ã‚¯ãƒ©ã‚¹ã«ã™ã‚‹æ„å‘³ãŒæ€ã„ã¤ã‹ãªã‹ã£ãŸã®ã§objectã«ã—ãŸã€‚transactionãƒ–ãƒ­ãƒƒã‚¯å†…ã«æ›¸ãã€‚SQLãƒ©ã‚¤ã‚¯ã§ä½•ã—ã¦ã‚‹ã‹ã‚ã‹ã‚Šã‚„ã™ã„ã€‚

# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°(Controller)
Routeã®æ‹¡å¼µé–¢æ•°ã¨ã—ã¦æ©Ÿèƒ½ã”ã¨ã«åˆ‡ã‚Šåˆ†ã‘ã¦ç®¡ç†ã™ã‚‹ã¨ç®¡ç†ã—ã‚„ã™ãã†ã€‚routeãƒ–ãƒ­ãƒƒã‚¯å†…ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ›¸ã„ã¦ã„ãã ã‘ã€‚Serviceã‚‚Repositoryã¨åŒã˜ã‚ˆã†ã«objectã§å®šç¾©ã—ã¦ã„ã‚‹ã€‚Jacsonã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã®ã§ã‚¯ãƒ©ã‚¹ã‚„mapã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã„ã„æ„Ÿã˜ã«JSONã«å¤‰æ›ã•ã‚Œã‚‹ã€‚

```kotlin:UserRoute.kt
package com.example.routes

import com.example.domain.service.UserService
import io.ktor.http.*
import io.ktor.server.application.*
import io.ktor.server.request.*
import io.ktor.server.response.*
import io.ktor.server.routing.*

fun Route.userRoute() {
    route("/user") {
        post {
            val request = call.receive<CreateUserRequest>()
            val id = UserService.create(request.name)
            call.respond(mapOf("id" to id))
        }
        get("/{id}") {
            val id = call.parameters["id"]?.let { it.toInt() } ?: run {
                return@get call.respond(HttpStatusCode.BadRequest, "IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
            }
            val user = UserService.find(id) ?: run {
                return@get call.respond(HttpStatusCode.NotFound, "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“ id: $id")
            }
            call.respond(user)
        }
    }
}

data class CreateUserRequest(val name: String)
```

å„ãƒ«ãƒ¼ãƒˆã‚’æŸã­ã‚‹ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒˆã€‚ä¸Šè¨˜ã®userRoteã‚’routingãƒ–ãƒ­ãƒƒã‚¯å†…ã«å®£è¨€ã™ã‚‹ã ã‘ã€‚

```kotlin:Routeing.kt
package com.example.routes

import io.ktor.server.application.*
import io.ktor.server.response.*
import io.ktor.server.routing.*

fun Application.configureRouting() {

    // Starting point for a Ktor app:
    routing {
        get("/") {
            call.respondText("Hello World!")
        }
    }
    routing {
        userRoute()
    }
}
```

ã“ã®configurationRoutingã¯Application.module()å†…ã§å®£è¨€ã—ã¦ã‚ã‚‹ã®ã§ã€ã“ã‚Œã§ä¸€å¿œä¸€é€šã‚Šå‹•ãã¯ãšã€‚

# ãƒ†ã‚¹ãƒˆ
 Repositoryã®ãƒ†ã‚¹ãƒˆã§Springãªã©ã§ã¯@Transactionalã‚’ã¤ã‘ã¦ãƒ†ã‚¹ãƒˆå¾Œã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ããŸã®ã§ã€åŒã˜ã‚ˆã†ã«ã—ãŸã‹ã£ãŸã®ã ã‘ã©ã€ã„ã„ã‚„ã‚Šæ–¹ãŒèª¿ã¹ã¦ã‚‚å‡ºã¦ã“ãšã¨ã‚Šã‚ãˆãštransactionãƒ–ãƒ­ãƒƒã‚¯å†…ã§rollback()ã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã§ãã‚‹ã“ã¨ã¯ã‚ã‹ã£ãŸã®ã§ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½œæˆã—ãŸã€‚

 ```kotlin:TestHelper.kt
 package com.example

import org.jetbrains.exposed.sql.transactions.transaction

fun testRollbackScope(test: () -> Unit) {
    transaction {
        test()
        rollback()
    }
}
 ```
 
 ä½¿ã„æ–¹ã¯ã“ã‚“ãªæ„Ÿã˜

 ```kotlin:UserTest.kt
 package com.example.data

import com.example.domain.model.User
import com.example.testRollbackScope
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe
import io.kotest.matchers.shouldNotBe

internal class UserTest : StringSpec({
    beforeSpec { Migration() }
    "test" {
        testRollbackScope {
            val id = UserRepository.create("test")
            val user = UserRepository.find(id)

            user shouldNotBe null
            user shouldBe User(id, "test")
        }
    }
})
```
 
- ãƒ¡ã‚¤ãƒ³å‡¦ç†åŒæ§˜ã€ãƒ†ã‚¹ãƒˆé–‹å§‹å‰ã«Migrationã‚’å®£è¨€ã—ã¦ãŠãã€‚
- å…ˆã»ã©ä½œã£ãŸtestRollBackScopeãƒ–ãƒ­ãƒƒã‚¯å†…ã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã€‚

ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ†ã‚¹ãƒˆã‚‚åŒæ§˜ã§æ›¸ã‘ã‚‹ã€‚

Routingã®ãƒ†ã‚¹ãƒˆã¯ä¸€å¿œä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦è¦‹ãŸã®ã ã‘ã©ã†ã¾ãã„ã‹ãªã„ã€‚

```kotlin:UserRouteTest
package com.example.routes

import com.example.data.Migration
import io.kotest.core.spec.style.StringSpec
import io.ktor.client.request.*
import io.ktor.http.*
import io.ktor.serialization.jackson.*
import io.ktor.server.plugins.contentnegotiation.*
import io.ktor.server.testing.*

internal class UserRouteTest : StringSpec({
    beforeSpec { Migration() }
    "test" {
        testApplication {
            install(ContentNegotiation) {
                jackson {  }
            }
            val created = client.post("/user") {
                install(ContentNegotiation) {
                    jackson {  }
                }
                contentType(ContentType.Application.Json)
                setBody(CreateUserRequest("user"))
            }
        }
    }
})
```

ã¨ã‚Šã‚ãˆãšã€æœ€æ–°ã®Ktor(2.0.3)ã ã¨withTestApplicationãŒéæ¨å¥¨ã«ãªã£ã¦ã„ã‚‹ã®ã§testApplicationã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã€‚
https://kotest.io/docs/extensions/ktor.html

ã“ã‚Œã§å®Ÿè¡Œã™ã‚‹ã¨
```
If you expect serialized body, please check that you have installed the corresponding plugin(like `ContentNegotiation`) and set `Content-Type` header.
```
ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã§å¤šåˆ†jacsonãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã§ãã¦ã„ãªã„æ°—ãŒã™ã‚‹ã®ã ã‘ã©ä½•å›ã‚„ã£ã¦ã‚‚ãƒ€ãƒ¡ã ã£ãŸã®ã§ä»Šå›ã¯è«¦ã‚ã¾ã™ã€ã§ããŸã‚‰ã¾ãŸè¨˜äº‹æ›¸ãã¾ã™ã€‚(Ktoræœ‰è­˜è€…ã®æ–¹ã§ã‚ã‹ã‚‹æ–¹ã„ã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„ï¼)

:::message
contentNegotiationãŒclientã§ã¯ãªãserverå´ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ãã¾ã—ãŸï¼ä»¥ä¸‹ã®ã‚ˆã†ã«ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã—ãŸã‚‰ã¡ã‚ƒã‚“ã¨å‹•ãã¾ã—ãŸï¼
:::

ä¾å­˜é–¢ä¿‚ã®è¿½åŠ 

```kotlin
    testImplementation("io.ktor:ktor-client-content-negotiation:$ktor_version")
```

```kotlin:UserRouteTest
package com.example.routes

import com.example.data.Migration
import io.kotest.core.spec.style.StringSpec
import io.kotest.matchers.shouldBe
import io.ktor.client.call.*
import io.ktor.client.plugins.contentnegotiation.*
import io.ktor.client.request.*
import io.ktor.http.*
import io.ktor.serialization.jackson.*
import io.ktor.server.testing.*

internal class UserRouteTest : StringSpec({
    beforeSpec { Migration() }
    "test" {
        testApplication {
            val client = createClient {
                install(ContentNegotiation) {
                    jackson()
                }
            }
            val created = client.post("/user") {
                contentType(ContentType.Application.Json)
                setBody(CreateUserRequest("user"))
            }

            created.status shouldBe HttpStatusCode.OK
            val body = created.bodyAsText()
            println(body)
        }
    }
})
```

# ãŠã¾ã‘(nativeãƒ“ãƒ«ãƒ‰)
quarkus, micronautã§ä¸€å¿œnative imageãƒ“ãƒ«ãƒ‰ã‚’è©¦ã—ãŸã®ã§Ktorã§ã‚‚ã§ãã‚‹ã‹æ¤œè¨¼ã—ã¦ã¿ãŸã€‚ä¸€å¿œKtor1.6ã§GraalVMã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã€‚ãŸã ã€ä¸Šè¨˜ã§ä½œæˆã—ãŸã‚‚ã®ã‚’ãã®ã¾ã¾nativeCompileã—ãŸã¨ã“ã‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ããªã‹ã£ãŸã®ã§ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§è©¦ã—ã¦ã¿ãŸã€‚(ä¾å­˜é–¢ä¿‚ãªã©ã«ã‚ˆã£ã¦ãã®ã¾ã¾ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ããªã„ã®ã‹ã‚‚ã—ã‚Œãªã„ãŒæ¤œè¨¼ã¯ã¾ãŸã®æ©Ÿä¼šã§)

- GraalVMã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€$GRAALVM_HOMEã«ãƒ‘ã‚¹ã‚’è¨­å®šã—ã¦ã‚ã‚‹ã“ã¨ã€‚

https://zenn.dev/jy8752/articles/593dc0dbeffced#native-image%E3%83%93%E3%83%AB%E3%83%89

https://graalvm.github.io/native-build-tools/0.9.6/graalvm-setup.html

- build.gradle.ktsã«ä¸‹è¨˜è¿½è¨˜ã€‚

```diff kotlin:build.gradle.kts
plugins {
    application
    kotlin("jvm") version "1.7.10"
+    id("org.graalvm.buildtools.native") version "0.9.11"
}

dependencies {
    implementation("ch.qos.logback:logback-classic:1.2.11")
    implementation("io.ktor:ktor-server-core-jvm:2.1.0")
    //NettyãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ã®ã§CIOã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
    implementation("io.ktor:ktor-server-cio-jvm:2.1.0")
}

+graalvmNative {
+    binaries {
+        named("main") {
+            fallback.set(false)
+            verbose.set(true)
+
+            buildArgs.add("--initialize-at-build-time=io.ktor,kotlin")
+
+            buildArgs.add("-H:+InstallExitHandlers")
+            buildArgs.add("-H:+ReportUnsupportedElementsAtRuntime")
+            buildArgs.add("-H:+ReportExceptionStackTraces")
+
+            imageName.set("graal-server")
+        }
+    }
+}
```

- Application.ktã®embeddedServerã¯Nettyã§ãªãCIOã§èµ·å‹•ã™ã‚‹ã€‚
``` kotlin: Application.kt
fun main() {
    embeddedServer(CIO, port = 8080, host = "0.0.0.0") {
        configureRouting()
    }.start(wait = true)
}
```

- src/main/resouces/META-INF/native-imageé…ä¸‹ã«reflect-config.jsonã‚’ä½œæˆã—ã€ä¸‹è¨˜ã‚’è¿½è¨˜ã€‚

```json:reflect-config.json
[
  {
    "name": "kotlin.reflect.jvm.internal.ReflectionFactoryImpl",
    "allDeclaredConstructors":true
  },
  {
    "name": "kotlin.KotlinVersion",
    "allPublicMethods": true,
    "allDeclaredFields":true,
    "allDeclaredMethods":true,
    "allDeclaredConstructors":true
  },
  {
    "name": "kotlin.KotlinVersion[]"
  },
  {
    "name": "kotlin.KotlinVersion$Companion"
  },
  {
    "name": "kotlin.KotlinVersion$Companion[]"
  },
  {
    "name": "kotlin.internal.jdk8.JDK8PlatformImplementations",
    "allPublicMethods": true,
    "allDeclaredFields":true,
    "allDeclaredMethods":true,
    "allDeclaredConstructors":true
  }
]
```

ãƒ“ãƒ«ãƒ‰
```
./gradlew nativeCompile
```

å®Ÿè¡Œ(ä¸€ç¬ã§èµ·å‹•)
```
build/native/nativeCompile/graal-server

09:33:03.969 [DefaultDispatcher-worker-1] INFO ktor.application - Autoreload is disabled because the development mode is off.
09:33:03.970 [DefaultDispatcher-worker-1] INFO ktor.application - Application started in 0.001 seconds.
09:33:03.970 [DefaultDispatcher-worker-5] INFO ktor.application - Responding at http://0.0.0.0:8080
```

# ã¾ã¨ã‚
- ã‚„ã£ã±ã‚ŠKtorã¯quarkusã¨micronautã¨æ¯”ã¹ã‚‹ã¨ã ã„ã¶é›°å›²æ°—å¤‰ã‚ã‚‹
- æ„è­˜ã—ãŸè¨³ã§ã¯ãªã„ã‘ã©ãªã‚“ã¨ãªãKtorä½¿ã£ã¦ã‚‹ã¨kotlinã£ã½ã„(kotlinã£ã½ã„ã£ã¦çµå±€ä½•)æ›¸ãæ–¹ã«ãªã£ã¦ãã‚‹æ°—ãŒã™ã‚‹
- Ktor + Exposedã®çµ„ã¿åˆã‚ã›ã«ã™ã‚‹ã¨ã‚‚ã†ã ã„ã¶é•ã†ã€è¨€èªå¤‰ã‚ã‚‹ãƒ¬ãƒ™ãƒ«ã§å¤‰ã‚ã£ãŸæ°—ãŒã™ã‚‹
- nativeå¯¾å¿œãŒç›®çš„ãªã‚‰quarkus,micronautã®æ–¹ãŒå®‰å…¨ãªæ°—ãŒã™ã‚‹

# æœ€çµ‚çš„ãªæ¯”è¼ƒã¨æ„Ÿæƒ³
(ã‚ãã¾ã§å€‹äººçš„ãªæ„Ÿæƒ³ã§ã™ã€‚)

|| quarkus | micronaut | Ktor |
| --- | ---- | ---- | ---- |
|CLI| â—¯ | â—(initãŒã¾ã˜ã§ã„ã„) | Ã— |
|å­¦ç¿’ã‚³ã‚¹ãƒˆ| æ™®é€š | æ™®é€š | å°‘ã—é«˜ãã† |
|nativeå¯¾å¿œ| k8sã§ã®ä½¿ç”¨ã‚’æ¨ã—ã¦ã‚‹ | ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã€ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã§ã®åˆ©ç”¨ã‚’æƒ³å®š | ã§ãã¯ã™ã‚‹ã‘ã©ä»–ã®2ã¤ã®ãŒã„ã„ |
|kotlinã‚µãƒãƒ¼ãƒˆ| ã‚ã¾ã‚Šç©æ¥µçš„ãªã‚µãƒãƒ¼ãƒˆã¯ãªã„ | å•é¡Œãªãä½¿ãˆã‚‹ | ç´”æ­£kotlinãªã®ã§é–“é•ã„ãªã„|
|å¯¾å¿œORM| panache, ä»–ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼è£½ã®ORMãŸã¡ | micronaut data, ä»–ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼è£½ã®ORMãŸã¡ | Exposed, ä»–ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼è£½ã®ORMãŸã¡|
|é–‹ç™ºä½“é¨“| panacheã‚’active recordãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä½¿ãˆã°æ¥½ã—ã„ã‹ã‚‚ | ã‚ã‚“ã¾ã‚ŠSpringã¨å¤‰ã‚ã‚‰ãªã„ | æ¥½ã—ã„(kotlinæ›¸ã„ã¦ã‚‹æ„Ÿ)|

micronautã®CLIã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãŒæœ¬å½“ã«ã‚ˆãã§ãã¦ãŸã—ã€kotlinã‚‚æ™®é€šã«å¯¾å¿œã—ã¦ã‚‹ã—ã€kotestã‚‚Spockã‚‚ä½¿ãˆã‚‹ã®ãŒã¾ã˜ã§äºˆæƒ³å¤–ã«è‰¯ã‹ã£ãŸã€‚ãŸã ã€ã‚ã¨ã¯Springã¨é›°å›²æ°—ã¯ã‚ã‚“ã¾ã‚Šå¤‰ã‚ã‚‰ãªã„ã®ã§ã‚„ã£ã±ã‚ŠKtorã®æ–¹ãŒkotlinæ›¸ã„ã¦ã‚‹æ„Ÿã‚ã£ã¦æ¥½ã—ã„ã¨ã„ã†ã‹ã€æ™®æ®µæ›¸ã‹ãªãã†ãªã‚³ãƒ¼ãƒ‰æ›¸ã‘ãã†ã§å‹‰å¼·ã«ãªã‚‹ã€‚

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®æ¡ç”¨ã‚‚ã—ã¦ã„ã‚‹ã¨ã“ã‚ã¯ã‚ã‚‹ã‚ˆã†ã ã—ã€ã‚‚ã†Springã‚’ä½¿ã„ç¶šã‘ãªãã¦ã‚‚ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ãªãƒ¼ã¨ã„ã†æ°—ã¯ã—ã¦ã„ã‚‹ã€‚Javaã§å¤§è¦æ¨¡é–‹ç™ºã—ã¦ã‚‹ã£ã¦ã„ã†ã®ã§ã‚‚ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã‚„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¿ãŸã„ãªè©±ã¯é€²ã‚“ã§ã„ãã ã‚ã†ã—ã€æ©Ÿèƒ½çš„ã«ã‚‚ååˆ†å……å®Ÿã—ã¦ã„ã‚‹ã—micronautã‹quarkusã¨ã‹å°å…¥é€²ã‚“ã§ã‚‚ã„ã„æ°—ãŒã™ã‚‹ã€‚Springã¯ã‚„ã£ã±ã‚Šååˆ†ã«æ¯ã‚Œã¦ã„ã¦å°å…¥ã™ã‚‹ã«ã¯å®‰å¿ƒæ„ŸãŒã‚„ã°ã„ã‘ã©ã‚ã‚“ã¾ã‚Šé–‹ç™ºä½“é¨“ãŒå‘ä¸Šã—ã¦ã„ã‹ãªã„æ°—ãŒã™ã‚‹ã€‚

webç³»ã§kotlinä½¿ã£ã¦ã‚‹ãªã‚‰ã€ãªãŠã•ã‚‰Ktorã¨ã‹micronautã®å°å…¥é€²ã‚“ã§ã‚‚ã„ã„ã‚“ã˜ã‚ƒãªã„ã ã‚ã†ã‹ã€‚ä»Šã¾ã§ã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨ã‹è³‡ç”£ãŒã‚ã‚‹ãªã‚‰ã‚ã‚Œã ã‘ã©ã€ç‰¹ã«ãªã‚“ã¨ãªãSpringä½¿ã£ã¦ã‚‹ãªã‚‰ä»–ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚‚å€™è£œã«å…¥ã‚Œã¦ã‚‚ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ã¨æ€ã†

ã¨ã‚Šã‚ãˆãšã€quarkusã‚‚micronautã‚‚Ktorã‚‚è§¦ã£ã¦ã„ã¦æ¥½ã—ã‹ã£ãŸ

å€‹äººçš„ã«ä½¿ã£ã¦ã„ããªã‚‰ã“ã‚Œã‹ã‚‰ã¯Ktorã‚’è§¦ã£ã¦ã„ã“ã†ã‹ã¨æ€ã†
ã•ã£ãã‚Šãªã‚“ã‹ä½œã‚‹ãªã‚‰micronautã§ã‚‚ã„ã„ã‹ã‚‚ã—ã‚Œãªã„(èª²é‡‘ã™ã‚Œã°è©±ã¯å¤‰ã‚ã‚‹ã‘ã©JetBrainsã•ã‚“ã™ã¿ã¾ã›ã‚“ã€ã¾ã ç„¡èª²é‡‘ã§è¡Œãã¾ã™)

ä»¥ä¸Šã€å„ªå‹ã¯Ktorã§ã—ãŸï¼ï¼

# å‚è€ƒ
åŸºæœ¬çš„ãªKtorã‚’ä½¿ç”¨ã—ãŸAPIé–‹ç™ºã®æµã‚Œ
https://toranoana-lab.hatenablog.com/entry/2021/05/21/180000
https://retheviper.github.io/posts/ktor-first-impression/

application.confèª­ã¿è¾¼ã‚€
https://zenn.dev/someone7140/articles/218f1aeec3acde

å…¬å¼
https://ktor.io/docs/welcome.html
https://github.com/JetBrains/Exposed/wiki/DataBase-and-DataSource

testApplication
https://zenn.dev/ikatechx/articles/9e5ced9d09d1db