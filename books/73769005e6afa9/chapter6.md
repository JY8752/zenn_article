---
"title": "なぜ古典学派のテストを書くのか？"
---

前回まででDBの準備は完了しているため、アプリケーションを作成していきたいところですが本章では「単体テストの考え方/使い方」で紹介されている**古典学派**のテストと**ロンドン学派**のテストについて触れていきたいと思います。

## 単体テストの定義

「単体テストの考え方/使い方」の中では単体テストの定義として以下の３つの性質をあげています。

>
> - 「単体(unit)」と呼ばれる少量のコードを検証する
> - 実行時間が短い
> - 隔離された状態で実行される

このうちの３つ目の性質である**隔離された状態**について解釈が分かれていることで古典学派とロンドン学派という２つの学派に分かれることになったようです。では、それぞれの学派でこの隔離された状態についてどのように解釈しているのでしょうか？

## ロンドン学派のテスト

ロンドン学派は単体テストの性質である隔離された状態というのを**テスト対象システムから協力者オブジェクト(collaborator)を隔離すること**だと考えています。協力者オブジェクトとは簡単に言うとテスト対象システムが依存しているドメイン領域を扱うオブジェクトのことです。

そのため、ロンドン学派はテスト対象システムの**全ての依存関係をテストダブルに置き換える**という考えを持っています。

:::message
テスト・ダブルとはテストで使用される複雑さを軽減させ扱いやすいようにしたオブジェクトのことです。テスト・ダブルという用語の由来は映画のスタントマン(英語でstunt double)からきているそうです。モックやスタブという用語もテストの文脈で同じように使われたりしますが厳密に言うとモックやスタブはテスト・ダブルの一種と考えられるようです。

![](https://storage.googleapis.com/zenn-user-upload/33268a74568d-20231018.png)
:::

このようなテストダブルを使用したテストには以下のメリットがあります。

- テストが失敗したときにどこで問題があったのかを明確にできる。(なぜなら、依存関係は全てモックに置き換えられているので問題はテスト対象システムに限られる。)
- 複雑な依存関係を容易に解決することができる。
- 1つのテストケースは１つのテスト対象クラスしか検証しないような指針を普及しやすい。(依存関係が全てモックになっているので必然的にテスト対象と1対1でテストケースを作成するようになる。)

## 古典学派のテスト

ロンドン学派がテスト対象システムから全ての依存関係を隔離することと考えている一方で古典学派が考える隔離の対処はテストケース同士であり、**全てのテストケースはお互いに影響を与えることなく個別に実行できるようにしなくてはならない**と考えています。そのため古典学派が考える単体テストは実行する順番なども関係なく実行されなくてはなりません。

古典学派の単体テストにおいてテストケース間で共有される状態があるとそれはテストケース同士が隔離されているとは言えなくなります。しかし、DBやファイルシステムはテストにおいて一般的に共有される代表的な状態であり、このような依存を**共有依存**と呼びます。

:::message
- 共有依存 テストケース間で共有される依存。DBなどが当てはまる。
- プライベート依存 共有されない依存。
- プロセス外依存 アプリケーションの外側で稼働する依存。

例えば、DBなどはプロセス外依存であり共有依存でもある。しかし、テストで使用するDBを毎回Dockerで起動していたりするとこれはプロセス外依存ではあるが共有依存とはならずプライベート依存となる。
![](https://storage.googleapis.com/zenn-user-upload/913bdc108150-20231017.png)
:::

このように、古典学派は**共有した依存**を取り除くためにのみモックを使用することでテストケース間を隔離した状態にしようと考えているため全ての依存をモックにするロンドン学派とは対象的にモックを極力使用しないような考え方になります。

また、古典学派は「テスト駆動開発(TDD)」を原点としています。

## 古典学派のテストを選ぶ理由

書籍ではロンドン学派より古典学派のテストを推奨しています。その大きな理由は古典学派のテストの方が**良質なテスト**を書くことができるからとあります。では、なぜ古典学派のテストの方が良質なのかもう一度ロンドン学派のメリットを見てみましょう。

### １つのテストケースに対して１つのクラスを検証することができる

このメリットは一見検証の粒度が細かくなり良いように見えますが単体テストの視点からするとこれは大したメリットにはなりません。なぜなら、単体テストは**１単位のコードではなく１単位の振る舞い**を検証したほうが質の良いテストと考えらているからです。

ロンドン学派のテストはテスト対象のコードとの結びつきが強くなり、気をつけないと**テスト対象のコードの振る舞いをテストで検証してしまう**ことになります。

:::message
これは筆者の感想ですがモックを使用したテストを書いていると全ての依存をモックにしただけで本当にテスト対処のコードをテストできているのか不安になるときがありました。その不安をうまく言語化することができないでいたのですが、「単体テストの考え方/使い方」を読んでその理由が明確になったような気がしました。

モックを多用したテストはテスト対象のコードを順に読んでいき、依存の部分をモックにするようなテストの書き方をしてしまいがちで**振る舞いではなくコード**を検証してしまい、ある意味単体テストを書く難易度を上げてしまうように感じました。
:::

### 複雑な依存関係の解決

複雑な依存関係を解決するのは容易ではなくモックに置き換えられるのは大きなメリットのように思えます。しかし、この主張は本来の問題に目を背け本質ではない考えと言えます。なぜなら、本来考えるべきはそのような**複雑な依存関係を構築しないように設計することであり、その依存関係を解決することではない**からです。

モックを使用して複雑な依存関係のあるコードをテストできるようにしてもそれは設計の問題に向き合わず先送りにしているだけと言えます。

### テストが失敗したときにどこに問題があったかが明確

これはバグがどこにあるかがロンドン学派の方が見つけやすいという考えですが、古典学派においても最終的に修正した箇所がバグの原因となっていることが多く、さほどバグの原因を見つけ出すのに古典学派であっても苦労はしないと考えられます。

このように、一見魅力的に見えるロンドン学派のテストですが課題もあり、古典学派のテストの方が質の良いテストを書くことができると考えることができる。

## まとめ

- ロンドン学派と古典学派は単体テストにおける**隔離された状態**の解釈が違うために2つに分かれた。
- ロンドン学派はテスト対象のシステムとテスト対象のシステムが依存するオブジェクトを隔離しようとするため、**全ての依存関係をテスト・ダブルに置き換える**。
- 古典学派はテスト対象のシステムのテストケース間を隔離しようとするため、DBのような**共有依存のみテスト・ダブルに置き換える**。
- ロンドン学派のテストは一見メリットが多そうだが、**設計の問題を先送りにしている可能性があり、古典学派の方が質の良いテストを書くことができる**。

筆者は「単体テストの考え方/使い方」を読むまでは全ての依存関係をモックにするロンドン学派的なテストを書いていました。書籍を読み進めていく中でどんなに古典学派の方が良いと言われても「複雑なビジネスロジックをプログラムに落とし込むのだから複雑な依存関係は避けられない。それならば、その依存関係の解決を容易にしないとテストのハードルが高くなりテストを書くのが辛くなってしまう。」と思っていたからです。

しかし、モックを使用したテストは**設計の悪さという問題から目を逸らしている**と書かれていたのを見て衝撃を受けました。確かに、そもそもそんなに複雑な依存関係を持つプログラムの設計が良いわけはない。モックを使用することでテストは書きやすくなったけどその分プロダクションコードとの結びつきは強くなり、壊れやすいテストにもなってしまっているし、振る舞いではなくコードを検証するようなテストを書いてしまっている。

そのため、筆者の主張としても**質の良いテストを書くために古典学派的なテストを推奨**しますが、どちらの学派でテストを書くか、どちらの学派のテストがプロダクトにあっているかは個人の考え、組織やプロダクトにもよるとも思いますので**ロンドン学派よりも古典学派の方が優れている**という主張をするわけではありません。

どのようなテストを書くかでプロダクトが良くなるかは読者の皆様が考えて決めることであり、本書がその参考になれば幸いです。