---
title: "ZanzibarとSpiceDBの関係"
---

本章ではSpiceDBのモデルとなっているGoogleのZanzibarという認可システムについてSpiceDBと比較しながら解説します。SpiceDBはGoogle社内で使われていたZanzibarをGoogle以外のプロダクトでも利用しやすいように設計されたものであり、ベースはZanzibarなのでZanzibarの概念を理解することはSpiceDBを理解するうえで役に立つはずです。

## Zanzibarについて

SpiceDBについて触れる前にまずはZanzibarについてもう少し詳しく見ていきましょう。ZanzibarはGoogleが社内の大規模なサービス、リソース間の認可処理を行うために開発された分散システムです。Zanzibarには以下のような特徴があります。

- Googleのような大規模サービスでも高速に応答できるような分散システム
- 高い高速性を実現するために高度なキャッシュを活用している
- キャッシュを使いながらも一貫性のある結果を得るために`Zookies`という仕組みを採用している
- ユーザーとリソースの関係を有向グラフで表現し、パーミッションのチェックにはそのグラフをたどることでチェックする(ReBAC)
- ZanzibarのパーミッションシステムはAPIとしてアプリケーションに提供されている
- Zanzibarはパーミッションチェックをするために必要な情報はすべて持っており、ユーザーとリソースの関係をアプリケーションから切り離して保持することができる
- ZanzibarのパーミッションシステムとしてのデータはSpannerを用いて保存されている

ここからの内容はAuthZedの以下のテックブログの記事を参考に説明します。認可システムについての一般的な実装とその難しさや課題、そしてGoogleがなぜZanzibarを必要としどのような要求をZanzibarに求めたのかが非常にわかりやすく説明されているので興味がある方はぜひ読んでみることをおすすめします。

https://authzed.com/blog/what-is-google-zanzibar

記事の中でGoogleがZanzibarの開発をすることで得られる恩恵として以下のように書かれています。

> 第一に、サービスとして、コードの重複やバージョンのずれを最小限に抑えた。第二に、グーグルには多数のアプリケーションとサービスがあり、あるアプリケーションのリソース間のパーミッションを別のアプリケーションでチェックする必要がよくある。例えば、Gmailを使ってメールを送信したときに、受信者がメールにリンクされているドキュメントを読めないと警告が出るが、これはGmailがリンクされているGoogleドキュメントのパーミッションをZanzibarに問い合わせているからだ。また、同様の権限要求は、カレンダー、クラウド、ドライブ、マップ、写真、YouTubeなどでも発生する。第三に、グーグルはパーミッション・システムの上に共通のインフラを構築している。これは、プログラムするための一貫したAPIがあればこそできることだ。最後に、そして最も重要なことは、パーミッションは難しいということだ。
(DeepL訳)

上記の引用の最後の理由に挙げられる**パーミッションは難しい**とはどういうことでしょうか？人々は認可システムに対していくつかの遵守されるべきルールを期待しているとされています。

まず第一に**認可の実装は正しくなければならない**ということです。これは言葉のままでどのユーザーがどのリソースにアクセスできて、どのリソースにはアクセスできないかをアプリケーションはパーミッションシステムに問い合わせます。この問い合わせは当然信用できる絶対的に正しいものである必要があり、間違っていてはならないのです。

第二にパーミッションシステムを使うのであればアプリケーションの様々なタイプのプリミティブな値をモデル化する必要があるということです。記事内ではGoogleの例として以下のように記載されています。

> Docsのポイントツーポイント共有、YouTubeの公開/非公開/非掲載ビデオ、Cloud IAMのRBAC。Google Zanzibarは、様々なタイプのパーミッションをモデル化するのに十分な柔軟性を持つように作られている。
(DeepL訳)

また、パーミッションシステムへの問い合わせは通常リクエスト単位で毎回発生するため高い信頼性と高速性が要求されます。

最後にGoogleは非常に大規模なサービスのため数十億のユーザーと数十兆のリソースに対して非常に高速な応答が求められるとされています。

これらのことからGoogleのような大規模サービスを扱う企業が求めるパーミッションシステムには大規模な分散システムが必要であることがわかり、Zanzibarはこれらの要求を満たす大規模な分散システムとして開発されています。

## SpiceDBとの関係性

繰り返しになりますがSpiceDBはZanzibarを元に作られており、Googleのような大規模サービス向けに作られた認可システムを一般的に使いやすく設計された認可システムです。そのためZanzibarの特徴と類似している部分が多いですが、SpiceDB特有の特徴がいくつかあるためZanzibarと比較しながらその特徴について解説します。

### スキーマ言語

Zanzibarでは認可システムで扱うモデルをProtocol Buffersを多用することで実現しており、Namespace Configsと呼ばれるものを使用している。このNamespace Configを開発者が生成するのを支援するのにProtocol Bufferのツールを使用しているとされています。

SpiceDBではより一般的にかつ柔軟にパーミッションシステムを設計できるように独自のスキーマ言語を採用しています。

### relationとpermissionの区別

ZanzibarではSpiceDBで使われる`relation`と`permission`の明確な区別をしていません。SpiceDBにおける`permission`はpublicなAPIのようなもので、`relation`は純粋にオブジェクト間の関係だけを表現するものとすることが推奨されており、外部からのAPI問い合わせは`permission`に対してすべきとされています。

Zanzibarではこの区別がないため紛らわしい実装をする必要があったそうですが、SpiceDBではその問題が解決されています。

### Reverse Index

ZanzibarでもSpiceDBでも**Reverse Index Expand API**を実装しており、これは`従業員がアクセスできるリソースはどれですか？`といった認可リクエストに答えるためのAPIです。しかし、このAPIはツリー構造のデータで応答されるためアプリケーションで扱いづらいといった課題がありました。

SpiceDBではこのような問い合わせをするときに**LookupResources**や**LookupSubjects**というAPIを用いることができ、これはアプリケーション側で使用しやすいような平坦化されたデータを返す。

### Datastore

ZanzibarではデータストアとしてSpannerのみを使用しますが、SpiceDBではSpanner以外にも多様な種類のデータストアをサポートしています。

### Consistency(一貫性)

前述したようにZanzibarでは一貫性を保つために`Zookies`という仕組みを採用していますが、SpiceDBでは`ZedTokens`という仕組みが使われます。

SpiceDBではAPIリクエスト時に一貫性の振る舞いを指定することができるようになっています。

### ユーザー定義

GoogleではユーザーをGAIA(Google Accounts and ID Administration)と呼ばれるシステムで管理しており、そのGAIA IDと呼ばれる識別子でユーザーを管理しています。

Google以外のサービスではそれほど厳密にユーザー管理されていないことがほとんどで、ユーザーは他のオブジェクトと同じように宣言される。以下はユーザーおよびそのユーザーに紐づくAPIキーの両方でアクセス制御をする例です。

```
definition ApiKey {}
definition User {
  relation keys: ApiKey
}

definition Post {
  relation viewer: User
  ...
  permission view = viewer + viewer->keys
}
```

他にも細かい部分で違いはありますが上記のような違いがSpiceDBとZanzibarの間にはあるのがわかりますが、この違いはやはりGoogleが社内で使いやすいように実装された認可システムをより一般的なシステムとしたものがSpiceDBであると筆者は思います。

:::message
余談ですがGoogleから一般向けに公開され浸透した技術は多くあり、KubernetesやgRPCなんかはまさにそのような技術でしょう。gRPCやProtocol BuffersはGoogle社内のいろいろなところで利用されており、gRPC本体の実装はGoogle特有の社内事情が反映された実装となっている部分も多いそうです。

それによる課題も多くあり、Google社内の事情を取り除いたConnectという通信プロトコルがありますが、Googleが社内で使っていて公開された技術をもっと一般的な企業が使いやすいようにするといった流れがあるなぁと本章で説明したZanzibarとSpiceDBの関係から思ったりしました。

以下は従来のgRPCの開発体験の課題とConnectが何を改善したかが記載されているConnectの記事ですがこちらも面白い内容なので興味がある方は見てみてください。

https://buf.build/blog/connect-a-better-grpc
:::

## まとめ

- SpiceDBはGoogleのZanzibarを基に設計され、一般的に使いやすい認可システムとして開発された。
- ZanzibarはGoogleの大規模サービス向けに開発された分散認可システムで、高速性と一貫性を重視している。
- SpiceDBはZanzibarと同様の特徴を多く持つが、Zanzibarをより一般的な企業でも使いやすくするための機能や特徴が追加されている
